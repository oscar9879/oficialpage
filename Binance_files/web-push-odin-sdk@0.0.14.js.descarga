/*! For license information please see web-push-odin-sdk@0.0.14.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("httpSDK")):"function"==typeof define&&define.amd?define(["httpSDK"],t):"object"==typeof exports?exports.WebPushOdinSDK=t(require("httpSDK")):e.WebPushOdinSDK=t(e.httpSDK)}(this,(e=>(()=>{var t={47:function(e,t,s){var r;!function(n,i){"use strict";var o="function",a="undefined",c="object",h="string",u="model",l="name",d="type",f="vendor",p="version",m="architecture",g="console",b="mobile",w="tablet",_="smarttv",y="wearable",v="embedded",S={extend:function(e,t){var s={};for(var r in e)t[r]&&t[r].length%2==0?s[r]=t[r].concat(e[r]):s[r]=e[r];return s},has:function(e,t){return typeof e===h&&-1!==t.toLowerCase().indexOf(e.toLowerCase())},lowerize:function(e){return e.toLowerCase()},major:function(e){return typeof e===h?e.replace(/[^\d\.]/g,"").split(".")[0]:i},trim:function(e,t){return e=e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),typeof t===a?e:e.substring(0,255)}},E={rgx:function(e,t){for(var s,r,n,a,h,u,l=0;l<t.length&&!h;){var d=t[l],f=t[l+1];for(s=r=0;s<d.length&&!h;)if(h=d[s++].exec(e))for(n=0;n<f.length;n++)u=h[++r],typeof(a=f[n])===c&&a.length>0?2==a.length?typeof a[1]==o?this[a[0]]=a[1].call(this,u):this[a[0]]=a[1]:3==a.length?typeof a[1]!==o||a[1].exec&&a[1].test?this[a[0]]=u?u.replace(a[1],a[2]):i:this[a[0]]=u?a[1].call(this,u,a[2]):i:4==a.length&&(this[a[0]]=u?a[3].call(this,u.replace(a[1],a[2])):i):this[a]=u||i;l+=2}},str:function(e,t){for(var s in t)if(typeof t[s]===c&&t[s].length>0){for(var r=0;r<t[s].length;r++)if(S.has(t[s][r],e))return"?"===s?i:s}else if(S.has(t[s],e))return"?"===s?i:s;return e}},k={browser:{oldSafari:{version:{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}},oldEdge:{version:{.1:"12.",21:"13.",31:"14.",39:"15.",41:"16.",42:"17.",44:"18."}}},os:{windows:{version:{ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"}}}},x={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[l,"Edge"]],[/(opera\smini)\/([\w\.-]+)/i,/(opera\s[mobiletab]{3,6})\b.+version\/([\w\.-]+)/i,/(opera)(?:.+version\/|[\/\s]+)([\w\.]+)/i],[l,p],[/opios[\/\s]+([\w\.]+)/i],[p,[l,"Opera Mini"]],[/\sopr\/([\w\.]+)/i],[p,[l,"Opera"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/\s]?([\w\.]*)/i,/(avant\s|iemobile|slim)(?:browser)?[\/\s]?([\w\.]*)/i,/(ba?idubrowser)[\/\s]?([\w\.]+)/i,/(?:ms|\()(ie)\s([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon)\/([\w\.-]+)/i,/(rekonq|puffin|brave|whale|qqbrowserlite|qq)\/([\w\.]+)/i,/(weibo)__([\d\.]+)/i],[l,p],[/(?:[\s\/]uc?\s?browser|(?:juc.+)ucweb)[\/\s]?([\w\.]+)/i],[p,[l,"UCBrowser"]],[/(?:windowswechat)?\sqbcore\/([\w\.]+)\b.*(?:windowswechat)?/i],[p,[l,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[l,"Konqueror"]],[/trident.+rv[:\s]([\w\.]{1,9})\b.+like\sgecko/i],[p,[l,"IE"]],[/yabrowser\/([\w\.]+)/i],[p,[l,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure Browser"],p],[/focus\/([\w\.]+)/i],[p,[l,"Firefox Focus"]],[/opt\/([\w\.]+)/i],[p,[l,"Opera Touch"]],[/coc_coc_browser\/([\w\.]+)/i],[p,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[l,"Opera Coast"]],[/xiaomi\/miuibrowser\/([\w\.]+)/i],[p,[l,"MIUI Browser"]],[/fxios\/([\w\.-]+)/i],[p,[l,"Firefox"]],[/(qihu|qhbrowser|qihoobrowser|360browser)/i],[[l,"360 Browser"]],[/(oculus|samsung|sailfish)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1 Browser"],p],[/(comodo_dragon)\/([\w\.]+)/i],[[l,/_/g," "],p],[/\s(electron)\/([\w\.]+)\ssafari/i,/(tesla)(?:\sqtcarbrowser|\/(20[12]\d\.[\w\.-]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/\s]?([\w\.]+)/i],[l,p],[/(MetaSr)[\/\s]?([\w\.]+)/i,/(LBBROWSER)/i],[l],[/;fbav\/([\w\.]+);/i],[p,[l,"Facebook"]],[/FBAN\/FBIOS|FB_IAB\/FB4A/i],[[l,"Facebook"]],[/safari\s(line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/\s]([\w\.-]+)/i],[l,p],[/\bgsa\/([\w\.]+)\s.*safari\//i],[p,[l,"GSA"]],[/headlesschrome(?:\/([\w\.]+)|\s)/i],[p,[l,"Chrome Headless"]],[/\swv\).+(chrome)\/([\w\.]+)/i],[[l,"Chrome WebView"],p],[/droid.+\sversion\/([\w\.]+)\b.+(?:mobile\ssafari|safari)/i],[p,[l,"Android Browser"]],[/(chrome|omniweb|arora|[tizenoka]{5}\s?browser)\/v?([\w\.]+)/i],[l,p],[/version\/([\w\.]+)\s.*mobile\/\w+\s(safari)/i],[p,[l,"Mobile Safari"]],[/version\/([\w\.]+)\s.*(mobile\s?safari|safari)/i],[p,l],[/webkit.+?(mobile\s?safari|safari)(\/[\w\.]+)/i],[l,[p,E.str,k.browser.oldSafari.version]],[/(webkit|khtml)\/([\w\.]+)/i],[l,p],[/(navigator|netscape)\/([\w\.-]+)/i],[[l,"Netscape"],p],[/ile\svr;\srv:([\w\.]+)\).+firefox/i],[p,[l,"Firefox Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo\sbrowser|minimo|conkeror)[\/\s]?([\w\.\+]+)/i,/(firefox|seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([\w\.-]+)$/i,/(firefox)\/([\w\.]+)\s[\w\s\-]+\/[\w\.]+$/i,/(mozilla)\/([\w\.]+)\s.+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir)[\/\s]?([\w\.]+)/i,/(links)\s\(([\w\.]+)/i,/(gobrowser)\/?([\w\.]*)/i,/(ice\s?browser)\/v?([\w\._]+)/i,/(mosaic)[\/\s]([\w\.]+)/i],[l,p]],cpu:[[/(?:(amd|x(?:(?:86|64)[_-])?|wow|win)64)[;\)]/i],[[m,"amd64"]],[/(ia32(?=;))/i],[[m,S.lowerize]],[/((?:i[346]|x)86)[;\)]/i],[[m,"ia32"]],[/\b(aarch64|armv?8e?l?)\b/i],[[m,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[m,"armhf"]],[/windows\s(ce|mobile);\sppc;/i],[[m,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?:\smac|;|\))/i],[[m,/ower/,"",S.lowerize]],[/(sun4\w)[;\)]/i],[[m,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?:64|(?=v(?:[1-7]|[5-7]1)l?|;|eabi))|(?=atmel\s)avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[m,S.lowerize]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[pt]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus\s10)/i],[u,[f,"Samsung"],[d,w]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy\snexus)/i,/\ssamsung[\s-]([\w-]+)/i,/sec-(sgh\w+)/i],[u,[f,"Samsung"],[d,b]],[/\((ip(?:hone|od)[\s\w]*);/i],[u,[f,"Apple"],[d,b]],[/\((ipad);[\w\s\),;-]+apple/i,/applecoremedia\/[\w\.]+\s\((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[u,[f,"Apple"],[d,w]],[/\b((?:agr|ags[23]|bah2?|sht?)-a?[lw]\d{2})/i],[u,[f,"Huawei"],[d,w]],[/d\/huawei([\w\s-]+)[;\)]/i,/\b(nexus\s6p|vog-[at]?l\d\d|ane-[at]?l[x\d]\d|eml-a?l\d\da?|lya-[at]?l\d[\dc]|clt-a?l\d\di?|ele-l\d\d)/i,/\b(\w{2,4}-[atu][ln][01259][019])[;\)\s]/i],[u,[f,"Huawei"],[d,b]],[/\b(poco[\s\w]+)(?:\sbuild|\))/i,/\b;\s(\w+)\sbuild\/hm\1/i,/\b(hm[\s\-_]?note?[\s_]?(?:\d\w)?)\sbuild/i,/\b(redmi[\s\-_]?(?:note|k)?[\w\s_]+)(?:\sbuild|\))/i,/\b(mi[\s\-_]?(?:a\d|one|one[\s_]plus|note lte)?[\s_]?(?:\d?\w?)[\s_]?(?:plus)?)\sbuild/i],[[u,/_/g," "],[f,"Xiaomi"],[d,b]],[/\b(mi[\s\-_]?(?:pad)(?:[\w\s_]+))(?:\sbuild|\))/i],[[u,/_/g," "],[f,"Xiaomi"],[d,w]],[/;\s(\w+)\sbuild.+\soppo/i,/\s(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007)\b/i],[u,[f,"OPPO"],[d,b]],[/\svivo\s(\w+)(?:\sbuild|\))/i,/\s(v[12]\d{3}\w?[at])(?:\sbuild|;)/i],[u,[f,"Vivo"],[d,b]],[/\s(rmx[12]\d{3})(?:\sbuild|;)/i],[u,[f,"Realme"],[d,b]],[/\s(milestone|droid(?:[2-4x]|\s(?:bionic|x2|pro|razr))?:?(\s4g)?)\b[\w\s]+build\//i,/\smot(?:orola)?[\s-](\w*)/i,/((?:moto[\s\w\(\)]+|xt\d{3,4}|nexus\s6)(?=\sbuild|\)))/i],[u,[f,"Motorola"],[d,b]],[/\s(mz60\d|xoom[\s2]{0,2})\sbuild\//i],[u,[f,"Motorola"],[d,w]],[/((?=lg)?[vl]k\-?\d{3})\sbuild|\s3\.[\s\w;-]{10}lg?-([06cv9]{3,4})/i],[u,[f,"LG"],[d,w]],[/(lm-?f100[nv]?|nexus\s[45])/i,/lg[e;\s\/-]+((?!browser|netcast)\w+)/i,/\blg(\-?[\d\w]+)\sbuild/i],[u,[f,"LG"],[d,b]],[/(ideatab[\w\-\s]+)/i,/lenovo\s?(s(?:5000|6000)(?:[\w-]+)|tab(?:[\s\w]+)|yt[\d\w-]{6}|tb[\d\w-]{6})/i],[u,[f,"Lenovo"],[d,w]],[/(?:maemo|nokia).*(n900|lumia\s\d+)/i,/nokia[\s_-]?([\w\.-]*)/i],[[u,/_/g," "],[f,"Nokia"],[d,b]],[/droid.+;\s(pixel\sc)[\s)]/i],[u,[f,"Google"],[d,w]],[/droid.+;\s(pixel[\s\daxl]{0,6})(?:\sbuild|\))/i],[u,[f,"Google"],[d,b]],[/droid.+\s([c-g]\d{4}|so[-l]\w+|xq-a\w[4-7][12])(?=\sbuild\/|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[u,[f,"Sony"],[d,b]],[/sony\stablet\s[ps]\sbuild\//i,/(?:sony)?sgp\w+(?:\sbuild\/|\))/i],[[u,"Xperia Tablet"],[f,"Sony"],[d,w]],[/\s(kb2005|in20[12]5|be20[12][59])\b/i,/\ba000(1)\sbuild/i,/\boneplus\s(a\d{4})[\s)]/i],[u,[f,"OnePlus"],[d,b]],[/(alexa)webm/i,/(kf[a-z]{2}wi)(\sbuild\/|\))/i,/(kf[a-z]+)(\sbuild\/|\)).+silk\//i],[u,[f,"Amazon"],[d,w]],[/(sd|kf)[0349hijorstuw]+(\sbuild\/|\)).+silk\//i],[[u,"Fire Phone"],[f,"Amazon"],[d,b]],[/\((playbook);[\w\s\),;-]+(rim)/i],[u,f,[d,w]],[/((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10;\s(\w+)/i],[u,[f,"BlackBerry"],[d,b]],[/(?:\b|asus_)(transfo[prime\s]{4,10}\s\w+|eeepc|slider\s\w+|nexus\s7|padfone|p00[cj])/i],[u,[f,"ASUS"],[d,w]],[/\s(z[es]6[027][01][km][ls]|zenfone\s\d\w?)\b/i],[u,[f,"ASUS"],[d,b]],[/(nexus\s9)/i],[u,[f,"HTC"],[d,w]],[/(htc)[;_\s-]{1,2}([\w\s]+(?=\)|\sbuild)|\w+)/i,/(zte)-(\w*)/i,/(alcatel|geeksphone|nexian|panasonic|(?=;\s)sony)[_\s-]?([\w-]*)/i],[f,[u,/_/g," "],[d,b]],[/droid[x\d\.\s;]+\s([ab][1-7]\-?[0178a]\d\d?)/i],[u,[f,"Acer"],[d,w]],[/droid.+;\s(m[1-5]\snote)\sbuild/i,/\bmz-([\w-]{2,})/i],[u,[f,"Meizu"],[d,b]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[\s_-]?([\w-]*)/i,/(hp)\s([\w\s]+\w)/i,/(asus)-?(\w+)/i,/(microsoft);\s(lumia[\s\w]+)/i,/(lenovo)[_\s-]?([\w-]+)/i,/linux;.+(jolla);/i,/droid.+;\s(oppo)\s?([\w\s]+)\sbuild/i],[f,u,[d,b]],[/(archos)\s(gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/\s(nook)[\w\s]+build\/(\w+)/i,/(dell)\s(strea[kpr\s\d]*[\dko])/i,/[;\/]\s?(le[\s\-]+pan)[\s\-]+(\w{1,9})\sbuild/i,/[;\/]\s?(trinity)[\-\s]*(t\d{3})\sbuild/i,/\b(gigaset)[\s\-]+(q\w{1,9})\sbuild/i,/\b(vodafone)\s([\w\s]+)(?:\)|\sbuild)/i],[f,u,[d,w]],[/\s(surface\sduo)\s/i],[u,[f,"Microsoft"],[d,w]],[/droid\s[\d\.]+;\s(fp\du?)\sbuild/i],[u,[f,"Fairphone"],[d,b]],[/\s(u304aa)\sbuild/i],[u,[f,"AT&T"],[d,b]],[/sie-(\w*)/i],[u,[f,"Siemens"],[d,b]],[/[;\/]\s?(rct\w+)\sbuild/i],[u,[f,"RCA"],[d,w]],[/[;\/\s](venue[\d\s]{2,7})\sbuild/i],[u,[f,"Dell"],[d,w]],[/[;\/]\s?(q(?:mv|ta)\w+)\sbuild/i],[u,[f,"Verizon"],[d,w]],[/[;\/]\s(?:barnes[&\s]+noble\s|bn[rt])([\w\s\+]*)\sbuild/i],[u,[f,"Barnes & Noble"],[d,w]],[/[;\/]\s(tm\d{3}\w+)\sbuild/i],[u,[f,"NuVision"],[d,w]],[/;\s(k88)\sbuild/i],[u,[f,"ZTE"],[d,w]],[/;\s(nx\d{3}j)\sbuild/i],[u,[f,"ZTE"],[d,b]],[/[;\/]\s?(gen\d{3})\sbuild.*49h/i],[u,[f,"Swiss"],[d,b]],[/[;\/]\s?(zur\d{3})\sbuild/i],[u,[f,"Swiss"],[d,w]],[/[;\/]\s?((zeki)?tb.*\b)\sbuild/i],[u,[f,"Zeki"],[d,w]],[/[;\/]\s([yr]\d{2})\sbuild/i,/[;\/]\s(dragon[\-\s]+touch\s|dt)(\w{5})\sbuild/i],[[f,"Dragon Touch"],u,[d,w]],[/[;\/]\s?(ns-?\w{0,9})\sbuild/i],[u,[f,"Insignia"],[d,w]],[/[;\/]\s?((nxa|Next)-?\w{0,9})\sbuild/i],[u,[f,"NextBook"],[d,w]],[/[;\/]\s?(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05]))\sbuild/i],[[f,"Voice"],u,[d,b]],[/[;\/]\s?(lvtel\-)?(v1[12])\sbuild/i],[[f,"LvTel"],u,[d,b]],[/;\s(ph-1)\s/i],[u,[f,"Essential"],[d,b]],[/[;\/]\s?(v(100md|700na|7011|917g).*\b)\sbuild/i],[u,[f,"Envizen"],[d,w]],[/[;\/]\s?(trio[\s\w\-\.]+)\sbuild/i],[u,[f,"MachSpeed"],[d,w]],[/[;\/]\s?tu_(1491)\sbuild/i],[u,[f,"Rotor"],[d,w]],[/(shield[\w\s]+)\sbuild/i],[u,[f,"Nvidia"],[d,w]],[/(sprint)\s(\w+)/i],[f,u,[d,b]],[/(kin\.[onetw]{3})/i],[[u,/\./g," "],[f,"Microsoft"],[d,b]],[/droid\s[\d\.]+;\s(cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[u,[f,"Zebra"],[d,w]],[/droid\s[\d\.]+;\s(ec30|ps20|tc[2-8]\d[kx])\)/i],[u,[f,"Zebra"],[d,b]],[/\s(ouya)\s/i,/(nintendo)\s([wids3utch]+)/i],[f,u,[d,g]],[/droid.+;\s(shield)\sbuild/i],[u,[f,"Nvidia"],[d,g]],[/(playstation\s[345portablevi]+)/i],[u,[f,"Sony"],[d,g]],[/[\s\(;](xbox(?:\sone)?(?!;\sxbox))[\s\);]/i],[u,[f,"Microsoft"],[d,g]],[/smart-tv.+(samsung)/i],[f,[d,_]],[/hbbtv.+maple;(\d+)/i],[[u,/^/,"SmartTV"],[f,"Samsung"],[d,_]],[/(?:linux;\snetcast.+smarttv|lg\snetcast\.tv-201\d)/i],[[f,"LG"],[d,_]],[/(apple)\s?tv/i],[f,[u,"Apple TV"],[d,_]],[/crkey/i],[[u,"Chromecast"],[f,"Google"],[d,_]],[/droid.+aft([\w])(\sbuild\/|\))/i],[u,[f,"Amazon"],[d,_]],[/\(dtv[\);].+(aquos)/i],[u,[f,"Sharp"],[d,_]],[/hbbtv\/\d+\.\d+\.\d+\s+\([\w\s]*;\s*(\w[^;]*);([^;]*)/i],[[f,S.trim],[u,S.trim],[d,_]],[/[\s\/\(](android\s|smart[-\s]?|opera\s)tv[;\)\s]/i],[[d,_]],[/((pebble))app\/[\d\.]+\s/i],[f,u,[d,y]],[/droid.+;\s(glass)\s\d/i],[u,[f,"Google"],[d,y]],[/droid\s[\d\.]+;\s(wt63?0{2,3})\)/i],[u,[f,"Zebra"],[d,y]],[/(tesla)(?:\sqtcarbrowser|\/20[12]\d\.[\w\.-]+)/i],[f,[d,v]],[/droid .+?; ([^;]+?)(?: build|\) applewebkit).+? mobile safari/i],[u,[d,b]],[/droid .+?;\s([^;]+?)(?: build|\) applewebkit).+?(?! mobile) safari/i],[u,[d,w]],[/\s(tablet|tab)[;\/]/i,/\s(mobile)(?:[;\/]|\ssafari)/i],[[d,S.lowerize]],[/(android[\w\.\s\-]{0,9});.+build/i],[u,[f,"Generic"]],[/(phone)/i],[[d,b]]],engine:[[/windows.+\sedge\/([\w\.]+)/i],[p,[l,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/\s]\(?([\w\.]+)/i,/(icab)[\/\s]([23]\.[\d\.]+)/i],[l,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,l]],os:[[/microsoft\s(windows)\s(vista|xp)/i],[l,p],[/(windows)\snt\s6\.2;\s(arm)/i,/(windows\sphone(?:\sos)*)[\s\/]?([\d\.\s\w]*)/i,/(windows\smobile|windows)[\s\/]?([ntce\d\.\s]+\w)(?!.+xbox)/i],[l,[p,E.str,k.os.windows.version]],[/(win(?=3|9|n)|win\s9x\s)([nt\d\.]+)/i],[[l,"Windows"],[p,E.str,k.os.windows.version]],[/ip[honead]{2,4}\b(?:.*os\s([\w]+)\slike\smac|;\sopera)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[l,"iOS"]],[/(mac\sos\sx)\s?([\w\s\.]*)/i,/(macintosh|mac(?=_powerpc)\s)(?!.+haiku)/i],[[l,"Mac OS"],[p,/_/g,"."]],[/(android|webos|palm\sos|qnx|bada|rim\stablet\sos|meego|sailfish|contiki)[\/\s-]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/\s]([\w\.]+)/i,/\((series40);/i],[l,p],[/\(bb(10);/i],[p,[l,"BlackBerry"]],[/(?:symbian\s?os|symbos|s60(?=;)|series60)[\/\s-]?([\w\.]*)/i],[p,[l,"Symbian"]],[/mozilla.+\(mobile;.+gecko.+firefox/i],[[l,"Firefox OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[l,"webOS"]],[/crkey\/([\d\.]+)/i],[p,[l,"Chromecast"]],[/(cros)\s[\w]+\s([\w\.]+\w)/i],[[l,"Chromium OS"],p],[/(nintendo|playstation)\s([wids345portablevuch]+)/i,/(xbox);\s+xbox\s([^\);]+)/i,/(mint)[\/\s\(\)]?(\w*)/i,/(mageia|vectorlinux)[;\s]/i,/(joli|[kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?=\slinux)|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk|linpus|raspbian)(?:\sgnu\/linux)?(?:\slinux)?[\/\s-]?(?!chrom|package)([\w\.-]*)/i,/(hurd|linux)\s?([\w\.]*)/i,/(gnu)\s?([\w\.]*)/i,/\s([frentopc-]{0,4}bsd|dragonfly)\s?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku)\s(\w+)/i],[l,p],[/(sunos)\s?([\w\.\d]*)/i],[[l,"Solaris"],p],[/((?:open)?solaris)[\/\s-]?([\w\.]*)/i,/(aix)\s((\d)(?=\.|\)|\s)[\w\.])*/i,/(plan\s9|minix|beos|os\/2|amigaos|morphos|risc\sos|openvms|fuchsia)/i,/(unix)\s?([\w\.]*)/i],[l,p]]},C=function(e,t){if("object"==typeof e&&(t=e,e=i),!(this instanceof C))return new C(e,t).getResult();var s=e||(void 0!==n&&n.navigator&&n.navigator.userAgent?n.navigator.userAgent:""),r=t?S.extend(x,t):x;return this.getBrowser=function(){var e={name:i,version:i};return E.rgx.call(e,s,r.browser),e.major=S.major(e.version),e},this.getCPU=function(){var e={architecture:i};return E.rgx.call(e,s,r.cpu),e},this.getDevice=function(){var e={vendor:i,model:i,type:i};return E.rgx.call(e,s,r.device),e},this.getEngine=function(){var e={name:i,version:i};return E.rgx.call(e,s,r.engine),e},this.getOS=function(){var e={name:i,version:i};return E.rgx.call(e,s,r.os),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return s},this.setUA=function(e){return s=typeof e===h&&e.length>255?S.trim(e,255):e,this},this.setUA(s),this};C.VERSION="0.7.28",C.BROWSER={NAME:l,MAJOR:"major",VERSION:p},C.CPU={ARCHITECTURE:m},C.DEVICE={MODEL:u,VENDOR:f,TYPE:d,CONSOLE:g,MOBILE:b,SMARTTV:_,TABLET:w,WEARABLE:y,EMBEDDED:v},C.ENGINE={NAME:l,VERSION:p},C.OS={NAME:l,VERSION:p},typeof t!==a?(e.exports&&(t=e.exports=C),t.UAParser=C):(r=function(){return C}.call(t,s,t,e))===i||(e.exports=r);var P=void 0!==n&&(n.jQuery||n.Zepto);if(P&&!P.ua){var I=new C;P.ua=I.getResult(),P.ua.get=function(){return I.getUA()},P.ua.set=function(e){I.setUA(e);var t=I.getResult();for(var s in t)P.ua[s]=t[s]}}}("object"==typeof window?window:this)},396:t=>{"use strict";t.exports=e}},s={};function r(e){var n=s[e];if(void 0!==n)return n.exports;var i=s[e]={exports:{}};return t[e].call(i.exports,i,i.exports,r),i.exports}r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{"use strict";r.r(n),r.d(n,{WebPushOdinSDK:()=>_c,initWebPushOdin:()=>yc});var e=function(e){function t(){this.message=e}return t.prototype=new Error,t.prototype.name="InvalidCharacterError",t.prototype.code=5,t},t=(e("The string to be encoded contains characters out of range"),e("The string to be decoded is not correctly encoded"),!("undefined"==typeof window||!window.document));Promise.resolve(!1);var s=Promise.resolve(!0),i=Promise.resolve();function o(e,t){return e||(e=0),new Promise((function(s){return setTimeout((function(){return s(t)}),e)}))}function a(){return Math.random().toString(36).substring(2)}var c=0;function h(){var e=1e3*Date.now();return e<=c&&(e=c+1),c=e,e}var u={create:function(e){var t={time:h(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(e){t.messagesCallback&&t.messagesCallback(e.data)},t},close:function(e){e.bc.close(),e.subFns=[]},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){try{return e.bc.postMessage(t,!1),i}catch(e){return Promise.reject(e)}},canBeUsed:function(){if("undefined"!=typeof globalThis&&globalThis.Deno&&globalThis.Deno.args)return!0;if("undefined"==typeof window&&"undefined"==typeof self||"function"!=typeof BroadcastChannel)return!1;if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0},type:"native",averageResponseTime:function(){return 150},microSeconds:h};class l{ttl;map=new Map;_to=!1;constructor(e){this.ttl=e}has(e){return this.map.has(e)}add(e){this.map.set(e,d()),this._to||(this._to=!0,setTimeout((()=>{this._to=!1,function(e){const t=d()-e.ttl,s=e.map[Symbol.iterator]();for(;;){const r=s.next().value;if(!r)return;const n=r[0];if(!(r[1]<t))return;e.map.delete(n)}}(this)}),0))}clear(){this.map.clear()}}function d(){return Date.now()}function f(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return void 0===t.webWorkerSupport&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=45e3),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&"function"==typeof e.idb.onclose&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=6e4),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=12e4),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),void 0===t.node.useFastPath&&(t.node.useFastPath=!0),t}var p="messages",m={durability:"relaxed"};function g(){if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof window){if(void 0!==window.mozIndexedDB)return window.mozIndexedDB;if(void 0!==window.webkitIndexedDB)return window.webkitIndexedDB;if(void 0!==window.msIndexedDB)return window.msIndexedDB}return!1}function b(e){e.commit&&e.commit()}function w(e){e.closed||_(e).then((function(){return o(e.options.idb.fallbackInterval)})).then((function(){return w(e)}))}function _(e){return e.closed?i:e.messagesCallback?function(e,t){var s=e.transaction(p,"readonly",m),r=s.objectStore(p),n=[],i=IDBKeyRange.bound(t+1,1/0);if(r.getAll){var o=r.getAll(i);return new Promise((function(e,t){o.onerror=function(e){return t(e)},o.onsuccess=function(t){e(t.target.result)}}))}return new Promise((function(e,o){var a=function(){try{return i=IDBKeyRange.bound(t+1,1/0),r.openCursor(i)}catch(e){return r.openCursor()}}();a.onerror=function(e){return o(e)},a.onsuccess=function(r){var i=r.target.result;i?i.value.id<t+1?i.continue(t+1):(n.push(i.value),i.continue()):(b(s),e(n))}}))}(e.db,e.lastCursorId).then((function(t){var s=t.filter((function(e){return!!e})).map((function(t){return t.id>e.lastCursorId&&(e.lastCursorId=t.id),t})).filter((function(t){return function(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}(t,e)})).sort((function(e,t){return e.time-t.time}));return s.forEach((function(t){e.messagesCallback&&(e.eMIs.add(t.id),e.messagesCallback(t.data))})),i})):i}var y={create:function(e,t){return t=f(t),function(e){var t="pubkey.broadcast-channel-0-"+e,s=g().open(t);return s.onupgradeneeded=function(e){e.target.result.createObjectStore(p,{keyPath:"id",autoIncrement:!0})},new Promise((function(e,t){s.onerror=function(e){return t(e)},s.onsuccess=function(){e(s.result)}}))}(e).then((function(s){var r={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:a(),eMIs:new l(2*t.idb.ttl),writeBlockPromise:i,messagesCallback:null,readQueuePromises:[],db:s};return s.onclose=function(){r.closed=!0,t.idb.onclose&&t.idb.onclose()},w(r),r}))},close:function(e){e.closed=!0,e.db.close()},onMessage:function(e,t,s){e.messagesCallbackTime=s,e.messagesCallback=t,_(e)},postMessage:function(e,t){return e.writeBlockPromise=e.writeBlockPromise.then((function(){return function(e,t,s){var r={uuid:t,time:Date.now(),data:s},n=e.transaction([p],"readwrite",m);return new Promise((function(e,t){n.oncomplete=function(){return e()},n.onerror=function(e){return t(e)},n.objectStore(p).add(r),b(n)}))}(e.db,e.uuid,t)})).then((function(){0===(0,10,Math.floor(11*Math.random()+0))&&function(e){return(t=e.db,s=e.options.idb.ttl,r=Date.now()-s,n=t.transaction(p,"readonly",m),i=n.objectStore(p),o=[],new Promise((function(e){i.openCursor().onsuccess=function(t){var s=t.target.result;if(s){var i=s.value;i.time<r?(o.push(i),s.continue()):(b(n),e(o))}else e(o)}}))).then((function(t){return function(e,t){if(e.closed)return Promise.resolve([]);var s=e.db.transaction(p,"readwrite",m).objectStore(p);return Promise.all(t.map((function(e){var t=s.delete(e);return new Promise((function(e){t.onsuccess=function(){return e()}}))})))}(e,t.map((function(e){return e.id})))}));var t,s,r,n,i,o}(e)})),e.writeBlockPromise},canBeUsed:function(){return!!g()},type:"idb",averageResponseTime:function(e){return 2*e.idb.fallbackInterval},microSeconds:h};function v(){var e;if("undefined"==typeof window)return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch(e){}return e}function S(e){return"pubkey.broadcastChannel-"+e}function E(){var e=v();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch(e){return!1}return!0}var k={create:function(e,t){if(t=f(t),!E())throw new Error("BroadcastChannel: localstorage cannot be used");var s=a(),r=new l(t.localstorage.removeTimeout),n={channelName:e,uuid:s,eMIs:r};return n.listener=function(e,t){var i=S(e),o=function(e){var t;e.key===i&&(t=JSON.parse(e.newValue),n.messagesCallback&&t.uuid!==s&&t.token&&!r.has(t.token)&&(t.data.time&&t.data.time<n.messagesCallbackTime||(r.add(t.token),n.messagesCallback(t.data))))};return window.addEventListener("storage",o),o}(e),n},close:function(e){var t;t=e.listener,window.removeEventListener("storage",t)},onMessage:function(e,t,s){e.messagesCallbackTime=s,e.messagesCallback=t},postMessage:function(e,t){return new Promise((function(s){o().then((function(){var r=S(e.channelName),n={token:a(),time:Date.now(),data:t,uuid:e.uuid},i=JSON.stringify(n);v().setItem(r,i);var o=document.createEvent("Event");o.initEvent("storage",!0,!0),o.key=r,o.newValue=i,window.dispatchEvent(o),s()}))}))},canBeUsed:E,type:"localstorage",averageResponseTime:function(){var e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")?240:120},microSeconds:h},x=h,C=new Set,P={create:function(e){var t={time:x(),name:e,messagesCallback:null};return C.add(t),t},close:function(e){C.delete(e)},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){return new Promise((function(s){return setTimeout((function(){Array.from(C).forEach((function(s){s.name===e.name&&s!==e&&s.messagesCallback&&s.time<t.time&&s.messagesCallback(t)})),s()}),5)}))},canBeUsed:function(){return!0},type:"simulate",averageResponseTime:function(){return 5},microSeconds:x},I=[u,y,k],A=new Set,O=0,j=function(e,t){var s,r,n;this.id=O++,A.add(this),this.name=e,this.options=f(t),this.method=function(e){var t=[].concat(e.methods,I).filter(Boolean);if(e.type){if("simulate"===e.type)return P;var s=t.find((function(t){return t.type===e.type}));if(s)return s;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter((function(e){return"idb"!==e.type})));var r=t.find((function(e){return e.canBeUsed()}));if(r)return r;throw new Error("No usable method found in "+JSON.stringify(I.map((function(e){return e.type}))))}(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,(n=r=(s=this).method.create(s.name,s.options))&&"function"==typeof n.then?(s._prepP=r,r.then((function(e){s._state=e}))):s._state=r};function T(e,t,s){var r={time:e.method.microSeconds(),type:t,data:s};return(e._prepP?e._prepP:i).then((function(){var t=e.method.postMessage(e._state,r);return e._uMP.add(t),t.catch().then((function(){return e._uMP.delete(t)})),t}))}function N(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function M(e,t,s){e._addEL[t].push(s),function(e){if(!e._iL&&N(e)){var t=function(t){e._addEL[t.type].forEach((function(e){t.time>=e.time&&e.fn(t.data)}))},s=e.method.microSeconds();e._prepP?e._prepP.then((function(){e._iL=!0,e.method.onMessage(e._state,t,s)})):(e._iL=!0,e.method.onMessage(e._state,t,s))}}(e)}function L(e,t,s){e._addEL[t]=e._addEL[t].filter((function(e){return e!==s})),function(e){if(e._iL&&!N(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}(e)}j._pubkey=!0,j.prototype={postMessage:function(e){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(e));return T(this,"message",e)},postInternal:function(e){return T(this,"internal",e)},set onmessage(e){var t={time:this.method.microSeconds(),fn:e};L(this,"message",this._onML),e&&"function"==typeof e?(this._onML=t,M(this,"message",t)):this._onML=null},addEventListener:function(e,t){M(this,e,{time:this.method.microSeconds(),fn:t})},removeEventListener:function(e,t){L(this,e,this._addEL[e].find((function(e){return e.fn===t})))},close:function(){var e=this;if(!this.closed){A.delete(this),this.closed=!0;var t=this._prepP?this._prepP:i;return this._onML=null,this._addEL.message=[],t.then((function(){return Promise.all(Array.from(e._uMP))})).then((function(){return Promise.all(e._befC.map((function(e){return e()})))})).then((function(){return e.method.close(e._state)}))}},get type(){return this.method.type},get isClosed(){return this.closed}};var R="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)?function(e){process.on("exit",(function(){return e()})),process.on("beforeExit",(function(){return e().then((function(){return process.exit()}))})),process.on("SIGINT",(function(){return e().then((function(){return process.exit()}))})),process.on("uncaughtException",(function(t){return e().then((function(){console.trace(t),process.exit(101)}))}))}:function(e){if("function"==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if("function"!=typeof window.addEventListener)return;window.addEventListener("beforeunload",(function(){e()}),!0),window.addEventListener("unload",(function(){e()}),!0)}},D=new Set,B=!1;function $(){var e=[];return D.forEach((function(t){e.push(t()),D.delete(t)})),Promise.all(e)}function U(e,t){var s={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(s)}function F(e){e.isLeader=!0,e._hasLeader=!0;var t=function(e){if(B||(B=!0,R($)),"function"!=typeof e)throw new Error("Listener is no function");return D.add(e),{remove:function(){return D.delete(e)},run:function(){return D.delete(e),e()}}}((function(){return e.die()}));e._unl.push(t);var s=function(t){"leader"===t.context&&"apply"===t.action&&U(e,"tell"),"leader"!==t.context||"tell"!==t.action||e._dpLC||(e._dpLC=!0,e._dpL(),U(e,"tell"))};return e.broadcastChannel.addEventListener("internal",s),e._lstns.push(s),U(e,"tell")}var q=function(e,t){var s=this;this.broadcastChannel=e,e._befC.push((function(){return s.die()})),this._options=t,this.isLeader=!1,this.isDead=!1,this.token=a(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+e.method.type+"||"+e.name};q.prototype={hasLeader:function(){var e=this;return navigator.locks.query().then((function(t){var s=t.held?t.held.filter((function(t){return t.name===e.lN})):[];return!!(s&&s.length>0)}))},awaitLeadership:function(){var e=this;if(!this._wLMP){this._wKMC.c=new AbortController;var t=new Promise((function(t,s){e._wKMC.res=t,e._wKMC.rej=s}));this._wLMP=new Promise((function(s){navigator.locks.request(e.lN,{signal:e._wKMC.c.signal},(function(){return e._wKMC.c=void 0,F(e),s(),t})).catch((function(){}))}))}return this._wLMP},set onduplicate(e){},die:function(){var e=this;return this._lstns.forEach((function(t){return e.broadcastChannel.removeEventListener("internal",t)})),this._lstns=[],this._unl.forEach((function(e){return e.remove()})),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),U(this,"death")}};var H=function(e,t){var s=this;this.broadcastChannel=e,this._options=t,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=a(),this._aplQ=i,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var r=function(e){"leader"===e.context&&("death"===e.action&&(s._hasLeader=!1),"tell"===e.action&&(s._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",r),this._lstns.push(r)};H.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(e){var t=this;return this.isLeader?o(0,!0):this.isDead?o(0,!1):this._aplQC>1?this._aplQ:(this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then((function(){return function(){if(t.isLeader)return s;var r,n=!1,i=new Promise((function(e){r=function(){n=!0,e()}})),a=function(e){"leader"===e.context&&e.token!=t.token&&("apply"===e.action&&e.token>t.token&&r(),"tell"===e.action&&(r(),t._hasLeader=!0))};t.broadcastChannel.addEventListener("internal",a);var c=e?4*t._options.responseTime:t._options.responseTime;return U(t,"apply").then((function(){return Promise.race([o(c),i.then((function(){return Promise.reject(new Error)}))])})).then((function(){return U(t,"apply")})).then((function(){return Promise.race([o(c),i.then((function(){return Promise.reject(new Error)}))])})).catch((function(){})).then((function(){return t.broadcastChannel.removeEventListener("internal",a),!n&&F(t).then((function(){return!0}))}))}()})).then((function(){t._aplQC=t._aplQC-1})),this._aplQ.then((function(){return t.isLeader})))},awaitLeadership:function(){return this._aLP||(this._aLP=(e=this).isLeader?i:new Promise((function(t){var s=!1;function r(){s||(s=!0,e.broadcastChannel.removeEventListener("internal",n),t(!0))}e.applyOnce().then((function(){e.isLeader&&r()})),function t(){return o(e._options.fallbackInterval).then((function(){if(!e.isDead&&!s)return e.isLeader?void r():e.applyOnce(!0).then((function(){e.isLeader?r():t()}))}))}();var n=function(t){"leader"===t.context&&"death"===t.action&&(e._hasLeader=!1,e.applyOnce().then((function(){e.isLeader&&r()})))};e.broadcastChannel.addEventListener("internal",n),e._lstns.push(n)}))),this._aLP;var e},set onduplicate(e){this._dpL=e},die:function(){var e=this;return this._lstns.forEach((function(t){return e.broadcastChannel.removeEventListener("internal",t)})),this._lstns=[],this._unl.forEach((function(e){return e.remove()})),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,U(this,"death")}};const K=new Uint8Array(0),z=new TextEncoder,G=new TextDecoder;function J(...e){const t=[];for(let s=0;s<e.length;s++)t.push(z.encode(e[s]));return 0===t.length?K:1===t.length?t[0]:function(...e){let t=0;for(let s=0;s<e.length;s++)t+=e[s].length;const s=new Uint8Array(t);let r=0;for(let t=0;t<e.length;t++)s.set(e[t],r),r+=e[t].length;return s}(...t)}function V(e){return e&&0!==e.length?G.decode(e):""}const W="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";const Y=new class{buf;seq;inc;inited;constructor(){this.buf=new Uint8Array(22),this.inited=!1}init(){this.inited=!0,this.setPre(),this.initSeqAndInc(),this.fillSeq()}initSeqAndInc(){this.seq=Math.floor(0xcfd41b9100000*Math.random()),this.inc=Math.floor(300*Math.random()+33)}setPre(){const e=new Uint8Array(12);var t;t=e,globalThis?.crypto?.getRandomValues?globalThis.crypto.getRandomValues(t):function(e){for(let t=0;t<e.length;t++)e[t]=Math.floor(255*Math.random())}(t);for(let t=0;t<12;t++){const s=e[t]%36;this.buf[t]=W.charCodeAt(s)}}fillSeq(){let e=this.seq;for(let t=21;t>=12;t--)this.buf[t]=W.charCodeAt(e%36),e=Math.floor(e/36)}next(){return this.inited||this.init(),this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),String.fromCharCode.apply(String,this.buf)}reset(){this.init()}};var Q,X,Z,ee;!function(e){e.Disconnect="disconnect",e.Reconnect="reconnect",e.Update="update",e.LDM="ldm",e.Error="error"}(Q||(Q={})),function(e){e.Reconnecting="reconnecting",e.PingTimer="pingTimer",e.StaleConnection="staleConnection",e.ClientInitiatedReconnect="client initiated reconnect"}(X||(X={})),(ee=Z||(Z={})).ApiError="BAD API",ee.BadAuthentication="BAD_AUTHENTICATION",ee.BadCreds="BAD_CREDS",ee.BadHeader="BAD_HEADER",ee.BadJson="BAD_JSON",ee.BadPayload="BAD_PAYLOAD",ee.BadSubject="BAD_SUBJECT",ee.Cancelled="CANCELLED",ee.ConnectionClosed="CONNECTION_CLOSED",ee.ConnectionDraining="CONNECTION_DRAINING",ee.ConnectionRefused="CONNECTION_REFUSED",ee.ConnectionTimeout="CONNECTION_TIMEOUT",ee.Disconnect="DISCONNECT",ee.InvalidOption="INVALID_OPTION",ee.InvalidPayload="INVALID_PAYLOAD",ee.MaxPayloadExceeded="MAX_PAYLOAD_EXCEEDED",ee.NoResponders="503",ee.NotFunction="NOT_FUNC",ee.RequestError="REQUEST_ERROR",ee.ServerOptionNotAvailable="SERVER_OPT_NA",ee.SubClosed="SUB_CLOSED",ee.SubDraining="SUB_DRAINING",ee.Timeout="TIMEOUT",ee.Tls="TLS",ee.Unknown="UNKNOWN_ERROR",ee.WssRequired="WSS_REQUIRED",ee.JetStreamInvalidAck="JESTREAM_INVALID_ACK",ee.JetStream404NoMessages="404",ee.JetStream408RequestTimeout="408",ee.JetStream409MaxAckPendingExceeded="409",ee.JetStream409="409",ee.JetStreamNotEnabled="503",ee.JetStreamIdleHeartBeat="IDLE_HEARTBEAT",ee.AuthorizationViolation="AUTHORIZATION_VIOLATION",ee.AuthenticationExpired="AUTHENTICATION_EXPIRED",ee.ProtocolError="NATS_PROTOCOL_ERR",ee.PermissionsViolation="PERMISSIONS_VIOLATION",ee.AuthenticationTimeout="AUTHENTICATION_TIMEOUT";class te{messages;constructor(){this.messages=new Map,this.messages.set(Z.InvalidPayload,"Invalid payload type - payloads can be 'binary', 'string', or 'json'"),this.messages.set(Z.BadJson,"Bad JSON"),this.messages.set(Z.WssRequired,"TLS is required, therefore a secure websocket connection is also required")}static getMessage(e){return se.getMessage(e)}getMessage(e){return this.messages.get(e)||e}}const se=new te;class re extends Error{name;message;code;permissionContext;chainedError;api_error;constructor(e,t,s){super(e),this.name="NatsError",this.message=e,this.code=t,this.chainedError=s}static errorForCode(e,t){const s=te.getMessage(e);return new re(s,e,t)}isAuthError(){return this.code===Z.AuthenticationExpired||this.code===Z.AuthorizationViolation}isAuthTimeout(){return this.code===Z.AuthenticationTimeout}isPermissionError(){return this.code===Z.PermissionsViolation}isProtocolError(){return this.code===Z.ProtocolError}isJetStreamError(){return void 0!==this.api_error}jsError(){return this.api_error?this.api_error:null}}var ne,ie,oe;!function(e){e[e.Exact=0]="Exact",e[e.CanonicalMIME=1]="CanonicalMIME",e[e.IgnoreCase=2]="IgnoreCase"}(ne||(ne={})),function(e){e.Timer="timer",e.Count="count",e.JitterTimer="jitterTimer",e.SentinelMsg="sentinelMsg"}(ie||(ie={})),function(e){e.STATS="io.nats.micro.v1.stats_response",e.INFO="io.nats.micro.v1.info_response",e.PING="io.nats.micro.v1.ping_response"}(oe||(oe={}));const ae="Nats-Service-Error",ce="Nats-Service-Error-Code";class he extends Error{code;constructor(e,t){super(t),this.code=e}static isServiceError(e){return null!==he.toServiceError(e)}static toServiceError(e){const t=e?.headers?.get(ce)||"";if(""!==t){const s=parseInt(t)||400,r=e?.headers?.get(ae)||"";return new he(s,r.length?r:t)}return null}}function ue(e=""){if("string"!=typeof(e=e||"_INBOX"))throw new Error("prefix must be a string");return e.split(".").forEach((t=>{if("*"===t||">"===t)throw new Error(`inbox prefixes cannot have wildcards '${e}'`)})),`${e}.${Y.next()}`}const le="127.0.0.1";var de;function fe(e,...t){for(let s=0;s<t.length;s++){const r=t[s];Object.keys(r).forEach((function(t){e[t]=r[t]}))}return e}function pe(e){return G.decode(e).replace(/\n/g,"␊").replace(/\r/g,"␍")}function me(e,t=!0){const s=t?re.errorForCode(Z.Timeout):null;let r,n;const i=new Promise(((t,i)=>{r={cancel:()=>{n&&clearTimeout(n)}},n=setTimeout((()=>{i(null===s?re.errorForCode(Z.Timeout):s)}),e)}));return Object.assign(i,r)}function ge(e=0){let t;const s=new Promise((s=>{const r=setTimeout((()=>{s()}),e);t={cancel:()=>{r&&clearTimeout(r)}}}));return Object.assign(s,t)}function be(){let e={};const t=new Promise(((t,s)=>{e={resolve:t,reject:s}}));return Object.assign(t,e)}function we(e){for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}function _e(e=[0,250,250,500,500,3e3,5e3]){Array.isArray(e)||(e=[0,250,250,500,500,3e3,5e3]);const t=e.length-1;return{backoff(s){return 0===(r=s>t?e[t]:e[s])?0:Math.floor(r/2+Math.random()*r);var r}}}function ye(e){return 1e6*e}function ve(e){return Math.floor(e/1e6)}function Se(e){let t=!0;const s=new Array(e.length);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);if(58===n||n<33||n>126)throw new re(`'${e[r]}' is not a valid character for a header key`,Z.BadHeader);t&&97<=n&&n<=122?n-=32:!t&&65<=n&&n<=90&&(n+=32),s[r]=n,t=45==n}return String.fromCharCode(...s)}function Ee(e=0,t=""){if(0===e&&""!==t||e>0&&""===t)throw new Error("setting status requires both code and description");return new xe(e,t)}!function(e){e.PING="PING",e.STATS="STATS",e.INFO="INFO"}(de||(de={}));const ke="NATS/1.0";class xe{_code;headers;_description;constructor(e=0,t=""){this._code=e,this._description=t,this.headers=new Map}[Symbol.iterator](){return this.headers.entries()}size(){return this.headers.size}equals(e){if(e&&this.headers.size===e.headers.size&&this._code===e._code){for(const[t,s]of this.headers){const r=e.values(t);if(s.length!==r.length)return!1;const n=[...s].sort(),i=[...r].sort();for(let e=0;e<n.length;e++)if(n[e]!==i[e])return!1}return!0}return!1}static decode(e){const t=new xe,s=G.decode(e).split("\r\n"),r=s[0];if(r!==ke){let e=r.replace(ke,"").trim();if(e.length>0){t._code=parseInt(e,10),isNaN(t._code)&&(t._code=0);const s=t._code.toString();e=e.replace(s,""),t._description=e.trim()}}return s.length>=1&&s.slice(1).map((e=>{if(e){const s=e.indexOf(":");if(s>-1){const r=e.slice(0,s),n=e.slice(s+1).trim();t.append(r,n)}}})),t}toString(){if(0===this.headers.size&&0===this._code)return"";let e=ke;this._code>0&&""!==this._description&&(e+=` ${this._code} ${this._description}`);for(const[t,s]of this.headers)for(let r=0;r<s.length;r++)e=`${e}\r\n${t}: ${s[r]}`;return`${e}\r\n\r\n`}encode(){return z.encode(this.toString())}static validHeaderValue(e){if(/[\r\n]/.test(e))throw new re("invalid header value - \\r and \\n are not allowed.",Z.BadHeader);return e.trim()}keys(){const e=[];for(const t of this.headers.keys())e.push(t);return e}findKeys(e,t=ne.Exact){const s=this.keys();switch(t){case ne.Exact:return s.filter((t=>t===e));case ne.CanonicalMIME:return e=Se(e),s.filter((t=>t===e));default:{const t=e.toLowerCase();return s.filter((e=>t===e.toLowerCase()))}}}get(e,t=ne.Exact){const s=this.findKeys(e,t);if(s.length){const e=this.headers.get(s[0]);if(e)return Array.isArray(e)?e[0]:e}return""}last(e,t=ne.Exact){const s=this.findKeys(e,t);if(s.length){const e=this.headers.get(s[0]);if(e)return Array.isArray(e)?e[e.length-1]:e}return""}has(e,t=ne.Exact){return this.findKeys(e,t).length>0}set(e,t,s=ne.Exact){this.delete(e,s),this.append(e,t,s)}append(e,t,s=ne.Exact){const r=Se(e);s===ne.CanonicalMIME&&(e=r);const n=this.findKeys(e,s);e=n.length>0?n[0]:e;const i=xe.validHeaderValue(t);let o=this.headers.get(e);o||(o=[],this.headers.set(e,o)),o.push(i)}values(e,t=ne.Exact){const s=[];return this.findKeys(e,t).forEach((e=>{const t=this.headers.get(e);t&&s.push(...t)})),s}delete(e,t=ne.Exact){this.findKeys(e,t).forEach((e=>{this.headers.delete(e)}))}get hasError(){return this._code>=300}get status(){return`${this._code} ${this._description}`.trim()}toRecord(){const e={};return this.keys().forEach((t=>{e[t]=this.values(t)})),e}get code(){return this._code}get description(){return this._description}static fromRecord(e){const t=new xe;for(const s in e)t.headers.set(s,e[s]);return t}}function Ce(){return{encode:e=>z.encode(e),decode:e=>G.decode(e)}}function Pe(e){return{encode(e){try{return void 0===e&&(e=null),z.encode(JSON.stringify(e))}catch(e){throw re.errorForCode(Z.BadJson,e)}},decode(t){try{return JSON.parse(G.decode(t),e)}catch(e){throw re.errorForCode(Z.BadJson,e)}}}}function Ie(e){return e&&0===e.data.length&&503===e.headers?.code?re.errorForCode(Z.NoResponders):null}class Ae{_headers;_msg;_rdata;_reply;_subject;publisher;static jc;constructor(e,t,s){this._msg=e,this._rdata=t,this.publisher=s}get subject(){return this._subject||(this._subject=G.decode(this._msg.subject)),this._subject}get reply(){return this._reply||(this._reply=G.decode(this._msg.reply)),this._reply}get sid(){return this._msg.sid}get headers(){if(this._msg.hdr>-1&&!this._headers){const e=this._rdata.subarray(0,this._msg.hdr);this._headers=xe.decode(e)}return this._headers}get data(){return this._rdata?this._msg.hdr>-1?this._rdata.subarray(this._msg.hdr):this._rdata:new Uint8Array(0)}respond(e=K,t){return!!this.reply&&(this.publisher.publish(this.reply,e,t),!0)}size(){return this._msg.subject.length+(this._msg.reply?.length||0)+(-1===this._msg.size?0:this._msg.size)}json(e){return Pe(e).decode(this.data)}string(){return G.decode(this.data)}requestInfo(){const e=this.headers?.get("Nats-Request-Info");return e?JSON.parse(e,(function(e,t){return"start"!==e&&"stop"!==e||""===t?t:new Date(Date.parse(t))})):null}}function Oe(e){return Te("durable",e)}function je(e){return Te("stream",e)}function Te(e,t=""){if(""===t)throw Error(`${e} name required`);return[".","*",">","/","\\"," ","\t","\n","\r"].forEach((s=>{if(-1!==t.indexOf(s)){switch(s){case"\n":s="\\n";break;case"\r":s="\\r";break;case"\t":s="\\t"}throw Error(`invalid ${e} name - ${e} name cannot contain '${s}'`)}})),""}function Ne(e,t=""){if(""===t)throw Error(`${e} name required`);const s=function(e=""){if(""===e)throw Error("name required");const t=/^[-\w]+$/g;if(null===e.match(t))for(const s of e.split(""))if(null===s.match(t))return`cannot contain '${s}'`;return""}(t);if(s.length)throw new Error(`invalid ${e} name - ${e} name ${s}`)}function Me(e){if(e.data.length>0)return!1;const t=e.headers;return!!t&&t.code>=100&&t.code<200}function Le(e){return Me(e)&&"Idle Heartbeat"===e.headers?.description}function Re(e){if(0!==e.data.length)return null;const t=e.headers;return t?$e(t.code,t.description):null}var De;!function(e){e.MaxBatchExceeded="exceeded maxrequestbatch of",e.MaxExpiresExceeded="exceeded maxrequestexpires of",e.MaxBytesExceeded="exceeded maxrequestmaxbytes of",e.MaxMessageSizeExceeded="message size exceeds maxbytes",e.PushConsumer="consumer is push based",e.MaxWaitingExceeded="exceeded maxwaiting",e.IdleHeartbeatMissed="idle heartbeats missed",e.ConsumerDeleted="consumer deleted"}(De||(De={}));let Be=!1;function $e(e,t=""){if(e<300)return null;switch(t=t.toLowerCase(),e){case 404:return new re(t,Z.JetStream404NoMessages);case 408:return new re(t,Z.JetStream408RequestTimeout);case 409:{const e=t.startsWith(De.IdleHeartbeatMissed)?Z.JetStreamIdleHeartBeat:Z.JetStream409;return new re(t,e)}case 503:return re.errorForCode(Z.JetStreamNotEnabled,new Error(t));default:return""===t&&(t=Z.Unknown),new re(t,`${e}`)}}class Ue{inflight;processed;received;noIterator;iterClosed;done;signal;yields;filtered;pendingFiltered;ingestionFilterFn;protocolFilterFn;dispatchedFn;ctx;_data;err;time;yielding;constructor(){this.inflight=0,this.filtered=0,this.pendingFiltered=0,this.processed=0,this.received=0,this.noIterator=!1,this.done=!1,this.signal=be(),this.yields=[],this.iterClosed=be(),this.time=0,this.yielding=!1}[Symbol.asyncIterator](){return this.iterate()}push(e){if(this.done)return;if("function"==typeof e)return this.yields.push(e),void this.signal.resolve();const{ingest:t,protocol:s}=this.ingestionFilterFn?this.ingestionFilterFn(e,this.ctx||this):{ingest:!0,protocol:!1};t&&(s&&(this.filtered++,this.pendingFiltered++),this.yields.push(e),this.signal.resolve())}async*iterate(){if(this.noIterator)throw new re("unsupported iterator",Z.ApiError);if(this.yielding)throw new re("already yielding",Z.ApiError);this.yielding=!0;try{for(;;){if(0===this.yields.length&&await this.signal,this.err)throw this.err;const e=this.yields;this.inflight=e.length,this.yields=[];for(let t=0;t<e.length;t++)if("function"!=typeof e[t]){if(!this.protocolFilterFn||this.protocolFilterFn(e[t])){this.processed++;const s=Date.now();yield e[t],this.time=Date.now()-s,this.dispatchedFn&&e[t]&&this.dispatchedFn(e[t])}else this.pendingFiltered--;this.inflight--}else{const s=e[t];try{s()}catch(e){throw e}if(this.err)throw this.err}if(this.done)break;0===this.yields.length&&(e.length=0,this.yields=e,this.signal=be())}}finally{this.stop()}}stop(e){this.done||(this.err=e,this.done=!0,this.signal.resolve(),this.iterClosed.resolve(e))}getProcessed(){return this.noIterator?this.received:this.processed}getPending(){return this.yields.length+this.inflight-this.pendingFiltered}getReceived(){return this.received-this.filtered}}class Fe{interval;maxOut;cancelAfter;timer;autoCancelTimer;last;missed;count;callback;constructor(e,t,s={maxOut:2}){this.interval=e,this.maxOut=s?.maxOut||2,this.cancelAfter=s?.cancelAfter||0,this.last=Date.now(),this.missed=0,this.count=0,this.callback=t,this._schedule()}cancel(){this.autoCancelTimer&&clearTimeout(this.autoCancelTimer),this.timer&&clearInterval(this.timer),this.timer=0,this.autoCancelTimer=0,this.missed=0}work(){this.last=Date.now(),this.missed=0}_change(e,t=0,s=2){this.interval=e,this.maxOut=s,this.cancelAfter=t,this.restart()}restart(){this.cancel(),this._schedule()}_schedule(){this.cancelAfter>0&&(this.autoCancelTimer=setTimeout((()=>{this.cancel()}),this.cancelAfter)),this.timer=setInterval((()=>{if(this.count++,Date.now()-this.last>this.interval&&this.missed++,this.missed>=this.maxOut)try{!0===this.callback(this.missed)&&this.cancel()}catch(e){console.log(e)}}),this.interval)}}var qe,He,Ke,ze,Ge,Je,Ve,We,Ye,Qe,Xe,Ze,et;!function(e){e.Limits="limits",e.Interest="interest",e.Workqueue="workqueue"}(qe||(qe={})),function(e){e.Old="old",e.New="new"}(He||(He={})),function(e){e.File="file",e.Memory="memory"}(Ke||(Ke={})),function(e){e.All="all",e.Last="last",e.New="new",e.StartSequence="by_start_sequence",e.StartTime="by_start_time",e.LastPerSubject="last_per_subject"}(ze||(ze={})),function(e){e.None="none",e.All="all",e.Explicit="explicit",e.NotSet=""}(Ge||(Ge={})),function(e){e.Instant="instant",e.Original="original"}(Je||(Je={})),function(e){e.None="none",e.S2="s2"}(Ve||(Ve={})),function(e){e.CreateOrUpdate="",e.Update="update",e.Create="create"}(We||(We={})),function(e){e.API="api_audit",e.StreamAction="stream_action",e.ConsumerAction="consumer_action",e.SnapshotCreate="snapshot_create",e.SnapshotComplete="snapshot_complete",e.RestoreCreate="restore_create",e.RestoreComplete="restore_complete",e.MaxDeliver="max_deliver",e.Terminated="terminated",e.Ack="consumer_ack",e.StreamLeaderElected="stream_leader_elected",e.StreamQuorumLost="stream_quorum_lost",e.ConsumerLeaderElected="consumer_leader_elected",e.ConsumerQuorumLost="consumer_quorum_lost"}(Ye||(Ye={})),function(e){e.StreamSourceHdr="Nats-Stream-Source",e.LastConsumerSeqHdr="Nats-Last-Consumer",e.LastStreamSeqHdr="Nats-Last-Stream",e.ConsumerStalledHdr="Nats-Consumer-Stalled",e.MessageSizeHdr="Nats-Msg-Size",e.RollupHdr="Nats-Rollup",e.RollupValueSubject="sub",e.RollupValueAll="all",e.PendingMessagesHdr="Nats-Pending-Messages",e.PendingBytesHdr="Nats-Pending-Bytes"}(Qe||(Qe={})),function(e){e.LastValue="",e.AllHistory="history",e.UpdatesOnly="updates"}(Xe||(Xe={})),function(e){e.Stream="Nats-Stream",e.Sequence="Nats-Sequence",e.TimeStamp="Nats-Time-Stamp",e.Subject="Nats-Subject"}(Ze||(Ze={})),function(e){e.Stream="Nats-Stream",e.Subject="Nats-Subject",e.Sequence="Nats-Sequence",e.LastSequence="Nats-Last-Sequence",e.Size="Nats-Msg-Size"}(et||(et={}));const tt="KV_";class st{config;ordered;mack;stream;callbackFn;max;qname;isBind;filters;constructor(e){this.stream="",this.mack=!1,this.ordered=!1,this.config=function(e,t={}){return Object.assign({name:e,deliver_policy:ze.All,ack_policy:Ge.Explicit,ack_wait:ye(3e4),replay_policy:Je.Instant},t)}("",e||{})}getOpts(){const e={};if(e.config=Object.assign({},this.config),e.config.filter_subject&&(this.filterSubject(e.config.filter_subject),e.config.filter_subject=void 0),e.config.filter_subjects&&(e.config.filter_subjects?.forEach((e=>{this.filterSubject(e)})),e.config.filter_subjects=void 0),e.mack=this.mack,e.stream=this.stream,e.callbackFn=this.callbackFn,e.max=this.max,e.queue=this.qname,e.ordered=this.ordered,e.config.ack_policy=e.ordered?Ge.None:e.config.ack_policy,e.isBind=e.isBind||!1,this.filters)switch(this.filters.length){case 0:break;case 1:e.config.filter_subject=this.filters[0];break;default:e.config.filter_subjects=this.filters}return e}description(e){return this.config.description=e,this}deliverTo(e){return this.config.deliver_subject=e,this}durable(e){return Oe(e),this.config.durable_name=e,this}startSequence(e){if(e<=0)throw new Error("sequence must be greater than 0");return this.config.deliver_policy=ze.StartSequence,this.config.opt_start_seq=e,this}startTime(e){return this.config.deliver_policy=ze.StartTime,this.config.opt_start_time=e.toISOString(),this}deliverAll(){return this.config.deliver_policy=ze.All,this}deliverLastPerSubject(){return this.config.deliver_policy=ze.LastPerSubject,this}deliverLast(){return this.config.deliver_policy=ze.Last,this}deliverNew(){return this.config.deliver_policy=ze.New,this}startAtTimeDelta(e){return this.startTime(new Date(Date.now()-e)),this}headersOnly(){return this.config.headers_only=!0,this}ackNone(){return this.config.ack_policy=Ge.None,this}ackAll(){return this.config.ack_policy=Ge.All,this}ackExplicit(){return this.config.ack_policy=Ge.Explicit,this}ackWait(e){return this.config.ack_wait=ye(e),this}maxDeliver(e){return this.config.max_deliver=e,this}filterSubject(e){return this.filters=this.filters||[],this.filters.push(e),this}replayInstantly(){return this.config.replay_policy=Je.Instant,this}replayOriginal(){return this.config.replay_policy=Je.Original,this}sample(e){if((e=Math.trunc(e))<0||e>100)throw new Error("value must be between 0-100");return this.config.sample_freq=`${e}%`,this}limit(e){return this.config.rate_limit_bps=e,this}maxWaiting(e){return this.config.max_waiting=e,this}maxAckPending(e){return this.config.max_ack_pending=e,this}idleHeartbeat(e){return this.config.idle_heartbeat=ye(e),this}flowControl(){return this.config.flow_control=!0,this}deliverGroup(e){return this.queue(e),this}manualAck(){return this.mack=!0,this}maxMessages(e){return this.max=e,this}callback(e){return this.callbackFn=e,this}queue(e){return this.qname=e,this.config.deliver_group=e,this}orderedConsumer(){return this.ordered=!0,this}bind(e,t){return this.stream=e,this.config.durable_name=t,this.isBind=!0,this}bindStream(e){return this.stream=e,this}inactiveEphemeralThreshold(e){return this.config.inactive_threshold=ye(e),this}maxPullBatch(e){return this.config.max_batch=e,this}maxPullRequestExpires(e){return this.config.max_expires=ye(e),this}memory(){return this.config.mem_storage=!0,this}numReplicas(e){return this.config.num_replicas=e,this}consumerName(e){return this.config.name=e,this}}function rt(e){return new st(e)}function nt(e){return"function"==typeof e.getOpts}class it{static encode(e){if("string"==typeof e)return btoa(e);const t=Array.from(e);return btoa(String.fromCharCode(...t))}static decode(e,t=!1){const s=atob(e);return t?Uint8Array.from(s,(e=>e.charCodeAt(0))):s}}class ot{static encode(e){return ot.toB64URLEncoding(it.encode(e))}static decode(e,t=!1){return ot.decode(ot.fromB64URLEncoding(e),t)}static toB64URLEncoding(e){return e.replace(/\+/g,"-").replace(/\//g,"_")}static fromB64URLEncoding(e){return e.replace(/_/g,"/").replace(/-/g,"+")}}class at{buffers;byteLength;constructor(){this.buffers=[],this.byteLength=0}static concat(...e){let t=0;for(let s=0;s<e.length;s++)t+=e[s].length;const s=new Uint8Array(t);let r=0;for(let t=0;t<e.length;t++)s.set(e[t],r),r+=e[t].length;return s}static fromAscii(e){return e||(e=""),z.encode(e)}static toAscii(e){return G.decode(e)}reset(){this.buffers.length=0,this.byteLength=0}pack(){if(this.buffers.length>1){const e=new Uint8Array(this.byteLength);let t=0;for(let s=0;s<this.buffers.length;s++)e.set(this.buffers[s],t),t+=this.buffers[s].length;this.buffers.length=0,this.buffers.push(e)}}shift(){if(this.buffers.length){const e=this.buffers.shift();if(e)return this.byteLength-=e.length,e}return new Uint8Array(0)}drain(e){if(this.buffers.length){this.pack();const t=this.buffers.pop();if(t){const s=this.byteLength;(void 0===e||e>s)&&(e=s);const r=t.subarray(0,e);return s>e&&this.buffers.push(t.subarray(e)),this.byteLength=s-e,r}}return new Uint8Array(0)}fill(e,...t){e&&(this.buffers.push(e),this.byteLength+=e.length);for(let e=0;e<t.length;e++)t[e]&&t[e].length&&(this.buffers.push(t[e]),this.byteLength+=t[e].length)}peek(){return this.buffers.length?(this.pack(),this.buffers[0]):new Uint8Array(0)}size(){return this.byteLength}length(){return this.buffers.length}}function ct(e){const t=e.length;let s=e.indexOf("=");return-1===s&&(s=t),[s,s===t?0:4-s%4]}const ht=[],ut=[],lt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";for(let e=0,t=64;e<t;++e)ht[e]=lt[e],ut[lt.charCodeAt(e)]=e;const{byteLength:dt,toUint8Array:ft,fromUint8Array:pt}=function(e,t,s=!1){function r(e,t){return Math.floor(3*(e+t)/4-t)}function n(t,s,r){const n=new Array((r-s)/3);for(let o=s,a=0;o<r;o+=3)n[a++]=(i=(t[o]<<16)+(t[o+1]<<8)+t[o+2],e[i>>18&63]+e[i>>12&63]+e[i>>6&63]+e[63&i]);var i;return n.join("")}return{byteLength:e=>r.apply(null,ct(e)),toUint8Array(e){const[s,n]=ct(e),i=new Uint8Array(r(s,n)),o=n?s-4:s;let a,c,h=0;for(c=0;c<o;c+=4)a=t[e.charCodeAt(c)]<<18|t[e.charCodeAt(c+1)]<<12|t[e.charCodeAt(c+2)]<<6|t[e.charCodeAt(c+3)],i[h++]=a>>16&255,i[h++]=a>>8&255,i[h++]=255&a;return 2===n?(a=t[e.charCodeAt(c)]<<2|t[e.charCodeAt(c+1)]>>4,i[h++]=255&a):1===n&&(a=t[e.charCodeAt(c)]<<10|t[e.charCodeAt(c+1)]<<4|t[e.charCodeAt(c+2)]>>2,i[h++]=a>>8&255,i[h++]=255&a),i},fromUint8Array(t){const r=t.length,i=r%3,o=r-i,a=new Array(Math.ceil(o/16383)+(i?1:0));let c,h,u=0;for(let e=0;e<o;e+=16383)c=e+16383,a[u++]=n(t,e,c>o?o:c);return 1===i?(h=t[o],a[u]=e[h>>2]+e[h<<4&63],s||(a[u]+="==")):2===i&&(h=t[o]<<8|255&t[o+1],a[u]=e[h>>10]+e[h>>4&63]+e[h<<2&63],s||(a[u]+="=")),a.join("")}}}(ht,ut,!0),mt=new TextDecoder,gt=new TextEncoder;class bt{hashSize=32;_buf;_bufIdx;_count;_K;_H;_finalized;constructor(){this._buf=new Uint8Array(64),this._K=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),this.init()}init(){return this._H=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),this._bufIdx=0,this._count=new Uint32Array(2),this._buf.fill(0),this._finalized=!1,this}update(e,t){if(null===e)throw new TypeError("msg must be a string or Uint8Array.");"string"==typeof e&&(e=function(e,t="utf8"){if(/^utf-?8$/i.test(t))return gt.encode(e);if(/^base64$/i.test(t))return ft(e);if(/^hex(?:adecimal)?$/i.test(t))return function(e){const t=e.length;if(t%2||!/^[0-9a-fA-F]+$/.test(e))throw new TypeError("Invalid hex string.");e=e.toLowerCase();const s=new Uint8Array(Math.floor(t/2)),r=t/2;for(let t=0;t<r;++t)s[t]=parseInt(e.substr(2*t,2),16);return s}(e);throw new TypeError("Unsupported string encoding.")}(e,t));for(let t=0,s=e.length;t<s;t++)this._buf[this._bufIdx++]=e[t],64===this._bufIdx&&(this._transform(),this._bufIdx=0);const s=this._count;return(s[0]+=e.length<<3)<e.length<<3&&s[1]++,s[1]+=e.length>>>29,this}digest(e){if(this._finalized)throw new Error("digest has already been called.");this._finalized=!0;const t=this._buf;let s=this._bufIdx;for(t[s++]=128;56!==s;)64===s&&(this._transform(),s=0),t[s++]=0;const r=this._count;t[56]=r[1]>>>24&255,t[57]=r[1]>>>16&255,t[58]=r[1]>>>8&255,t[59]=r[1]>>>0&255,t[60]=r[0]>>>24&255,t[61]=r[0]>>>16&255,t[62]=r[0]>>>8&255,t[63]=r[0]>>>0&255,this._transform();const n=new Uint8Array(32);for(let e=0;e<8;e++)n[0+(e<<2)]=this._H[e]>>>24&255,n[1+(e<<2)]=this._H[e]>>>16&255,n[2+(e<<2)]=this._H[e]>>>8&255,n[3+(e<<2)]=this._H[e]>>>0&255;return this.init(),e?function(e,t="utf8"){if(/^utf-?8$/i.test(t))return mt.decode(e);if(/^base64$/i.test(t))return pt(e);if(/^hex(?:adecimal)?$/i.test(t))return function(e){return e.reduce(((e,t)=>`${e}${t<16?"0":""}${t.toString(16)}`),"")}(e);throw new TypeError("Unsupported string encoding.")}(n,e):n}_transform(){const e=this._H;let t=e[0],s=e[1],r=e[2],n=e[3],i=e[4],o=e[5],a=e[6],c=e[7];const h=new Uint32Array(16);let u;for(u=0;u<16;u++)h[u]=this._buf[3+(u<<2)]|this._buf[2+(u<<2)]<<8|this._buf[1+(u<<2)]<<16|this._buf[u<<2]<<24;for(u=0;u<64;u++){let e;if(u<16)e=h[u];else{let t=h[u+1&15],s=h[u+14&15];e=h[15&u]=(t>>>7^t>>>18^t>>>3^t<<25^t<<14)+(s>>>17^s>>>19^s>>>10^s<<15^s<<13)+h[15&u]+h[u+9&15]|0}e=e+c+(i>>>6^i>>>11^i>>>25^i<<26^i<<21^i<<7)+(a^i&(o^a))+this._K[u]|0,c=a,a=o,o=i,i=n+e,n=r,r=s,s=t,t=e+(s&r^n&(s^r))+(s>>>2^s>>>13^s>>>22^s<<30^s<<19^s<<10)|0}e[0]=e[0]+t|0,e[1]=e[1]+s|0,e[2]=e[2]+r|0,e[3]=e[3]+n|0,e[4]=e[4]+i|0,e[5]=e[5]+o|0,e[6]=e[6]+a|0,e[7]=e[7]+c|0}}class wt{token;received;ctx;requestSubject;mux;constructor(e,t,s=!0){this.mux=e,this.requestSubject=t,this.received=0,this.token=Y.next(),s&&(this.ctx=new Error)}}class _t extends wt{callback;done;timer;max;opts;constructor(e,t,s={maxWait:1e3}){if(super(e,t),this.opts=s,"function"!=typeof this.opts.callback)throw new Error("callback is required");this.callback=this.opts.callback,this.max="number"==typeof s.maxMessages&&s.maxMessages>0?s.maxMessages:-1,this.done=be(),this.done.then((()=>{this.callback(null,null)})),this.timer=setTimeout((()=>{this.cancel()}),s.maxWait)}cancel(e){e&&this.callback(e,null),clearTimeout(this.timer),this.mux.cancel(this),this.done.resolve()}resolver(e,t){e?(this.ctx&&(e.stack+=`\n\n${this.ctx.stack}`),this.cancel(e)):(this.callback(null,t),this.opts.strategy===ie.Count&&(this.max--,0===this.max&&this.cancel()),this.opts.strategy===ie.JitterTimer&&(clearTimeout(this.timer),this.timer=setTimeout((()=>{this.cancel()}),this.opts.jitter||300)),this.opts.strategy===ie.SentinelMsg&&t&&0===t.data.length&&this.cancel())}}class yt extends wt{deferred;timer;constructor(e,t,s={timeout:1e3},r=!0){super(e,t,r),this.deferred=be(),this.timer=me(s.timeout,r)}resolver(e,t){this.timer&&this.timer.cancel(),e?(this.ctx&&(e.stack+=`\n\n${this.ctx.stack}`),this.deferred.reject(e)):this.deferred.resolve(t),this.cancel()}cancel(e){this.timer&&this.timer.cancel(),this.mux.cancel(this),this.deferred.reject(e||re.errorForCode(Z.Cancelled))}}class vt{nc;opts;prefix;timeout;jc;constructor(e,t){this.nc=e,this.opts=function(e){return(e=e||{}).domain&&(e.apiPrefix=`$JS.${e.domain}.API`,delete e.domain),fe({apiPrefix:"$JS.API",timeout:5e3},e)}(t),this._parseOpts(),this.prefix=this.opts.apiPrefix,this.timeout=this.opts.timeout,this.jc=Pe()}getOptions(){return Object.assign({},this.opts)}_parseOpts(){let e=this.opts.apiPrefix;if(!e||0===e.length)throw new Error("invalid empty prefix");"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),this.opts.apiPrefix=e}async _request(e,t=null,s){(s=s||{}).timeout=this.timeout;let r=K;t&&(r=this.jc.encode(t));let{retries:n}=s;n=n||1,n=-1===n?Number.MAX_SAFE_INTEGER:n;const i=_e();for(let t=0;t<n;t++)try{const t=await this.nc.request(e,r,s);return this.parseJsResponse(t)}catch(e){const s=e;if("503"!==s.code&&s.code!==Z.Timeout||!(t+1<n))throw e;await ge(i.backoff(t))}}async findStream(e){const t={subject:e},s=await this._request(`${this.prefix}.STREAM.NAMES`,t);if(!s.streams||1!==s.streams.length)throw new Error("no stream matches subject");return s.streams[0]}getConnection(){return this.nc}parseJsResponse(e){const t=this.jc.decode(e.data),s=t;if(s.error){const e=$e(s.error.code,s.error.description);if(null!==e)throw e.api_error=s.error,e}return t}}class St{err;offset;pageInfo;subject;jsm;filter;payload;constructor(e,t,s,r){if(!e)throw new Error("subject is required");this.subject=e,this.jsm=s,this.offset=0,this.pageInfo={},this.filter=t,this.payload=r||{}}async next(){if(this.err)return[];if(this.pageInfo&&this.offset>=this.pageInfo.total)return[];const e={offset:this.offset};this.payload&&Object.assign(e,this.payload);try{const t=await this.jsm._request(this.subject,e,{timeout:this.jsm.timeout});this.pageInfo=t;const s=this.countResponse(t);return 0===s?[]:(this.offset+=s,this.filter(t))}catch(e){throw this.err=e,e}}countResponse(e){switch(e?.type){case"io.nats.jetstream.api.v1.stream_names_response":case"io.nats.jetstream.api.v1.stream_list_response":return e.streams?.length||0;case"io.nats.jetstream.api.v1.consumer_list_response":return e.consumers?.length||0;default:return console.error(`jslister.ts: unknown API response for paged output: ${e?.type}`),e.streams?.length||0}return 0}async*[Symbol.asyncIterator](){let e=await this.next();for(;e.length>0;){for(const t of e)yield t;e=await this.next()}}}function Et(e=""){const t=e.match(/(\d+).(\d+).(\d+)/);if(t)return{major:parseInt(t[1]),minor:parseInt(t[2]),micro:parseInt(t[3])};throw new Error(`'${e}' is not a semver value`)}function kt(e,t){return e.major<t.major?-1:e.major>t.major?1:e.minor<t.minor?-1:e.minor>t.minor?1:e.micro<t.micro?-1:e.micro>t.micro?1:0}var xt;!function(e){e.JS_KV="js_kv",e.JS_OBJECTSTORE="js_objectstore",e.JS_PULL_MAX_BYTES="js_pull_max_bytes",e.JS_NEW_CONSUMER_CREATE_API="js_new_consumer_create",e.JS_ALLOW_DIRECT="js_allow_direct",e.JS_MULTIPLE_CONSUMER_FILTER="js_multiple_consumer_filter",e.JS_SIMPLIFICATION="js_simplification",e.JS_STREAM_CONSUMER_METADATA="js_stream_consumer_metadata",e.JS_CONSUMER_FILTER_SUBJECTS="js_consumer_filter_subjects",e.JS_STREAM_FIRST_SEQ="js_stream_first_seq",e.JS_STREAM_SUBJECT_TRANSFORM="js_stream_subject_transform",e.JS_STREAM_SOURCE_SUBJECT_TRANSFORM="js_stream_source_subject_transform",e.JS_STREAM_COMPRESSION="js_stream_compression",e.JS_DEFAULT_CONSUMER_LIMITS="js_default_consumer_limits",e.JS_BATCH_DIRECT_GET="js_batch_direct_get"}(xt||(xt={}));class Ct{server;features;disabled;constructor(e){this.features=new Map,this.disabled=[],this.update(e)}resetDisabled(){this.disabled.length=0,this.update(this.server)}disable(e){this.disabled.push(e),this.update(this.server)}isDisabled(e){return-1!==this.disabled.indexOf(e)}update(e){"string"==typeof e&&(e=Et(e)),this.server=e,this.set(xt.JS_KV,"2.6.2"),this.set(xt.JS_OBJECTSTORE,"2.6.3"),this.set(xt.JS_PULL_MAX_BYTES,"2.8.3"),this.set(xt.JS_NEW_CONSUMER_CREATE_API,"2.9.0"),this.set(xt.JS_ALLOW_DIRECT,"2.9.0"),this.set(xt.JS_MULTIPLE_CONSUMER_FILTER,"2.10.0"),this.set(xt.JS_SIMPLIFICATION,"2.9.4"),this.set(xt.JS_STREAM_CONSUMER_METADATA,"2.10.0"),this.set(xt.JS_CONSUMER_FILTER_SUBJECTS,"2.10.0"),this.set(xt.JS_STREAM_FIRST_SEQ,"2.10.0"),this.set(xt.JS_STREAM_SUBJECT_TRANSFORM,"2.10.0"),this.set(xt.JS_STREAM_SOURCE_SUBJECT_TRANSFORM,"2.10.0"),this.set(xt.JS_STREAM_COMPRESSION,"2.10.0"),this.set(xt.JS_DEFAULT_CONSUMER_LIMITS,"2.10.0"),this.set(xt.JS_BATCH_DIRECT_GET,"2.11.0"),this.disabled.forEach((e=>{this.features.delete(e)}))}set(e,t){this.features.set(e,{min:t,ok:kt(this.server,Et(t))>=0})}get(e){return this.features.get(e)||{min:"unknown",ok:!1}}supports(e){return this.get(e)?.ok||!1}require(e){return"string"==typeof e&&(e=Et(e)),kt(this.server,e)>=0}}class Pt extends vt{constructor(e,t){super(e,t)}async add(e,t,s=We.Create){if(je(e),t.deliver_group&&t.flow_control)throw new Error("jetstream flow control is not supported with queue groups");if(t.deliver_group&&t.idle_heartbeat)throw new Error("jetstream idle heartbeat is not supported with queue groups");const r={};r.config=t,r.stream_name=e,r.action=s,r.config.durable_name&&Oe(r.config.durable_name);const n=this.nc;let{min:i,ok:o}=n.features.get(xt.JS_NEW_CONSUMER_CREATE_API);const a=""===t.name?void 0:t.name;if(a&&!o)throw new Error(`consumer 'name' requires server ${i}`);if(a)try{Te("name",a)}catch(e){const t=e.message,s=t.indexOf("cannot contain");if(-1!==s)throw new Error(`consumer 'name' ${t.substring(s)}`);throw e}let c,h="";if(Array.isArray(t.filter_subjects)){const{min:e,ok:t}=n.features.get(xt.JS_MULTIPLE_CONSUMER_FILTER);if(!t)throw new Error(`consumer 'filter_subjects' requires server ${e}`);o=!1}if(t.metadata){const{min:e,ok:t}=n.features.get(xt.JS_STREAM_CONSUMER_METADATA);if(!t)throw new Error(`consumer 'metadata' requires server ${e}`)}if(o&&(h=t.name??t.durable_name??""),""!==h){let s=t.filter_subject??void 0;">"===s&&(s=void 0),c=void 0!==s?`${this.prefix}.CONSUMER.CREATE.${e}.${h}.${s}`:`${this.prefix}.CONSUMER.CREATE.${e}.${h}`}else c=t.durable_name?`${this.prefix}.CONSUMER.DURABLE.CREATE.${e}.${t.durable_name}`:`${this.prefix}.CONSUMER.CREATE.${e}`;return await this._request(c,r)}async update(e,t,s){const r=await this.info(e,t),n=s;return this.add(e,Object.assign(r.config,n),We.Update)}async info(e,t){return je(e),Oe(t),await this._request(`${this.prefix}.CONSUMER.INFO.${e}.${t}`)}async delete(e,t){return je(e),Oe(t),(await this._request(`${this.prefix}.CONSUMER.DELETE.${e}.${t}`)).success}list(e){je(e);const t=`${this.prefix}.CONSUMER.LIST.${e}`;return new St(t,(e=>e.consumers),this)}pause(e,t,s){const r=`${this.prefix}.CONSUMER.PAUSE.${e}.${t}`,n={pause_until:s.toISOString()};return this._request(r,n)}resume(e,t){return this.pause(e,t,new Date(0))}}function It(e,t,s=!1){if(!0===s&&!e)throw re.errorForCode(Z.ApiError,new Error(`${t} is not a function`));if(e&&"function"!=typeof e)throw re.errorForCode(Z.ApiError,new Error(`${t} is not a function`))}class At extends Ue{sub;adapter;subIterDone;constructor(e,t,s){super(),It(s.adapter,"adapter",!0),this.adapter=s.adapter,s.callback&&It(s.callback,"callback"),this.noIterator="function"==typeof s.callback,s.ingestionFilterFn&&(It(s.ingestionFilterFn,"ingestionFilterFn"),this.ingestionFilterFn=s.ingestionFilterFn),s.protocolFilterFn&&(It(s.protocolFilterFn,"protocolFilterFn"),this.protocolFilterFn=s.protocolFilterFn),s.dispatchedFn&&(It(s.dispatchedFn,"dispatchedFn"),this.dispatchedFn=s.dispatchedFn),s.cleanupFn&&It(s.cleanupFn,"cleanupFn");let r=(e,t)=>{this.callback(e,t)};if(s.callback){const e=s.callback;r=(t,s)=>{const[r,n]=this.adapter(t,s);if(r)return void e(r,null);const{ingest:i}=this.ingestionFilterFn?this.ingestionFilterFn(n,this):{ingest:!0};i&&(!this.protocolFilterFn||this.protocolFilterFn(n))&&(e(r,n),this.dispatchedFn&&n&&this.dispatchedFn(n))}}const{max:n,queue:i,timeout:o}=s,a={queue:i,timeout:o,callback:r};n&&n>0&&(a.max=n),this.sub=e.subscribe(t,a),s.cleanupFn&&(this.sub.cleanupFn=s.cleanupFn),this.noIterator||this.iterClosed.then((()=>{this.unsubscribe()})),this.subIterDone=be(),Promise.all([this.sub.closed,this.iterClosed]).then((()=>{this.subIterDone.resolve()})).catch((()=>{this.subIterDone.resolve()})),(async e=>{await e.closed,this.stop()})(this.sub).then().catch()}unsubscribe(e){this.sub.unsubscribe(e)}drain(){return this.sub.drain()}isDraining(){return this.sub.isDraining()}isClosed(){return this.sub.isClosed()}callback(e,t){this.sub.cancelTimeout();const[s,r]=this.adapter(e,t);s&&this.stop(s),r&&this.push(r)}getSubject(){return this.sub.getSubject()}getReceived(){return this.sub.getReceived()}getProcessed(){return this.sub.getProcessed()}getPending(){return this.sub.getPending()}getID(){return this.sub.getID()}getMax(){return this.sub.getMax()}get closed(){return this.sub.closed}}let Ot;function jt(){return void 0!==Ot&&void 0!==Ot.defaultPort?Ot.defaultPort:4222}function Tt(){return void 0!==Ot&&Ot.urlParseFn?Ot.urlParseFn:void 0}function Nt(){return void 0!==Ot&&Ot.dnsResolveFn?Ot.dnsResolveFn:void 0}const Mt="\r\n",Lt=at.fromAscii(Mt),Rt=new Uint8Array(Lt)[0],Dt=new Uint8Array(Lt)[1];const Bt=4,$t=48,Ut=65,Ft=97;function qt(e){return void 0!==function(e){for(let t=0;t<e.length;t++)switch(e[t]){case".":return Ht(e);case":":return Kt(e)}}(e)}function Ht(e){const t=new Uint8Array(4);for(let s=0;s<4;s++){if(0===e.length)return;if(s>0){if("."!==e[0])return;e=e.substring(1)}const{n:r,c:n,ok:i}=zt(e);if(!i||r>255)return;e=e.substring(n),t[s]=r}return function(e,t,s,r){const n=new Uint8Array(16);return[0,0,0,0,0,0,0,0,0,0,255,255].forEach(((e,t)=>{n[t]=e})),n[12]=e,n[13]=t,n[14]=s,n[15]=r,n}(t[0],t[1],t[2],t[3])}function Kt(e){const t=new Uint8Array(16);let s=-1;if(e.length>=2&&":"===e[0]&&":"===e[1]&&(s=0,0===(e=e.substring(2)).length))return t;let r=0;for(;r<16;){const{n,c:i,ok:o}=Gt(e);if(!o||n>65535)return;if(i<e.length&&"."===e[i]){if(s<0&&12!=r)return;if(r+4>16)return;const n=Ht(e);if(void 0===n)return;t[r]=n[12],t[r+1]=n[13],t[r+2]=n[14],t[r+3]=n[15],e="",r+=Bt;break}if(t[r]=n>>8,t[r+1]=n,r+=2,0===(e=e.substring(i)).length)break;if(":"!==e[0]||1==e.length)return;if(":"===(e=e.substring(1))[0]){if(s>=0)return;if(s=r,0===(e=e.substring(1)).length)break}}if(0===e.length){if(r<16){if(s<0)return;const e=16-r;for(let n=r-1;n>=s;n--)t[n+e]=t[n];for(let r=s+e-1;r>=s;r--)t[r]=0}else if(s>=0)return;return t}}function zt(e){let t=0,s=0;for(t=0;t<e.length&&48<=e.charCodeAt(t)&&e.charCodeAt(t)<=57;t++)if(s=10*s+(e.charCodeAt(t)-$t),s>=16777215)return{n:16777215,c:t,ok:!1};return 0===t?{n:0,c:0,ok:!1}:{n:s,c:t,ok:!0}}function Gt(e){let t=0,s=0;for(s=0;s<e.length;s++){if(48<=e.charCodeAt(s)&&e.charCodeAt(s)<=57)t*=16,t+=e.charCodeAt(s)-$t;else if(97<=e.charCodeAt(s)&&e.charCodeAt(s)<=102)t*=16,t+=e.charCodeAt(s)-Ft+10;else{if(!(65<=e.charCodeAt(s)&&e.charCodeAt(s)<=70))break;t*=16,t+=e.charCodeAt(s)-Ut+10}if(t>=16777215)return{n:0,c:s,ok:!1}}return 0===s?{n:0,c:s,ok:!1}:{n:t,c:s,ok:!0}}function Jt(e){return!function(e){return-1!==e.indexOf(".")||-1===e.indexOf("[")&&-1===e.indexOf("::")&&e.split(":").length<=2}(e)}class Vt{src;listen;hostname;port;didConnect;reconnects;lastConnect;gossiped;tlsName;resolves;constructor(e,t=!1){this.src=e,this.tlsName="";const s=function(e){(e=e.trim()).match(/^(.*:\/\/)(.*)/m)&&(e=e.replace(/^(.*:\/\/)(.*)/gm,"$2")),Jt(e=function(e){const t=e.toUpperCase().indexOf("::FFFF:");if(-1!==t&&-1!==e.indexOf(".")){let s=e.substring(t+7);return s=s.replace("[",""),s.replace("]","")}return e}(e))&&-1===e.indexOf("[")&&(e=`[${e}]`);const t=Jt(e)?e.match(/(]:)(\d+)/):e.match(/(:)(\d+)/),s=t&&3===t.length&&t[1]&&t[2]?parseInt(t[2]):4222,r=new URL(`${80===s?"https":"http"}://${e}`);r.port=`${s}`;let n=r.hostname;return"["===n.charAt(0)&&(n=n.substring(1,n.length-1)),{listen:r.host,hostname:n,port:s}}(e);this.listen=s.listen,this.hostname=s.hostname,this.port=s.port,this.didConnect=!1,this.reconnects=0,this.lastConnect=0,this.gossiped=t}toString(){return this.listen}async resolve(e){if(!e.fn)return[this];const t=[];if(qt(this.hostname))return[this];{const s=await e.fn(this.hostname);e.debug&&console.log(`resolve ${this.hostname} = ${s.join(",")}`);for(const e of s){const s=80===this.port?"https":"http",r=new URL(`${s}://${Jt(e)?"["+e+"]":e}`);r.port=`${this.port}`;const n=new Vt(r.host,!1);n.tlsName=this.hostname,t.push(n)}}return e.randomize&&we(t),this.resolves=t,t}}class Wt{firstSelect;servers;currentServer;tlsName;randomize;constructor(e=[],t={}){this.firstSelect=!0,this.servers=[],this.tlsName="",this.randomize=t.randomize||!1;const s=Tt();e&&(e.forEach((e=>{e=s?s(e):e,this.servers.push(new Vt(e))})),this.randomize&&(this.servers=we(this.servers))),0===this.servers.length&&this.addServer(`${le}:${jt()}`,!1),this.currentServer=this.servers[0]}clear(){this.servers.length=0}updateTLSName(){const e=this.getCurrentServer();qt(e.hostname)||(this.tlsName=e.hostname,this.servers.forEach((e=>{e.gossiped&&(e.tlsName=this.tlsName)})))}getCurrentServer(){return this.currentServer}addServer(e,t=!1){const s=Tt();e=s?s(e):e;const r=new Vt(e,t);qt(r.hostname)&&(r.tlsName=this.tlsName),this.servers.push(r)}selectServer(){if(this.firstSelect)return this.firstSelect=!1,this.currentServer;const e=this.servers.shift();return e&&(this.servers.push(e),this.currentServer=e),e}removeCurrentServer(){this.removeServer(this.currentServer)}removeServer(e){if(e){const t=this.servers.indexOf(e);this.servers.splice(t,1)}}length(){return this.servers.length}next(){return this.servers.length?this.servers[0]:void 0}getServers(){return this.servers}update(e,t){const s=[];let r=[];const n=Tt(),i=new Map;e.connect_urls&&e.connect_urls.length>0&&e.connect_urls.forEach((e=>{e=n?n(e,t):e;const s=new Vt(e,!0);i.set(e,s)}));const o=[];return this.servers.forEach(((e,t)=>{const s=e.listen;e.gossiped&&this.currentServer.listen!==s&&void 0===i.get(s)&&o.push(t),i.delete(s)})),o.reverse(),o.forEach((e=>{const t=this.servers.splice(e,1);r=r.concat(t[0].listen)})),i.forEach(((e,t)=>{this.servers.push(e),s.push(t)})),{added:s,deleted:r}}}class Yt{baseInbox;reqs;constructor(){this.reqs=new Map}size(){return this.reqs.size}init(e){return this.baseInbox=`${ue(e)}.`,this.baseInbox}add(e){isNaN(e.received)||(e.received=0),this.reqs.set(e.token,e)}get(e){return this.reqs.get(e)}cancel(e){this.reqs.delete(e.token)}getToken(e){const t=e.subject||"";return 0===t.indexOf(this.baseInbox)?t.substring(this.baseInbox.length):null}all(){return Array.from(this.reqs.values())}handleError(e,t){if(t&&t.permissionContext){if(e)return this.all().forEach((e=>{e.resolver(t,{})})),!0;const s=t.permissionContext;if("publish"===s.operation){const e=this.all().find((e=>e.requestSubject===s.subject));if(e)return e.resolver(t,{}),!0}}return!1}dispatcher(){return(e,t)=>{const s=this.getToken(t);if(s){const r=this.get(s);r&&(null===e&&t.headers&&(e=Ie(t)),r.resolver(e,t))}}}close(){const e=re.errorForCode(Z.Timeout);this.reqs.forEach((t=>{t.resolver(e,{})}))}}class Qt{ph;interval;maxOut;timer;pendings;constructor(e,t,s){this.ph=e,this.interval=t,this.maxOut=s,this.pendings=[]}start(){this.cancel(),this._schedule()}cancel(e){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this._reset(),e&&this.ph.disconnect()}_schedule(){this.timer=setTimeout((()=>{if(this.ph.dispatchStatus({type:X.PingTimer,data:`${this.pendings.length+1}`}),this.pendings.length===this.maxOut)return void this.cancel(!0);const e=be();this.ph.flush(e).then((()=>{this._reset()})).catch((()=>{this.cancel()})),this.pendings.push(e),this._schedule()}),this.interval)}_reset(){this.pendings=this.pendings.filter((e=>(e.resolve(),!1)))}}class Xt extends Error{constructor(e){super(e),this.name="AssertionError"}}const Zt=2**32-2;function es(e,t,s=0){const r=t.byteLength-s;return e.byteLength>r&&(e=e.subarray(0,r)),t.set(e,s),e.byteLength}class ts{_buf;_off;constructor(e){this._off=0,this._buf=null!=e?new Uint8Array(e):new Uint8Array(0)}bytes(e={copy:!0}){return!1===e.copy?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(e){if(0!==e){if(e<0||e>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+e)}else this.reset()}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(e){const t=this._buf.byteLength;return e<=this.capacity-t?(this._reslice(t+e),t):-1}_reslice(e){!function(e,t="Assertion failed."){if(!e)throw new Xt(t)}(e<=this._buf.buffer.byteLength),this._buf=new Uint8Array(this._buf.buffer,0,e)}readByte(){const e=new Uint8Array(1);return this.read(e)?e[0]:null}read(e){if(this.empty())return this.reset(),0===e.byteLength?0:null;const t=es(this._buf.subarray(this._off),e);return this._off+=t,t}writeByte(e){return this.write(Uint8Array.of(e))}writeString(e){return this.write(z.encode(e))}write(e){const t=this._grow(e.byteLength);return es(e,this._buf,t)}_grow(e){const t=this.length;0===t&&0!==this._off&&this.reset();const s=this._tryGrowByReslice(e);if(s>=0)return s;const r=this.capacity;if(e<=Math.floor(r/2)-t)es(this._buf.subarray(this._off),this._buf);else{if(r+e>Zt)throw new Error("The buffer cannot be grown beyond the maximum size.");{const t=new Uint8Array(Math.min(2*r+e,Zt));es(this._buf.subarray(this._off),t),this._buf=t}}return this._off=0,this._reslice(Math.min(t+e,Zt)),t}grow(e){if(e<0)throw Error("Buffer._grow: negative count");const t=this._grow(e);this._reslice(t)}readFrom(e){let t=0;const s=new Uint8Array(32768);for(;;){const r=this.capacity-this.length<32768,n=r?s:new Uint8Array(this._buf.buffer,this.length),i=e.read(n);if(null===i)return t;r?this.write(n.subarray(0,i)):this._reslice(this.length+i),t+=i}}}var ss,rs,ns;!function(e){e[e.OK=0]="OK",e[e.ERR=1]="ERR",e[e.MSG=2]="MSG",e[e.INFO=3]="INFO",e[e.PING=4]="PING",e[e.PONG=5]="PONG"}(ss||(ss={}));class is{dispatcher;state;as;drop;hdr;ma;argBuf;msgBuf;constructor(e){this.dispatcher=e,this.state=rs.OP_START,this.as=0,this.drop=0,this.hdr=0}parse(e){let t;for(t=0;t<e.length;t++){const s=e[t];switch(this.state){case rs.OP_START:switch(s){case ns.M:case ns.m:this.state=rs.OP_M,this.hdr=-1,this.ma={sid:-1,hdr:-1,size:-1};break;case ns.H:case ns.h:this.state=rs.OP_H,this.hdr=0,this.ma={sid:-1,hdr:-1,size:-1};break;case ns.P:case ns.p:this.state=rs.OP_P;break;case ns.PLUS:this.state=rs.OP_PLUS;break;case ns.MINUS:this.state=rs.OP_MINUS;break;case ns.I:case ns.i:this.state=rs.OP_I;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_H:switch(s){case ns.M:case ns.m:this.state=rs.OP_M;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_M:switch(s){case ns.S:case ns.s:this.state=rs.OP_MS;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_MS:switch(s){case ns.G:case ns.g:this.state=rs.OP_MSG;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_MSG:switch(s){case ns.SPACE:case ns.TAB:this.state=rs.OP_MSG_SPC;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_MSG_SPC:switch(s){case ns.SPACE:case ns.TAB:continue;default:this.state=rs.MSG_ARG,this.as=t}break;case rs.MSG_ARG:switch(s){case ns.CR:this.drop=1;break;case ns.NL:{const s=this.argBuf?this.argBuf.bytes():e.subarray(this.as,t-this.drop);this.processMsgArgs(s),this.drop=0,this.as=t+1,this.state=rs.MSG_PAYLOAD,t=this.as+this.ma.size-1;break}default:this.argBuf&&this.argBuf.writeByte(s)}break;case rs.MSG_PAYLOAD:if(this.msgBuf)if(this.msgBuf.length>=this.ma.size){const e=this.msgBuf.bytes({copy:!1});this.dispatcher.push({kind:ss.MSG,msg:this.ma,data:e}),this.argBuf=void 0,this.msgBuf=void 0,this.state=rs.MSG_END}else{let r=this.ma.size-this.msgBuf.length;const n=e.length-t;n<r&&(r=n),r>0?(this.msgBuf.write(e.subarray(t,t+r)),t=t+r-1):this.msgBuf.writeByte(s)}else t-this.as>=this.ma.size&&(this.dispatcher.push({kind:ss.MSG,msg:this.ma,data:e.subarray(this.as,t)}),this.argBuf=void 0,this.msgBuf=void 0,this.state=rs.MSG_END);break;case rs.MSG_END:if(s!==ns.NL)continue;this.drop=0,this.as=t+1,this.state=rs.OP_START;break;case rs.OP_PLUS:switch(s){case ns.O:case ns.o:this.state=rs.OP_PLUS_O;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_PLUS_O:switch(s){case ns.K:case ns.k:this.state=rs.OP_PLUS_OK;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_PLUS_OK:s===ns.NL&&(this.dispatcher.push({kind:ss.OK}),this.drop=0,this.state=rs.OP_START);break;case rs.OP_MINUS:switch(s){case ns.E:case ns.e:this.state=rs.OP_MINUS_E;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_MINUS_E:switch(s){case ns.R:case ns.r:this.state=rs.OP_MINUS_ER;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_MINUS_ER:switch(s){case ns.R:case ns.r:this.state=rs.OP_MINUS_ERR;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_MINUS_ERR:switch(s){case ns.SPACE:case ns.TAB:this.state=rs.OP_MINUS_ERR_SPC;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_MINUS_ERR_SPC:switch(s){case ns.SPACE:case ns.TAB:continue;default:this.state=rs.MINUS_ERR_ARG,this.as=t}break;case rs.MINUS_ERR_ARG:switch(s){case ns.CR:this.drop=1;break;case ns.NL:{let s;this.argBuf?(s=this.argBuf.bytes(),this.argBuf=void 0):s=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:ss.ERR,data:s}),this.drop=0,this.as=t+1,this.state=rs.OP_START;break}default:this.argBuf&&this.argBuf.write(Uint8Array.of(s))}break;case rs.OP_P:switch(s){case ns.I:case ns.i:this.state=rs.OP_PI;break;case ns.O:case ns.o:this.state=rs.OP_PO;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_PO:switch(s){case ns.N:case ns.n:this.state=rs.OP_PON;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_PON:switch(s){case ns.G:case ns.g:this.state=rs.OP_PONG;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_PONG:s===ns.NL&&(this.dispatcher.push({kind:ss.PONG}),this.drop=0,this.state=rs.OP_START);break;case rs.OP_PI:switch(s){case ns.N:case ns.n:this.state=rs.OP_PIN;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_PIN:switch(s){case ns.G:case ns.g:this.state=rs.OP_PING;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_PING:s===ns.NL&&(this.dispatcher.push({kind:ss.PING}),this.drop=0,this.state=rs.OP_START);break;case rs.OP_I:switch(s){case ns.N:case ns.n:this.state=rs.OP_IN;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_IN:switch(s){case ns.F:case ns.f:this.state=rs.OP_INF;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_INF:switch(s){case ns.O:case ns.o:this.state=rs.OP_INFO;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_INFO:switch(s){case ns.SPACE:case ns.TAB:this.state=rs.OP_INFO_SPC;break;default:throw this.fail(e.subarray(t))}break;case rs.OP_INFO_SPC:switch(s){case ns.SPACE:case ns.TAB:continue;default:this.state=rs.INFO_ARG,this.as=t}break;case rs.INFO_ARG:switch(s){case ns.CR:this.drop=1;break;case ns.NL:{let s;this.argBuf?(s=this.argBuf.bytes(),this.argBuf=void 0):s=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:ss.INFO,data:s}),this.drop=0,this.as=t+1,this.state=rs.OP_START;break}default:this.argBuf&&this.argBuf.writeByte(s)}break;default:throw this.fail(e.subarray(t))}}this.state!==rs.MSG_ARG&&this.state!==rs.MINUS_ERR_ARG&&this.state!==rs.INFO_ARG||this.argBuf||(this.argBuf=new ts(e.subarray(this.as,t-this.drop))),this.state!==rs.MSG_PAYLOAD||this.msgBuf||(this.argBuf||this.cloneMsgArg(),this.msgBuf=new ts(e.subarray(this.as)))}cloneMsgArg(){const e=this.ma.subject.length,t=this.ma.reply?this.ma.reply.length:0,s=new Uint8Array(e+t);s.set(this.ma.subject),this.ma.reply&&s.set(this.ma.reply,e),this.argBuf=new ts(s),this.ma.subject=s.subarray(0,e),this.ma.reply&&(this.ma.reply=s.subarray(e))}processMsgArgs(e){if(this.hdr>=0)return this.processHeaderMsgArgs(e);const t=[];let s=-1;for(let r=0;r<e.length;r++)switch(e[r]){case ns.SPACE:case ns.TAB:case ns.CR:case ns.NL:s>=0&&(t.push(e.subarray(s,r)),s=-1);break;default:s<0&&(s=r)}switch(s>=0&&t.push(e.subarray(s)),t.length){case 3:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.size=this.protoParseInt(t[2]);break;case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.size=this.protoParseInt(t[3]);break;default:throw this.fail(e,"processMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processMsgArgs Bad or Missing Sid Error");if(this.ma.size<0)throw this.fail(e,"processMsgArgs Bad or Missing Size Error")}fail(e,t=""){return t=t?`${t} [${this.state}]`:`parse error [${this.state}]`,new Error(`${t}: ${G.decode(e)}`)}processHeaderMsgArgs(e){const t=[];let s=-1;for(let r=0;r<e.length;r++)switch(e[r]){case ns.SPACE:case ns.TAB:case ns.CR:case ns.NL:s>=0&&(t.push(e.subarray(s,r)),s=-1);break;default:s<0&&(s=r)}switch(s>=0&&t.push(e.subarray(s)),t.length){case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.hdr=this.protoParseInt(t[2]),this.ma.size=this.protoParseInt(t[3]);break;case 5:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.hdr=this.protoParseInt(t[3]),this.ma.size=this.protoParseInt(t[4]);break;default:throw this.fail(e,"processHeaderMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Sid Error");if(this.ma.hdr<0||this.ma.hdr>this.ma.size)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Header Size Error");if(this.ma.size<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Size Error")}protoParseInt(e){if(0===e.length)return-1;let t=0;for(let s=0;s<e.length;s++){if(e[s]<48||e[s]>57)return-1;t=10*t+(e[s]-48)}return t}}!function(e){e[e.OP_START=0]="OP_START",e[e.OP_PLUS=1]="OP_PLUS",e[e.OP_PLUS_O=2]="OP_PLUS_O",e[e.OP_PLUS_OK=3]="OP_PLUS_OK",e[e.OP_MINUS=4]="OP_MINUS",e[e.OP_MINUS_E=5]="OP_MINUS_E",e[e.OP_MINUS_ER=6]="OP_MINUS_ER",e[e.OP_MINUS_ERR=7]="OP_MINUS_ERR",e[e.OP_MINUS_ERR_SPC=8]="OP_MINUS_ERR_SPC",e[e.MINUS_ERR_ARG=9]="MINUS_ERR_ARG",e[e.OP_M=10]="OP_M",e[e.OP_MS=11]="OP_MS",e[e.OP_MSG=12]="OP_MSG",e[e.OP_MSG_SPC=13]="OP_MSG_SPC",e[e.MSG_ARG=14]="MSG_ARG",e[e.MSG_PAYLOAD=15]="MSG_PAYLOAD",e[e.MSG_END=16]="MSG_END",e[e.OP_H=17]="OP_H",e[e.OP_P=18]="OP_P",e[e.OP_PI=19]="OP_PI",e[e.OP_PIN=20]="OP_PIN",e[e.OP_PING=21]="OP_PING",e[e.OP_PO=22]="OP_PO",e[e.OP_PON=23]="OP_PON",e[e.OP_PONG=24]="OP_PONG",e[e.OP_I=25]="OP_I",e[e.OP_IN=26]="OP_IN",e[e.OP_INF=27]="OP_INF",e[e.OP_INFO=28]="OP_INFO",e[e.OP_INFO_SPC=29]="OP_INFO_SPC",e[e.INFO_ARG=30]="INFO_ARG"}(rs||(rs={})),function(e){e[e.CR="\r".charCodeAt(0)]="CR",e[e.E="E".charCodeAt(0)]="E",e[e.e="e".charCodeAt(0)]="e",e[e.F="F".charCodeAt(0)]="F",e[e.f="f".charCodeAt(0)]="f",e[e.G="G".charCodeAt(0)]="G",e[e.g="g".charCodeAt(0)]="g",e[e.H="H".charCodeAt(0)]="H",e[e.h="h".charCodeAt(0)]="h",e[e.I="I".charCodeAt(0)]="I",e[e.i="i".charCodeAt(0)]="i",e[e.K="K".charCodeAt(0)]="K",e[e.k="k".charCodeAt(0)]="k",e[e.M="M".charCodeAt(0)]="M",e[e.m="m".charCodeAt(0)]="m",e[e.MINUS="-".charCodeAt(0)]="MINUS",e[e.N="N".charCodeAt(0)]="N",e[e.n="n".charCodeAt(0)]="n",e[e.NL="\n".charCodeAt(0)]="NL",e[e.O="O".charCodeAt(0)]="O",e[e.o="o".charCodeAt(0)]="o",e[e.P="P".charCodeAt(0)]="P",e[e.p="p".charCodeAt(0)]="p",e[e.PLUS="+".charCodeAt(0)]="PLUS",e[e.R="R".charCodeAt(0)]="R",e[e.r="r".charCodeAt(0)]="r",e[e.S="S".charCodeAt(0)]="S",e[e.s="s".charCodeAt(0)]="s",e[e.SPACE=" ".charCodeAt(0)]="SPACE",e[e.TAB="\t".charCodeAt(0)]="TAB"}(ns||(ns={})),function(e){var t=function(e,t){this.hi=0|e,this.lo=0|t},s=function(e){var t,s=new Float64Array(16);if(e)for(t=0;t<e.length;t++)s[t]=e[t];return s},r=function(){throw new Error("no PRNG")},n=new Uint8Array(16),i=new Uint8Array(32);i[0]=9;var o=s(),a=s([1]),c=s([56129,1]),h=s([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),u=s([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),l=s([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),d=s([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),f=s([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function p(e,t){return e<<t|e>>>32-t}function m(e,t){var s=255&e[t+3];return(s=(s=s<<8|255&e[t+2])<<8|255&e[t+1])<<8|255&e[t+0]}function g(e,s){var r=e[s]<<24|e[s+1]<<16|e[s+2]<<8|e[s+3],n=e[s+4]<<24|e[s+5]<<16|e[s+6]<<8|e[s+7];return new t(r,n)}function b(e,t,s){var r;for(r=0;r<4;r++)e[t+r]=255&s,s>>>=8}function w(e,t,s){e[t]=s.hi>>24&255,e[t+1]=s.hi>>16&255,e[t+2]=s.hi>>8&255,e[t+3]=255&s.hi,e[t+4]=s.lo>>24&255,e[t+5]=s.lo>>16&255,e[t+6]=s.lo>>8&255,e[t+7]=255&s.lo}function _(e,t,s,r,n){var i,o=0;for(i=0;i<n;i++)o|=e[t+i]^s[r+i];return(1&o-1>>>8)-1}function y(e,t,s,r){return _(e,t,s,r,16)}function v(e,t,s,r){return _(e,t,s,r,32)}function S(e,t,s,r,n){var i,o,a,c=new Uint32Array(16),h=new Uint32Array(16),u=new Uint32Array(16),l=new Uint32Array(4);for(i=0;i<4;i++)h[5*i]=m(r,4*i),h[1+i]=m(s,4*i),h[6+i]=m(t,4*i),h[11+i]=m(s,16+4*i);for(i=0;i<16;i++)u[i]=h[i];for(i=0;i<20;i++){for(o=0;o<4;o++){for(a=0;a<4;a++)l[a]=h[(5*o+4*a)%16];for(l[1]^=p(l[0]+l[3]|0,7),l[2]^=p(l[1]+l[0]|0,9),l[3]^=p(l[2]+l[1]|0,13),l[0]^=p(l[3]+l[2]|0,18),a=0;a<4;a++)c[4*o+(o+a)%4]=l[a]}for(a=0;a<16;a++)h[a]=c[a]}if(n){for(i=0;i<16;i++)h[i]=h[i]+u[i]|0;for(i=0;i<4;i++)h[5*i]=h[5*i]-m(r,4*i)|0,h[6+i]=h[6+i]-m(t,4*i)|0;for(i=0;i<4;i++)b(e,4*i,h[5*i]),b(e,16+4*i,h[6+i])}else for(i=0;i<16;i++)b(e,4*i,h[i]+u[i]|0)}function E(e,t,s,r){return S(e,t,s,r,!1),0}function k(e,t,s,r){return S(e,t,s,r,!0),0}var x=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function C(e,t,s,r,n,i,o){var a,c,h=new Uint8Array(16),u=new Uint8Array(64);if(!n)return 0;for(c=0;c<16;c++)h[c]=0;for(c=0;c<8;c++)h[c]=i[c];for(;n>=64;){for(E(u,h,o,x),c=0;c<64;c++)e[t+c]=(s?s[r+c]:0)^u[c];for(a=1,c=8;c<16;c++)a=a+(255&h[c])|0,h[c]=255&a,a>>>=8;n-=64,t+=64,s&&(r+=64)}if(n>0)for(E(u,h,o,x),c=0;c<n;c++)e[t+c]=(s?s[r+c]:0)^u[c];return 0}function P(e,t,s,r,n){return C(e,t,null,0,s,r,n)}function I(e,t,s,r,n){var i=new Uint8Array(32);return k(i,r,n,x),P(e,t,s,r.subarray(16),i)}function A(e,t,s,r,n,i,o){var a=new Uint8Array(32);return k(a,i,o,x),C(e,t,s,r,n,i.subarray(16),a)}function O(e,t){var s,r=0;for(s=0;s<17;s++)r=r+(e[s]+t[s]|0)|0,e[s]=255&r,r>>>=8}var j=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function T(e,t,s,r,n,i){var o,a,c,h,u=new Uint32Array(17),l=new Uint32Array(17),d=new Uint32Array(17),f=new Uint32Array(17),p=new Uint32Array(17);for(c=0;c<17;c++)l[c]=d[c]=0;for(c=0;c<16;c++)l[c]=i[c];for(l[3]&=15,l[4]&=252,l[7]&=15,l[8]&=252,l[11]&=15,l[12]&=252,l[15]&=15;n>0;){for(c=0;c<17;c++)f[c]=0;for(c=0;c<16&&c<n;++c)f[c]=s[r+c];for(f[c]=1,r+=c,n-=c,O(d,f),a=0;a<17;a++)for(u[a]=0,c=0;c<17;c++)u[a]=u[a]+d[c]*(c<=a?l[a-c]:320*l[a+17-c]|0)|0;for(a=0;a<17;a++)d[a]=u[a];for(h=0,c=0;c<16;c++)h=h+d[c]|0,d[c]=255&h,h>>>=8;for(h=h+d[16]|0,d[16]=3&h,h=5*(h>>>2)|0,c=0;c<16;c++)h=h+d[c]|0,d[c]=255&h,h>>>=8;h=h+d[16]|0,d[16]=h}for(c=0;c<17;c++)p[c]=d[c];for(O(d,j),o=0|-(d[16]>>>7),c=0;c<17;c++)d[c]^=o&(p[c]^d[c]);for(c=0;c<16;c++)f[c]=i[c+16];for(f[16]=0,O(d,f),c=0;c<16;c++)e[t+c]=d[c];return 0}function N(e,t,s,r,n,i){var o=new Uint8Array(16);return T(o,0,s,r,n,i),y(e,t,o,0)}function M(e,t,s,r,n){var i;if(s<32)return-1;for(A(e,0,t,0,s,r,n),T(e,16,e,32,s-32,e),i=0;i<16;i++)e[i]=0;return 0}function L(e,t,s,r,n){var i,o=new Uint8Array(32);if(s<32)return-1;if(I(o,0,32,r,n),0!==N(t,16,t,32,s-32,o))return-1;for(A(e,0,t,0,s,r,n),i=0;i<32;i++)e[i]=0;return 0}function R(e,t){var s;for(s=0;s<16;s++)e[s]=0|t[s]}function D(e){var t,s;for(s=0;s<16;s++)e[s]+=65536,t=Math.floor(e[s]/65536),e[(s+1)*(s<15?1:0)]+=t-1+37*(t-1)*(15===s?1:0),e[s]-=65536*t}function B(e,t,s){for(var r,n=~(s-1),i=0;i<16;i++)r=n&(e[i]^t[i]),e[i]^=r,t[i]^=r}function $(e,t){var r,n,i,o=s(),a=s();for(r=0;r<16;r++)a[r]=t[r];for(D(a),D(a),D(a),n=0;n<2;n++){for(o[0]=a[0]-65517,r=1;r<15;r++)o[r]=a[r]-65535-(o[r-1]>>16&1),o[r-1]&=65535;o[15]=a[15]-32767-(o[14]>>16&1),i=o[15]>>16&1,o[14]&=65535,B(a,o,1-i)}for(r=0;r<16;r++)e[2*r]=255&a[r],e[2*r+1]=a[r]>>8}function U(e,t){var s=new Uint8Array(32),r=new Uint8Array(32);return $(s,e),$(r,t),v(s,0,r,0)}function F(e){var t=new Uint8Array(32);return $(t,e),1&t[0]}function q(e,t){var s;for(s=0;s<16;s++)e[s]=t[2*s]+(t[2*s+1]<<8);e[15]&=32767}function H(e,t,s){var r;for(r=0;r<16;r++)e[r]=t[r]+s[r]|0}function K(e,t,s){var r;for(r=0;r<16;r++)e[r]=t[r]-s[r]|0}function z(e,t,s){var r,n,i=new Float64Array(31);for(r=0;r<31;r++)i[r]=0;for(r=0;r<16;r++)for(n=0;n<16;n++)i[r+n]+=t[r]*s[n];for(r=0;r<15;r++)i[r]+=38*i[r+16];for(r=0;r<16;r++)e[r]=i[r];D(e),D(e)}function G(e,t){z(e,t,t)}function J(e,t){var r,n=s();for(r=0;r<16;r++)n[r]=t[r];for(r=253;r>=0;r--)G(n,n),2!==r&&4!==r&&z(n,n,t);for(r=0;r<16;r++)e[r]=n[r]}function V(e,t){var r,n=s();for(r=0;r<16;r++)n[r]=t[r];for(r=250;r>=0;r--)G(n,n),1!==r&&z(n,n,t);for(r=0;r<16;r++)e[r]=n[r]}function W(e,t,r){var n,i,o=new Uint8Array(32),a=new Float64Array(80),h=s(),u=s(),l=s(),d=s(),f=s(),p=s();for(i=0;i<31;i++)o[i]=t[i];for(o[31]=127&t[31]|64,o[0]&=248,q(a,r),i=0;i<16;i++)u[i]=a[i],d[i]=h[i]=l[i]=0;for(h[0]=d[0]=1,i=254;i>=0;--i)B(h,u,n=o[i>>>3]>>>(7&i)&1),B(l,d,n),H(f,h,l),K(h,h,l),H(l,u,d),K(u,u,d),G(d,f),G(p,h),z(h,l,h),z(l,u,f),H(f,h,l),K(h,h,l),G(u,h),K(l,d,p),z(h,l,c),H(h,h,d),z(l,l,h),z(h,d,p),z(d,u,a),G(u,f),B(h,u,n),B(l,d,n);for(i=0;i<16;i++)a[i+16]=h[i],a[i+32]=l[i],a[i+48]=u[i],a[i+64]=d[i];var m=a.subarray(32),g=a.subarray(16);return J(m,m),z(g,g,m),$(e,g),0}function Y(e,t){return W(e,t,i)}function Q(e,t){return r(t,32),Y(e,t)}function X(e,t,s){var r=new Uint8Array(32);return W(r,s,t),k(e,n,r,x)}var Z=M,ee=L;function te(){var e,s,r,n=0,i=0,o=0,a=0,c=65535;for(r=0;r<arguments.length;r++)n+=(e=arguments[r].lo)&c,i+=e>>>16,o+=(s=arguments[r].hi)&c,a+=s>>>16;return new t((o+=(i+=n>>>16)>>>16)&c|(a+=o>>>16)<<16,n&c|i<<16)}function se(e,s){return new t(e.hi>>>s,e.lo>>>s|e.hi<<32-s)}function re(){var e,s=0,r=0;for(e=0;e<arguments.length;e++)s^=arguments[e].lo,r^=arguments[e].hi;return new t(r,s)}function ne(e,s){var r,n,i=32-s;return s<32?(r=e.hi>>>s|e.lo<<i,n=e.lo>>>s|e.hi<<i):s<64&&(r=e.lo>>>s|e.hi<<i,n=e.hi>>>s|e.lo<<i),new t(r,n)}function ie(e,s,r){var n=e.hi&s.hi^~e.hi&r.hi,i=e.lo&s.lo^~e.lo&r.lo;return new t(n,i)}function oe(e,s,r){var n=e.hi&s.hi^e.hi&r.hi^s.hi&r.hi,i=e.lo&s.lo^e.lo&r.lo^s.lo&r.lo;return new t(n,i)}function ae(e){return re(ne(e,28),ne(e,34),ne(e,39))}function ce(e){return re(ne(e,14),ne(e,18),ne(e,41))}function he(e){return re(ne(e,1),ne(e,8),se(e,7))}function ue(e){return re(ne(e,19),ne(e,61),se(e,6))}var le=[new t(1116352408,3609767458),new t(1899447441,602891725),new t(3049323471,3964484399),new t(3921009573,2173295548),new t(961987163,4081628472),new t(1508970993,3053834265),new t(2453635748,2937671579),new t(2870763221,3664609560),new t(3624381080,2734883394),new t(310598401,1164996542),new t(607225278,1323610764),new t(1426881987,3590304994),new t(1925078388,4068182383),new t(2162078206,991336113),new t(2614888103,633803317),new t(3248222580,3479774868),new t(3835390401,2666613458),new t(4022224774,944711139),new t(264347078,2341262773),new t(604807628,2007800933),new t(770255983,1495990901),new t(1249150122,1856431235),new t(1555081692,3175218132),new t(1996064986,2198950837),new t(2554220882,3999719339),new t(2821834349,766784016),new t(2952996808,2566594879),new t(3210313671,3203337956),new t(3336571891,1034457026),new t(3584528711,2466948901),new t(113926993,3758326383),new t(338241895,168717936),new t(666307205,1188179964),new t(773529912,1546045734),new t(1294757372,1522805485),new t(1396182291,2643833823),new t(1695183700,2343527390),new t(1986661051,1014477480),new t(2177026350,1206759142),new t(2456956037,344077627),new t(2730485921,1290863460),new t(2820302411,3158454273),new t(3259730800,3505952657),new t(3345764771,106217008),new t(3516065817,3606008344),new t(3600352804,1432725776),new t(4094571909,1467031594),new t(275423344,851169720),new t(430227734,3100823752),new t(506948616,1363258195),new t(659060556,3750685593),new t(883997877,3785050280),new t(958139571,3318307427),new t(1322822218,3812723403),new t(1537002063,2003034995),new t(1747873779,3602036899),new t(1955562222,1575990012),new t(2024104815,1125592928),new t(2227730452,2716904306),new t(2361852424,442776044),new t(2428436474,593698344),new t(2756734187,3733110249),new t(3204031479,2999351573),new t(3329325298,3815920427),new t(3391569614,3928383900),new t(3515267271,566280711),new t(3940187606,3454069534),new t(4118630271,4000239992),new t(116418474,1914138554),new t(174292421,2731055270),new t(289380356,3203993006),new t(460393269,320620315),new t(685471733,587496836),new t(852142971,1086792851),new t(1017036298,365543100),new t(1126000580,2618297676),new t(1288033470,3409855158),new t(1501505948,4234509866),new t(1607167915,987167468),new t(1816402316,1246189591)];function de(e,t,s){var r,n,i,o=[],a=[],c=[],h=[];for(n=0;n<8;n++)o[n]=c[n]=g(e,8*n);for(var u=0;s>=128;){for(n=0;n<16;n++)h[n]=g(t,8*n+u);for(n=0;n<80;n++){for(i=0;i<8;i++)a[i]=c[i];for(r=te(c[7],ce(c[4]),ie(c[4],c[5],c[6]),le[n],h[n%16]),a[7]=te(r,ae(c[0]),oe(c[0],c[1],c[2])),a[3]=te(a[3],r),i=0;i<8;i++)c[(i+1)%8]=a[i];if(n%16==15)for(i=0;i<16;i++)h[i]=te(h[i],h[(i+9)%16],he(h[(i+1)%16]),ue(h[(i+14)%16]))}for(n=0;n<8;n++)c[n]=te(c[n],o[n]),o[n]=c[n];u+=128,s-=128}for(n=0;n<8;n++)w(e,8*n,o[n]);return s}var fe=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function pe(e,s,r){var n,i=new Uint8Array(64),o=new Uint8Array(256),a=r;for(n=0;n<64;n++)i[n]=fe[n];for(de(i,s,r),r%=128,n=0;n<256;n++)o[n]=0;for(n=0;n<r;n++)o[n]=s[a-r+n];for(o[r]=128,o[(r=256-128*(r<112?1:0))-9]=0,w(o,r-8,new t(a/536870912|0,a<<3)),de(i,o,r),n=0;n<64;n++)e[n]=i[n];return 0}function me(e,t){var r=s(),n=s(),i=s(),o=s(),a=s(),c=s(),h=s(),l=s(),d=s();K(r,e[1],e[0]),K(d,t[1],t[0]),z(r,r,d),H(n,e[0],e[1]),H(d,t[0],t[1]),z(n,n,d),z(i,e[3],t[3]),z(i,i,u),z(o,e[2],t[2]),H(o,o,o),K(a,n,r),K(c,o,i),H(h,o,i),H(l,n,r),z(e[0],a,c),z(e[1],l,h),z(e[2],h,c),z(e[3],a,l)}function ge(e,t,s){var r;for(r=0;r<4;r++)B(e[r],t[r],s)}function be(e,t){var r=s(),n=s(),i=s();J(i,t[2]),z(r,t[0],i),z(n,t[1],i),$(e,n),e[31]^=F(r)<<7}function we(e,t,s){var r,n;for(R(e[0],o),R(e[1],a),R(e[2],a),R(e[3],o),n=255;n>=0;--n)ge(e,t,r=s[n/8|0]>>(7&n)&1),me(t,e),me(e,e),ge(e,t,r)}function _e(e,t){var r=[s(),s(),s(),s()];R(r[0],l),R(r[1],d),R(r[2],a),z(r[3],l,d),we(e,r,t)}function ye(e,t,n){var i,o=new Uint8Array(64),a=[s(),s(),s(),s()];for(n||r(t,32),pe(o,t,32),o[0]&=248,o[31]&=127,o[31]|=64,_e(a,o),be(e,a),i=0;i<32;i++)t[i+32]=e[i];return 0}var ve=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function Se(e,t){var s,r,n,i;for(r=63;r>=32;--r){for(s=0,n=r-32,i=r-12;n<i;++n)t[n]+=s-16*t[r]*ve[n-(r-32)],s=Math.floor((t[n]+128)/256),t[n]-=256*s;t[n]+=s,t[r]=0}for(s=0,n=0;n<32;n++)t[n]+=s-(t[31]>>4)*ve[n],s=t[n]>>8,t[n]&=255;for(n=0;n<32;n++)t[n]-=s*ve[n];for(r=0;r<32;r++)t[r+1]+=t[r]>>8,e[r]=255&t[r]}function Ee(e){var t,s=new Float64Array(64);for(t=0;t<64;t++)s[t]=e[t];for(t=0;t<64;t++)e[t]=0;Se(e,s)}function ke(e,t,r,n){var i,o,a=new Uint8Array(64),c=new Uint8Array(64),h=new Uint8Array(64),u=new Float64Array(64),l=[s(),s(),s(),s()];pe(a,n,32),a[0]&=248,a[31]&=127,a[31]|=64;var d=r+64;for(i=0;i<r;i++)e[64+i]=t[i];for(i=0;i<32;i++)e[32+i]=a[32+i];for(pe(h,e.subarray(32),r+32),Ee(h),_e(l,h),be(e,l),i=32;i<64;i++)e[i]=n[i];for(pe(c,e,r+64),Ee(c),i=0;i<64;i++)u[i]=0;for(i=0;i<32;i++)u[i]=h[i];for(i=0;i<32;i++)for(o=0;o<32;o++)u[i+o]+=c[i]*a[o];return Se(e.subarray(32),u),d}function xe(e,t,r,n){var i,c=new Uint8Array(32),u=new Uint8Array(64),l=[s(),s(),s(),s()],d=[s(),s(),s(),s()];if(r<64)return-1;if(function(e,t){var r=s(),n=s(),i=s(),c=s(),u=s(),l=s(),d=s();return R(e[2],a),q(e[1],t),G(i,e[1]),z(c,i,h),K(i,i,e[2]),H(c,e[2],c),G(u,c),G(l,u),z(d,l,u),z(r,d,i),z(r,r,c),V(r,r),z(r,r,i),z(r,r,c),z(r,r,c),z(e[0],r,c),G(n,e[0]),z(n,n,c),U(n,i)&&z(e[0],e[0],f),G(n,e[0]),z(n,n,c),U(n,i)?-1:(F(e[0])===t[31]>>7&&K(e[0],o,e[0]),z(e[3],e[0],e[1]),0)}(d,n))return-1;for(i=0;i<r;i++)e[i]=t[i];for(i=0;i<32;i++)e[i+32]=n[i];if(pe(u,e,r),Ee(u),we(l,d,u),_e(d,t.subarray(32)),me(l,d),be(c,l),r-=64,v(t,0,c,0)){for(i=0;i<r;i++)e[i]=0;return-1}for(i=0;i<r;i++)e[i]=t[i+64];return r}var Ce,Pe=64,Ie=32,Ae=64;function Oe(e,t){if(32!==e.length)throw new Error("bad key size");if(24!==t.length)throw new Error("bad nonce size")}function je(){for(var e=0;e<arguments.length;e++)if(!(arguments[e]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function Te(e){for(var t=0;t<e.length;t++)e[t]=0}e.lowlevel={crypto_core_hsalsa20:k,crypto_stream_xor:A,crypto_stream:I,crypto_stream_salsa20_xor:C,crypto_stream_salsa20:P,crypto_onetimeauth:T,crypto_onetimeauth_verify:N,crypto_verify_16:y,crypto_verify_32:v,crypto_secretbox:M,crypto_secretbox_open:L,crypto_scalarmult:W,crypto_scalarmult_base:Y,crypto_box_beforenm:X,crypto_box_afternm:Z,crypto_box:function(e,t,s,r,n,i){var o=new Uint8Array(32);return X(o,n,i),Z(e,t,s,r,o)},crypto_box_open:function(e,t,s,r,n,i){var o=new Uint8Array(32);return X(o,n,i),ee(e,t,s,r,o)},crypto_box_keypair:Q,crypto_hash:pe,crypto_sign:ke,crypto_sign_keypair:ye,crypto_sign_open:xe,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:16,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:Pe,crypto_sign_PUBLICKEYBYTES:Ie,crypto_sign_SECRETKEYBYTES:Ae,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:s,D:h,L:ve,pack25519:$,unpack25519:q,M:z,A:H,S:G,Z:K,pow2523:V,add:me,set25519:R,modL:Se,scalarmult:we,scalarbase:_e},e.randomBytes=function(e){var t=new Uint8Array(e);return r(t,e),t},e.secretbox=function(e,t,s){je(e,t,s),Oe(s,t);for(var r=new Uint8Array(32+e.length),n=new Uint8Array(r.length),i=0;i<e.length;i++)r[i+32]=e[i];return M(n,r,r.length,t,s),n.subarray(16)},e.secretbox.open=function(e,t,s){je(e,t,s),Oe(s,t);for(var r=new Uint8Array(16+e.length),n=new Uint8Array(r.length),i=0;i<e.length;i++)r[i+16]=e[i];return r.length<32||0!==L(n,r,r.length,t,s)?null:n.subarray(32)},e.secretbox.keyLength=32,e.secretbox.nonceLength=24,e.secretbox.overheadLength=16,e.scalarMult=function(e,t){if(je(e,t),32!==e.length)throw new Error("bad n size");if(32!==t.length)throw new Error("bad p size");var s=new Uint8Array(32);return W(s,e,t),s},e.scalarMult.base=function(e){if(je(e),32!==e.length)throw new Error("bad n size");var t=new Uint8Array(32);return Y(t,e),t},e.scalarMult.scalarLength=32,e.scalarMult.groupElementLength=32,e.box=function(t,s,r,n){var i=e.box.before(r,n);return e.secretbox(t,s,i)},e.box.before=function(e,t){je(e,t),function(e,t){if(32!==e.length)throw new Error("bad public key size");if(32!==t.length)throw new Error("bad secret key size")}(e,t);var s=new Uint8Array(32);return X(s,e,t),s},e.box.after=e.secretbox,e.box.open=function(t,s,r,n){var i=e.box.before(r,n);return e.secretbox.open(t,s,i)},e.box.open.after=e.secretbox.open,e.box.keyPair=function(){var e=new Uint8Array(32),t=new Uint8Array(32);return Q(e,t),{publicKey:e,secretKey:t}},e.box.keyPair.fromSecretKey=function(e){if(je(e),32!==e.length)throw new Error("bad secret key size");var t=new Uint8Array(32);return Y(t,e),{publicKey:t,secretKey:new Uint8Array(e)}},e.box.publicKeyLength=32,e.box.secretKeyLength=32,e.box.sharedKeyLength=32,e.box.nonceLength=24,e.box.overheadLength=e.secretbox.overheadLength,e.sign=function(e,t){if(je(e,t),t.length!==Ae)throw new Error("bad secret key size");var s=new Uint8Array(Pe+e.length);return ke(s,e,e.length,t),s},e.sign.open=function(e,t){if(je(e,t),t.length!==Ie)throw new Error("bad public key size");var s=new Uint8Array(e.length),r=xe(s,e,e.length,t);if(r<0)return null;for(var n=new Uint8Array(r),i=0;i<n.length;i++)n[i]=s[i];return n},e.sign.detached=function(t,s){for(var r=e.sign(t,s),n=new Uint8Array(Pe),i=0;i<n.length;i++)n[i]=r[i];return n},e.sign.detached.verify=function(e,t,s){if(je(e,t,s),t.length!==Pe)throw new Error("bad signature size");if(s.length!==Ie)throw new Error("bad public key size");var r,n=new Uint8Array(Pe+e.length),i=new Uint8Array(Pe+e.length);for(r=0;r<Pe;r++)n[r]=t[r];for(r=0;r<e.length;r++)n[r+Pe]=e[r];return xe(i,n,n.length,s)>=0},e.sign.keyPair=function(){var e=new Uint8Array(Ie),t=new Uint8Array(Ae);return ye(e,t),{publicKey:e,secretKey:t}},e.sign.keyPair.fromSecretKey=function(e){if(je(e),e.length!==Ae)throw new Error("bad secret key size");for(var t=new Uint8Array(Ie),s=0;s<t.length;s++)t[s]=e[32+s];return{publicKey:t,secretKey:new Uint8Array(e)}},e.sign.keyPair.fromSeed=function(e){if(je(e),32!==e.length)throw new Error("bad seed size");for(var t=new Uint8Array(Ie),s=new Uint8Array(Ae),r=0;r<32;r++)s[r]=e[r];return ye(t,s,!0),{publicKey:t,secretKey:s}},e.sign.publicKeyLength=Ie,e.sign.secretKeyLength=Ae,e.sign.seedLength=32,e.sign.signatureLength=Pe,e.hash=function(e){je(e);var t=new Uint8Array(64);return pe(t,e,e.length),t},e.hash.hashLength=64,e.verify=function(e,t){return je(e,t),0!==e.length&&0!==t.length&&e.length===t.length&&0===_(e,0,t,0,e.length)},e.setPRNG=function(e){r=e},(Ce="undefined"!=typeof globalThis?globalThis.crypto||globalThis.msCrypto:null)&&Ce.getRandomValues?e.setPRNG((function(e,t){var s,r=new Uint8Array(t);for(s=0;s<t;s+=65536)Ce.getRandomValues(r.subarray(s,s+Math.min(t-s,65536)));for(s=0;s<t;s++)e[s]=r[s];Te(r)})):"undefined"!=typeof require&&(Ce=require("crypto"))&&Ce.randomBytes&&e.setPRNG((function(e,t){var s,r=Ce.randomBytes(t);for(s=0;s<t;s++)e[s]=r[s];Te(r)}))}("undefined"!=typeof module&&module.exports?module.exports:globalThis.nacl=globalThis.nacl||{});const os="undefined"!=typeof module&&module.exports?module.exports:globalThis.nacl,as={fromSeed:os.sign.keyPair.fromSeed,sign:os.sign.detached,verify:os.sign.detached.verify,randomBytes:os.randomBytes};let cs;function hs(){return cs}const us=new Uint16Array([0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920]);class ls{static checksum(e){let t=0;for(let s=0;s<e.byteLength;s++){let r=e[s];t=t<<8&65535^us[255&(t>>8^r)]}return t}static validate(e,t){return ls.checksum(e)==t}}const ds="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";class fs{static encode(e){let t=0,s=0,r=new Uint8Array(e),n=new Uint8Array(2*e.byteLength),i=0;for(let e=0;e<r.byteLength;e++)for(s=s<<8|r[e],t+=8;t>=5;){let e=s>>>t-5&31;n[i++]=ds.charAt(e).charCodeAt(0),t-=5}if(t>0){let e=s<<5-t&31;n[i++]=ds.charAt(e).charCodeAt(0)}return n.slice(0,i)}static decode(e){let t=0,s=0,r=0,n=new Uint8Array(e),i=new Uint8Array(5*n.byteLength/8|0);for(let e=0;e<n.byteLength;e++){let o=String.fromCharCode(n[e]),a=ds.indexOf(o);if(-1===a)throw new Error("Illegal Base32 character: "+n[e]);s=s<<5|a,t+=5,t>=8&&(i[r++]=s>>>t-8&255,t-=8)}return i.slice(0,r)}}class ps extends Error{name;code;chainedError;constructor(e,t){super(e),this.name="NKeysError",this.code=e,this.chainedError=t}}var ms,gs;!function(e){e.InvalidPrefixByte="nkeys: invalid prefix byte",e.InvalidKey="nkeys: invalid key",e.InvalidPublicKey="nkeys: invalid public key",e.InvalidSeedLen="nkeys: invalid seed length",e.InvalidSeed="nkeys: invalid seed",e.InvalidEncoding="nkeys: invalid encoded key",e.InvalidSignature="nkeys: signature verification failed",e.CannotSign="nkeys: cannot sign, no private key available",e.PublicKeyOnly="nkeys: no seed or private key available",e.InvalidChecksum="nkeys: invalid checksum",e.SerializationError="nkeys: serialization error",e.ApiError="nkeys: api error",e.ClearedPair="nkeys: pair is cleared"}(ms||(ms={})),function(e){e[e.Seed=144]="Seed",e[e.Private=120]="Private",e[e.Operator=112]="Operator",e[e.Server=104]="Server",e[e.Cluster=16]="Cluster",e[e.Account=0]="Account",e[e.User=160]="User"}(gs||(gs={}));class bs{static isValidPublicPrefix(e){return e==gs.Server||e==gs.Operator||e==gs.Cluster||e==gs.Account||e==gs.User}static startsWithValidPrefix(e){let t=e[0];return"S"==t||"P"==t||"O"==t||"N"==t||"C"==t||"A"==t||"U"==t}static isValidPrefix(e){return-1!=this.parsePrefix(e)}static parsePrefix(e){switch(e){case gs.Seed:return gs.Seed;case gs.Private:return gs.Private;case gs.Operator:return gs.Operator;case gs.Server:return gs.Server;case gs.Cluster:return gs.Cluster;case gs.Account:return gs.Account;case gs.User:return gs.User;default:return-1}}}class ws{static encode(e,t){if(!(t&&t instanceof Uint8Array))throw new ps(ms.SerializationError);if(!bs.isValidPrefix(e))throw new ps(ms.InvalidPrefixByte);return ws._encode(!1,e,t)}static encodeSeed(e,t){if(!t)throw new ps(ms.ApiError);if(!bs.isValidPublicPrefix(e))throw new ps(ms.InvalidPrefixByte);if(32!==t.byteLength)throw new ps(ms.InvalidSeedLen);return ws._encode(!0,e,t)}static decode(e,t){if(!bs.isValidPrefix(e))throw new ps(ms.InvalidPrefixByte);const s=ws._decode(t);if(s[0]!==e)throw new ps(ms.InvalidPrefixByte);return s.slice(1)}static decodeSeed(e){const t=ws._decode(e),s=ws._decodePrefix(t);if(s[0]!=gs.Seed)throw new ps(ms.InvalidSeed);if(!bs.isValidPublicPrefix(s[1]))throw new ps(ms.InvalidPrefixByte);return{buf:t.slice(2),prefix:s[1]}}static _encode(e,t,s){const r=e?2:1,n=s.byteLength,i=r+n,o=new Uint8Array(r+n+2);if(e){const e=ws._encodePrefix(gs.Seed,t);o.set(e)}else o[0]=t;o.set(s,r);const a=ls.checksum(o.slice(0,i));return new DataView(o.buffer).setUint16(i,a,!0),fs.encode(o)}static _decode(e){if(e.byteLength<4)throw new ps(ms.InvalidEncoding);let t;try{t=fs.decode(e)}catch(e){throw new ps(ms.InvalidEncoding,e)}const s=t.byteLength-2,r=new DataView(t.buffer).getUint16(s,!0),n=t.slice(0,s);if(!ls.validate(n,r))throw new ps(ms.InvalidChecksum);return n}static _encodePrefix(e,t){return new Uint8Array([e|t>>5,(31&t)<<3])}static _decodePrefix(e){const t=248&e[0],s=(7&e[0])<<5|(248&e[1])>>3;return new Uint8Array([t,s])}}class _s{seed;constructor(e){this.seed=e}getRawSeed(){if(!this.seed)throw new ps(ms.ClearedPair);return ws.decodeSeed(this.seed).buf}getSeed(){if(!this.seed)throw new ps(ms.ClearedPair);return this.seed}getPublicKey(){if(!this.seed)throw new ps(ms.ClearedPair);const e=ws.decodeSeed(this.seed),t=hs().fromSeed(this.getRawSeed()),s=ws.encode(e.prefix,t.publicKey);return(new TextDecoder).decode(s)}getPrivateKey(){if(!this.seed)throw new ps(ms.ClearedPair);const e=hs().fromSeed(this.getRawSeed());return ws.encode(gs.Private,e.secretKey)}sign(e){if(!this.seed)throw new ps(ms.ClearedPair);const t=hs().fromSeed(this.getRawSeed());return hs().sign(e,t.secretKey)}verify(e,t){if(!this.seed)throw new ps(ms.ClearedPair);const s=hs().fromSeed(this.getRawSeed());return hs().verify(e,t,s.publicKey)}clear(){this.seed&&(this.seed.fill(0),this.seed=void 0)}}function ys(e){const t=hs().randomBytes(32);let s=ws.encodeSeed(e,new Uint8Array(t));return new _s(s)}class vs{publicKey;constructor(e){this.publicKey=e}getPublicKey(){if(!this.publicKey)throw new ps(ms.ClearedPair);return(new TextDecoder).decode(this.publicKey)}getPrivateKey(){if(!this.publicKey)throw new ps(ms.ClearedPair);throw new ps(ms.PublicKeyOnly)}getSeed(){if(!this.publicKey)throw new ps(ms.ClearedPair);throw new ps(ms.PublicKeyOnly)}sign(e){if(!this.publicKey)throw new ps(ms.ClearedPair);throw new ps(ms.CannotSign)}verify(e,t){if(!this.publicKey)throw new ps(ms.ClearedPair);let s=ws._decode(this.publicKey);return hs().verify(e,t,s.slice(1))}clear(){this.publicKey&&(this.publicKey.fill(0),this.publicKey=void 0)}}cs=as;const Ss={createAccount:function(){return ys(gs.Account)},createOperator:function(){return ys(gs.Operator)},createPair:ys,createUser:function(){return ys(gs.User)},fromPublic:function(e){const t=(new TextEncoder).encode(e),s=ws._decode(t),r=bs.parsePrefix(s[0]);if(bs.isValidPublicPrefix(r))return new vs(t);throw new ps(ms.InvalidPublicKey)},fromSeed:function(e){return ws.decodeSeed(e),new _s(e)},NKeysError:ps,NKeysErrorCode:ms,Prefix:gs,decode:function(e){const t=atob(e),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s},encode:function(e){return btoa(String.fromCharCode(...e))}};function Es(e){const t="function"!=typeof e?()=>e:e,s=()=>{const e=/\s*(?:(?:[-]{3,}[^\n]*[-]{3,}\n)(.+)(?:\n\s*[-]{3,}[^\n]*[-]{3,}\n))/gi,s=G.decode(t());let r=e.exec(s);if(!r)throw re.errorForCode(Z.BadCreds);const n=r[1].trim();if(r=e.exec(s),!r)throw re.errorForCode(Z.BadCreds);if(!r)throw re.errorForCode(Z.BadCreds);return{jwt:n,seed:z.encode(r[1].trim())}};return r=()=>{const{jwt:e}=s();return e},n=()=>{const{seed:e}=s();return e},e=>{const t="function"==typeof r?r():r,s=function(e){return t=>{const s="function"==typeof e?e():e,r=s?Ss.fromSeed(s):void 0,n=r?r.getPublicKey():"",i=z.encode(t||""),o=void 0!==r&&t?r.sign(i):void 0;return{nkey:n,sig:o?Ss.encode(o):""}}}(n),{nkey:i,sig:o}=s(e);return{jwt:t,nkey:i,sig:o}};var r,n}const ks=12e4;function xs(e){const t=`${le}:${jt()}`;if((e=e||{servers:[t]}).servers=e.servers||[],"string"==typeof e.servers&&(e.servers=[e.servers]),e.servers.length>0&&e.port)throw new re("port and servers options are mutually exclusive",Z.InvalidOption);0===e.servers.length&&e.port&&(e.servers=[`${le}:${e.port}`]),e.servers&&0===e.servers.length&&(e.servers=[t]);const s=fe({maxPingOut:2,maxReconnectAttempts:10,noRandomize:!1,pedantic:!1,pingInterval:ks,reconnect:!0,reconnectJitter:100,reconnectJitterTLS:1e3,reconnectTimeWait:2e3,tls:void 0,verbose:!1,waitOnFirstConnect:!1,ignoreAuthErrorAbort:!1},e);if(s.authenticator=function(e){const t=[];var s,r,n,i;return"function"==typeof e.authenticator&&t.push(e.authenticator),Array.isArray(e.authenticator)&&t.push(...e.authenticator),e.token&&t.push((s=e.token,()=>({auth_token:"function"==typeof s?s():s}))),e.user&&t.push((r=e.user,n=e.pass,()=>({user:"function"==typeof r?r():r,pass:"function"==typeof n?n():n}))),0===t.length?()=>{}:(i=t,e=>{let t={};return i.forEach((s=>{const r=s(e)||{};t=Object.assign(t,r)})),t})}(s),["reconnectDelayHandler","authenticator"].forEach((e=>{if(s[e]&&"function"!=typeof s[e])throw new re(`${e} option should be a function`,Z.NotFunction)})),s.reconnectDelayHandler||(s.reconnectDelayHandler=()=>{let e=s.tls?s.reconnectJitterTLS:s.reconnectJitter;return e&&(e++,e=Math.floor(Math.random()*e)),s.reconnectTimeWait+e}),s.inboxPrefix)try{ue(s.inboxPrefix)}catch(e){throw new re(e.message,Z.ApiError)}if(s.resolve&&"function"!=typeof Nt())throw new re("'resolve' is not supported on this client",Z.InvalidOption);return s}const Cs=/^INFO\s+([^\r\n]+)\r\n/i,Ps=J("PONG\r\n"),Is=J("PING\r\n");class As{echo;no_responders;protocol;verbose;pedantic;jwt;nkey;sig;user;pass;auth_token;tls_required;name;lang;version;headers;constructor(e,t,s){this.protocol=1,this.version=e.version,this.lang=e.lang,this.echo=!t.noEcho&&void 0,this.verbose=t.verbose,this.pedantic=t.pedantic,this.tls_required=!!t.tls||void 0,this.name=t.name,fe(this,(t&&"function"==typeof t.authenticator?t.authenticator(s):{})||{})}}class Os extends Ue{sid;queue;draining;max;subject;drained;protocol;timer;info;cleanupFn;closed;requestSubject;constructor(e,t,s={}){super(),fe(this,s),this.protocol=e,this.subject=t,this.draining=!1,this.noIterator="function"==typeof s.callback,this.closed=be();const r=!e.options?.noAsyncTraces;s.timeout&&(this.timer=me(s.timeout,r),this.timer.then((()=>{this.timer=void 0})).catch((e=>{this.stop(e),this.noIterator&&this.callback(e,{})}))),this.noIterator||this.iterClosed.then((()=>{this.closed.resolve(),this.unsubscribe()}))}setPrePostHandlers(e){if(this.noIterator){const t=this.callback,s=e.ingestionFilterFn?e.ingestionFilterFn:()=>({ingest:!0,protocol:!1}),r=e.protocolFilterFn?e.protocolFilterFn:()=>!0,n=e.dispatchedFn?e.dispatchedFn:()=>{};this.callback=(e,i)=>{const{ingest:o}=s(i);o&&r(i)&&(t(e,i),n(i))}}else this.protocolFilterFn=e.protocolFilterFn,this.dispatchedFn=e.dispatchedFn}callback(e,t){this.cancelTimeout(),e?this.stop(e):this.push(t)}close(){if(!this.isClosed()){this.cancelTimeout();const e=()=>{if(this.stop(),this.cleanupFn)try{this.cleanupFn(this,this.info)}catch(e){}this.closed.resolve()};this.noIterator?e():this.push(e)}}unsubscribe(e){this.protocol.unsubscribe(this,e)}cancelTimeout(){this.timer&&(this.timer.cancel(),this.timer=void 0)}drain(){return this.protocol.isClosed()?Promise.reject(re.errorForCode(Z.ConnectionClosed)):this.isClosed()?Promise.reject(re.errorForCode(Z.SubClosed)):(this.drained||(this.draining=!0,this.protocol.unsub(this),this.drained=this.protocol.flush(be()).then((()=>{this.protocol.subscriptions.cancel(this)})).catch((()=>{this.protocol.subscriptions.cancel(this)}))),this.drained)}isDraining(){return this.draining}isClosed(){return this.done}getSubject(){return this.subject}getMax(){return this.max}getID(){return this.sid}}class js{mux;subs;sidCounter;constructor(){this.sidCounter=0,this.mux=null,this.subs=new Map}size(){return this.subs.size}add(e){return this.sidCounter++,e.sid=this.sidCounter,this.subs.set(e.sid,e),e}setMux(e){return this.mux=e,e}getMux(){return this.mux}get(e){return this.subs.get(e)}resub(e){return this.sidCounter++,this.subs.delete(e.sid),e.sid=this.sidCounter,this.subs.set(e.sid,e),e}all(){return Array.from(this.subs.values())}cancel(e){e&&(e.close(),this.subs.delete(e.sid))}handleError(e){if(e&&e.permissionContext){const t=e.permissionContext,s=this.all();let r;if("subscription"===t.operation&&(r=s.find((e=>e.subject===t.subject))),"publish"===t.operation&&(r=s.find((e=>e.requestSubject===t.subject))),r)return r.callback(e,{}),r.close(),this.subs.delete(r.sid),r!==this.mux}return!1}close(){this.subs.forEach((e=>{e.close()}))}}class Ts{connected;connectedOnce;infoReceived;info;muxSubscriptions;options;outbound;pongs;subscriptions;transport;noMorePublishing;connectError;publisher;_closed;closed;listeners;heartbeats;parser;outMsgs;inMsgs;outBytes;inBytes;pendingLimit;lastError;abortReconnect;whyClosed;servers;server;features;connectPromise;constructor(e,t){this._closed=!1,this.connected=!1,this.connectedOnce=!1,this.infoReceived=!1,this.noMorePublishing=!1,this.abortReconnect=!1,this.listeners=[],this.pendingLimit=32768,this.outMsgs=0,this.inMsgs=0,this.outBytes=0,this.inBytes=0,this.options=e,this.publisher=t,this.subscriptions=new js,this.muxSubscriptions=new Yt,this.outbound=new at,this.pongs=[],this.whyClosed="",this.pendingLimit=e.pendingLimit||this.pendingLimit,this.features=new Ct({major:0,minor:0,micro:0}),this.connectPromise=null;const s="string"==typeof e.servers?[e.servers]:e.servers;this.servers=new Wt(s,{randomize:!e.noRandomize}),this.closed=be(),this.parser=new is(this),this.heartbeats=new Qt(this,this.options.pingInterval||ks,this.options.maxPingOut||2)}resetOutbound(){this.outbound.reset();const e=this.pongs;this.pongs=[];const t=re.errorForCode(Z.Disconnect);t.stack="",e.forEach((e=>{e.reject(t)})),this.parser=new is(this),this.infoReceived=!1}dispatchStatus(e){this.listeners.forEach((t=>{t.push(e)}))}status(){const e=new Ue;return this.listeners.push(e),e}prepare(){this.transport&&this.transport.discard(),this.info=void 0,this.resetOutbound();const e=be();return e.catch((()=>{})),this.pongs.unshift(e),this.connectError=t=>{e.reject(t)},this.transport=function(){if(!Ot||"function"!=typeof Ot.factory)throw new Error("transport fn is not set");return Ot.factory()}(),this.transport.closed().then((async e=>{this.connected=!1,this.isClosed()||await this.disconnected(this.transport.closeError||this.lastError)})),e}disconnect(){this.dispatchStatus({type:X.StaleConnection,data:""}),this.transport.disconnect()}reconnect(){return this.connected&&(this.dispatchStatus({type:X.ClientInitiatedReconnect,data:""}),this.transport.disconnect()),Promise.resolve()}async disconnected(e){this.dispatchStatus({type:Q.Disconnect,data:this.servers.getCurrentServer().toString()}),this.options.reconnect?await this.dialLoop().then((()=>{this.dispatchStatus({type:Q.Reconnect,data:this.servers.getCurrentServer().toString()}),this.lastError?.code===Z.AuthenticationExpired&&(this.lastError=void 0)})).catch((e=>{this._close(e)})):await this._close(e)}async dial(e){const t=this.prepare();let s;try{s=me(this.options.timeout||2e4);const t=this.transport.connect(e,this.options);await Promise.race([t,s]),(async()=>{try{for await(const e of this.transport)this.parser.parse(e)}catch(e){console.log("reader closed",e)}})().then()}catch(e){t.reject(e)}try{await Promise.race([s,t]),s&&s.cancel(),this.connected=!0,this.connectError=void 0,this.sendSubscriptions(),this.connectedOnce=!0,this.server.didConnect=!0,this.server.reconnects=0,this.flushPending(),this.heartbeats.start()}catch(e){throw s&&s.cancel(),await this.transport.close(e),e}}async _doDial(e){const t=await e.resolve({fn:Nt(),debug:this.options.debug,randomize:!this.options.noRandomize});let s=null;for(const e of t)try{return s=null,this.dispatchStatus({type:X.Reconnecting,data:e.toString()}),void await this.dial(e)}catch(e){s=e}throw s}dialLoop(){return null===this.connectPromise&&(this.connectPromise=this.dodialLoop(),this.connectPromise.then((()=>{})).catch((()=>{})).finally((()=>{this.connectPromise=null}))),this.connectPromise}async dodialLoop(){let e;for(;;){this._closed&&this.servers.clear();const t=this.options.reconnectDelayHandler?this.options.reconnectDelayHandler():2e3;let s=t;const r=this.selectServer();if(!r||this.abortReconnect)throw e||(this.lastError?this.lastError:re.errorForCode(Z.ConnectionRefused));const n=Date.now();if(0===r.lastConnect||r.lastConnect+t<=n){r.lastConnect=Date.now();try{await this._doDial(r);break}catch(t){if(e=t,!this.connectedOnce){if(this.options.waitOnFirstConnect)continue;this.servers.removeCurrentServer()}r.reconnects++;const s=this.options.maxReconnectAttempts||0;-1!==s&&r.reconnects>=s&&this.servers.removeCurrentServer()}}else s=Math.min(s,r.lastConnect+t-n),await ge(s)}}static async connect(e,t){const s=new Ts(e,t);return await s.dialLoop(),s}static toError(e){const t=e?e.toLowerCase():"";if(-1!==t.indexOf("permissions violation")){const t=new re(e,Z.PermissionsViolation),s=e.match(/(Publish|Subscription) to "(\S+)"/);return s&&(t.permissionContext={operation:s[1].toLowerCase(),subject:s[2]}),t}return-1!==t.indexOf("authorization violation")?new re(e,Z.AuthorizationViolation):-1!==t.indexOf("user authentication expired")?new re(e,Z.AuthenticationExpired):-1!==t.indexOf("authentication timeout")?new re(e,Z.AuthenticationTimeout):new re(e,Z.ProtocolError)}processMsg(e,t){if(this.inMsgs++,this.inBytes+=t.length,!this.subscriptions.sidCounter)return;const s=this.subscriptions.get(e.sid);s&&(s.received+=1,s.callback&&s.callback(null,new Ae(e,t,this)),void 0!==s.max&&s.received>=s.max&&s.unsubscribe())}processError(e){const t=V(e),s=Ts.toError(t),r={type:Q.Error,data:s.code};if(s.isPermissionError()){let e=!1;if(s.permissionContext){r.permissionContext=s.permissionContext;const t=this.subscriptions.getMux();e=t?.subject===s.permissionContext.subject}this.subscriptions.handleError(s),this.muxSubscriptions.handleError(e,s),e&&this.subscriptions.setMux(null)}this.dispatchStatus(r),this.handleError(s)}handleError(e){e.isAuthError()?this.handleAuthError(e):(e.isProtocolError()||e.isAuthTimeout())&&(this.lastError=e),e.isPermissionError()||(this.lastError=e)}handleAuthError(e){this.lastError&&e.code===this.lastError.code&&!1===this.options.ignoreAuthErrorAbort&&(this.abortReconnect=!0),this.connectError?this.connectError(e):this.disconnect()}processPing(){this.transport.send(Ps)}processPong(){const e=this.pongs.shift();e&&e.resolve()}processInfo(e){const t=JSON.parse(V(e));this.info=t;const s=this.options&&this.options.ignoreClusterUpdates?void 0:this.servers.update(t,this.transport.isEncrypted());if(!this.infoReceived){this.features.update(Et(t.version)),this.infoReceived=!0,this.transport.isEncrypted()&&this.servers.updateTLSName();const{version:e,lang:s}=this.transport;try{const r=new As({version:e,lang:s},this.options,t.nonce);t.headers&&(r.headers=!0,r.no_responders=!0);const n=JSON.stringify(r);this.transport.send(J(`CONNECT ${n}${Mt}`)),this.transport.send(Is)}catch(e){this._close(e)}}s&&this.dispatchStatus({type:Q.Update,data:s}),void 0!==t.ldm&&t.ldm&&this.dispatchStatus({type:Q.LDM,data:this.servers.getCurrentServer().toString()})}push(e){switch(e.kind){case ss.MSG:{const{msg:t,data:s}=e;this.processMsg(t,s);break}case ss.OK:break;case ss.ERR:this.processError(e.data);break;case ss.PING:this.processPing();break;case ss.PONG:this.processPong();break;case ss.INFO:this.processInfo(e.data)}}sendCommand(e,...t){const s=this.outbound.length();let r;r="string"==typeof e?J(e):e,this.outbound.fill(r,...t),0===s?queueMicrotask((()=>{this.flushPending()})):this.outbound.size()>=this.pendingLimit&&this.flushPending()}publish(e,t=K,s){let r;if(t instanceof Uint8Array)r=t;else{if("string"!=typeof t)throw re.errorForCode(Z.BadPayload);r=z.encode(t)}let n=r.length;(s=s||{}).reply=s.reply||"";let i,o=K,a=0;if(s.headers){if(this.info&&!this.info.headers)throw new re("headers",Z.ServerOptionNotAvailable);o=s.headers.encode(),a=o.length,n=r.length+a}if(this.info&&n>this.info.max_payload)throw re.errorForCode(Z.MaxPayloadExceeded);this.outBytes+=n,this.outMsgs++,s.headers?(i=s.reply?`HPUB ${e} ${s.reply} ${a} ${n}\r\n`:`HPUB ${e} ${a} ${n}\r\n`,this.sendCommand(i,o,r,Lt)):(i=s.reply?`PUB ${e} ${s.reply} ${n}\r\n`:`PUB ${e} ${n}\r\n`,this.sendCommand(i,r,Lt))}request(e){return this.initMux(),this.muxSubscriptions.add(e),e}subscribe(e){return this.subscriptions.add(e),this._subunsub(e),e}_sub(e){e.queue?this.sendCommand(`SUB ${e.subject} ${e.queue} ${e.sid}\r\n`):this.sendCommand(`SUB ${e.subject} ${e.sid}\r\n`)}_subunsub(e){return this._sub(e),e.max&&this.unsubscribe(e,e.max),e}unsubscribe(e,t){this.unsub(e,t),(void 0===e.max||e.received>=e.max)&&this.subscriptions.cancel(e)}unsub(e,t){e&&!this.isClosed()&&(t?this.sendCommand(`UNSUB ${e.sid} ${t}\r\n`):this.sendCommand(`UNSUB ${e.sid}\r\n`),e.max=t)}resub(e,t){e&&!this.isClosed()&&(this.unsub(e),e.subject=t,this.subscriptions.resub(e),this._sub(e))}flush(e){return e||(e=be()),this.pongs.push(e),this.outbound.fill(Is),this.flushPending(),e}sendSubscriptions(){const e=[];this.subscriptions.all().forEach((t=>{const s=t;s.queue?e.push(`SUB ${s.subject} ${s.queue} ${s.sid}${Mt}`):e.push(`SUB ${s.subject} ${s.sid}${Mt}`)})),e.length&&this.transport.send(J(e.join("")))}async _close(e){this._closed||(this.whyClosed=new Error("close trace").stack||"",this.heartbeats.cancel(),this.connectError&&(this.connectError(e),this.connectError=void 0),this.muxSubscriptions.close(),this.subscriptions.close(),this.listeners.forEach((e=>{e.stop()})),this._closed=!0,await this.transport.close(e),await this.closed.resolve(e))}close(){return this._close()}isClosed(){return this._closed}drain(){const e=this.subscriptions.all(),t=[];return e.forEach((e=>{t.push(e.drain())})),Promise.all(t).then((async()=>(this.noMorePublishing=!0,await this.flush(),this.close()))).catch((()=>{}))}flushPending(){if(this.infoReceived&&this.connected&&this.outbound.size()){const e=this.outbound.drain();this.transport.send(e)}}initMux(){if(!this.subscriptions.getMux()){const e=this.muxSubscriptions.init(this.options.inboxPrefix),t=new Os(this,`${e}*`);t.callback=this.muxSubscriptions.dispatcher(),this.subscriptions.setMux(t),this.subscribe(t)}}selectServer(){const e=this.servers.selectServer();if(void 0!==e)return this.server=e,this.server}getServer(){return this.server}}class Ns{msg;constructor(e){this.msg=e}get data(){return this.msg.data}get sid(){return this.msg.sid}get subject(){return this.msg.subject}get reply(){return this.msg.reply||""}get headers(){return this.msg.headers}respond(e,t){return this.msg.respond(e,t)}respondError(e,t,s,r){return(r=r||{}).headers=r.headers||Ee(),r.headers?.set(ce,`${e}`),r.headers?.set(ae,t),this.msg.respond(s,r)}json(e){return this.msg.json(e)}string(){return this.msg.string()}}class Ms{subject;queue;srv;constructor(e,t="",s=""){""!==t&&function(e,t){if(-1!==t.indexOf(" "))throw new Error(`${e} cannot contain spaces: '${t}'`);t.split(".").forEach((s=>{if(">"===s)throw new Error(`${e} name cannot contain internal '>': '${t}'`)}))}("service group",t);let r="";if(e instanceof Ls)this.srv=e,r="";else{if(!(e instanceof Ms))throw new Error("unknown ServiceGroup type");{const t=e;this.srv=t.srv,""===s&&""!==t.queue&&(s=t.queue),r=t.subject}}this.subject=this.calcSubject(r,t),this.queue=s}calcSubject(e,t=""){return""===t?e:""!==e?`${e}.${t}`:t}addEndpoint(e="",t){const s="function"==typeof(t=t||{subject:e})?{handler:t,subject:e}:t;Ne("endpoint",e);let{subject:r,handler:n,metadata:i,queue:o}=s;r=r||e,o=o||this.queue,function(e,t){if(""===t)throw new Error(`${e} cannot be empty`);if(-1!==t.indexOf(" "))throw new Error(`${e} cannot contain spaces: '${t}'`);const s=t.split(".");s.forEach(((r,n)=>{if(">"===r&&n!==s.length-1)throw new Error(`${e} cannot have internal '>': '${t}'`)}))}("endpoint subject",r),r=this.calcSubject(this.subject,r);const a={name:e,subject:r,queue:o,handler:n,metadata:i};return this.srv._addEndpoint(a)}addGroup(e="",t=""){return new Ms(this,e,t)}}class Ls{nc;_id;config;handlers;internal;_stopped;_done;started;static controlSubject(e,t="",s="",r){const n=r??"$SRV";return""===t&&""===s?`${n}.${e}`:(Ne("control subject name",t),""!==s?(Ne("control subject id",s),`${n}.${e}.${t}.${s}`):`${n}.${e}.${t}`)}constructor(e,t={name:"",version:""}){this.nc=e,this.config=Object.assign({},t),this.config.queue||(this.config.queue="q"),Ne("name",this.config.name),Ne("queue",this.config.queue),Et(this.config.version),this._id=Y.next(),this.internal=[],this._done=be(),this._stopped=!1,this.handlers=[],this.started=(new Date).toISOString(),this.reset(),this.nc.closed().then((()=>{this.close().catch()})).catch((e=>{this.close(e).catch()}))}get subjects(){return this.handlers.filter((e=>!1===e.internal)).map((e=>e.subject))}get id(){return this._id}get name(){return this.config.name}get description(){return this.config.description??""}get version(){return this.config.version}get metadata(){return this.config.metadata}errorToHeader(e){const t=Ee();if(e instanceof he){const s=e;t.set(ae,s.message),t.set(ce,`${s.code}`)}else t.set(ae,e.message),t.set(ce,"500");return t}setupHandler(e,t=!1){const s=t?"":e.queue?e.queue:this.config.queue,{name:r,subject:n,handler:i}=e,o=e;o.internal=t,t&&this.internal.push(o),o.stats=new Rs(r,n,s),o.queue=s;const a=i?(e,t)=>{if(e)return void this.close(e);const s=Date.now();try{i(e,new Ns(t))}catch(e){o.stats.countError(e),t?.respond(K,{headers:this.errorToHeader(e)})}finally{o.stats.countLatency(s)}}:void 0;return o.sub=this.nc.subscribe(n,{callback:a,queue:s}),o.sub.closed.then((()=>{this._stopped||this.close(new Error(`required subscription ${e.subject} stopped`)).catch()})).catch((t=>{if(!this._stopped){const s=new Error(`required subscription ${e.subject} errored: ${t.message}`);s.stack=t.stack,this.close(s).catch()}})),o}info(){return{type:oe.INFO,name:this.name,id:this.id,version:this.version,description:this.description,metadata:this.metadata,endpoints:this.endpoints()}}endpoints(){return this.handlers.map((e=>{const{subject:t,metadata:s,name:r,queue:n}=e;return{subject:t,metadata:s,name:r,queue_group:n}}))}async stats(){const e=[];for(const t of this.handlers){if("function"==typeof this.config.statsHandler)try{t.stats.data=await this.config.statsHandler(t)}catch(e){t.stats.countError(e)}e.push(t.stats.stats(t.qi))}return{type:oe.STATS,name:this.name,id:this.id,version:this.version,started:this.started,metadata:this.metadata,endpoints:e}}addInternalHandler(e,t){const s=`${e}`.toUpperCase();this._doAddInternalHandler(`${s}-all`,e,t),this._doAddInternalHandler(`${s}-kind`,e,t,this.name),this._doAddInternalHandler(`${s}`,e,t,this.name,this.id)}_doAddInternalHandler(e,t,s,r="",n=""){const i={};i.name=e,i.subject=Ls.controlSubject(t,r,n),i.handler=s,this.setupHandler(i,!0)}start(){const e=Pe(),t=e.encode(this.ping());return this.addInternalHandler(de.PING,((e,s)=>e?(this.close(e).then().catch(),Promise.reject(e)):(s.respond(t),Promise.resolve()))),this.addInternalHandler(de.STATS,((t,s)=>t?(this.close(t),Promise.reject(t)):this.stats().then((t=>(s?.respond(e.encode(t)),Promise.resolve()))))),this.addInternalHandler(de.INFO,((t,s)=>t?(this.close(t),Promise.reject(t)):(s?.respond(e.encode(this.info())),Promise.resolve()))),this.handlers.forEach((e=>{const{subject:t}=e;"string"==typeof t&&null!==e.handler&&this.setupHandler(e)})),Promise.resolve(this)}close(e){if(this._stopped)return this._done;this._stopped=!0;let t=[];return this.nc.isClosed()||(t=this.handlers.concat(this.internal).map((e=>e.sub.drain()))),Promise.allSettled(t).then((()=>{this._done.resolve(e||null)})),this._done}get stopped(){return this._done}get isStopped(){return this._stopped}stop(e){return this.close(e)}ping(){return{type:oe.PING,name:this.name,id:this.id,version:this.version,metadata:this.metadata}}reset(){if(this.started=(new Date).toISOString(),this.handlers)for(const e of this.handlers)e.stats.reset(e.qi)}addGroup(e,t){return new Ms(this,e,t)}addEndpoint(e,t){return new Ms(this).addEndpoint(e,t)}_addEndpoint(e){const t=new Ue;t.noIterator="function"==typeof e.handler,t.noIterator||(e.handler=(e,s)=>{e?this.stop(e).catch():t.push(new Ns(s))},t.iterClosed.then((()=>{this.close().catch()})));const s=this.setupHandler(e,!1);return s.qi=t,this.handlers.push(s),t}}class Rs{name;subject;average_processing_time;num_requests;processing_time;num_errors;last_error;data;metadata;queue;constructor(e,t,s=""){this.name=e,this.subject=t,this.average_processing_time=0,this.num_errors=0,this.num_requests=0,this.processing_time=0,this.queue=s}reset(e){this.num_requests=0,this.processing_time=0,this.average_processing_time=0,this.num_errors=0,this.last_error=void 0,this.data=void 0;const t=e;t&&(t.time=0,t.processed=0)}countLatency(e){this.num_requests++,this.processing_time+=ye(Date.now()-e),this.average_processing_time=Math.round(this.processing_time/this.num_requests)}countError(e){this.num_errors++,this.last_error=e.message}_stats(){const{name:e,subject:t,average_processing_time:s,num_errors:r,num_requests:n,processing_time:i,last_error:o,data:a,queue:c}=this;return{name:e,subject:t,average_processing_time:s,num_errors:r,num_requests:n,processing_time:i,last_error:o,data:a,queue_group:c}}stats(e){const t=e;return!1===t?.noIterator&&(this.processing_time=t.time,this.num_requests=t.processed,this.average_processing_time=this.processing_time>0&&this.num_requests>0?this.processing_time/this.num_requests:0),this._stats()}}class Ds{nc;prefix;opts;constructor(e,t={strategy:ie.JitterTimer,maxWait:2e3},s){this.nc=e,this.prefix=s,this.opts=t}ping(e="",t=""){return this.q(de.PING,e,t)}stats(e="",t=""){return this.q(de.STATS,e,t)}info(e="",t=""){return this.q(de.INFO,e,t)}async q(e,t="",s=""){const r=new Ue,n=Pe(),i=Ls.controlSubject(e,t,s,this.prefix),o=await this.nc.requestMany(i,K,this.opts);return(async()=>{for await(const e of o)try{const t=n.decode(e.data);r.push(t)}catch(e){r.push((()=>{r.stop(e)}))}r.push((()=>{r.stop()}))})().catch((e=>{r.stop(e)})),r}}const Bs="KV-Operation",$s=/^[-/=.\w]+$/,Us=/^[-/=.>*\w]+$/,Fs=/^[-\w]+$/;function qs(e){if(e.startsWith(".")||e.endsWith(".")||!$s.test(e))throw new Error(`invalid key: ${e}`)}function Hs(e){if(e.startsWith(".")||e.endsWith(".")||!Us.test(e))throw new Error(`invalid key: ${e}`)}function Ks(e){if(e.startsWith(".")||e.endsWith("."))throw new Error(`invalid key: ${e}`);const t=e.split(".");let s=!1;for(let r=0;r<t.length;r++)switch(t[r]){case"*":s=!0;break;case">":if(r!==t.length-1)throw new Error(`invalid key: ${e}`);s=!0}return s}function zs(e){if(!Fs.test(e))throw new Error(`invalid bucket name: ${e}`)}var Gs;!function(e){e.MsgIdHdr="Nats-Msg-Id",e.ExpectedStreamHdr="Nats-Expected-Stream",e.ExpectedLastSeqHdr="Nats-Expected-Last-Sequence",e.ExpectedLastMsgIdHdr="Nats-Expected-Last-Msg-Id",e.ExpectedLastSubjectSequenceHdr="Nats-Expected-Last-Subject-Sequence"}(Gs||(Gs={}));class Js{js;jsm;stream;bucket;direct;codec;prefix;editPrefix;useJsPrefix;_prefixLen;constructor(e,t,s){zs(e),this.js=t,this.jsm=s,this.bucket=e,this.prefix="$KV",this.editPrefix="",this.useJsPrefix=!1,this._prefixLen=0}static async create(e,t,s={}){zs(t);const r=await e.jetstreamManager(),n=new Js(t,e,r);return await n.init(s),n}static async bind(e,t,s={}){const r=await e.jetstreamManager(),n={config:{allow_direct:s.allow_direct}};zs(t);const i=new Js(t,e,r);return n.config.name=s.streamName??i.bucketName(),Object.assign(i,n),i.stream=n.config.name,i.codec=s.codec||{key:{encode:e=>e,decode:e=>e},value:{encode:e=>e,decode:e=>e}},i.direct=n.config.allow_direct??!1,i.initializePrefixes(n),i}async init(e={}){const t=Object.assign({replicas:1,history:1,timeout:2e3,maxBucketSize:-1,maxValueSize:-1,codec:{key:{encode:e=>e,decode:e=>e},value:{encode:e=>e,decode:e=>e}},storage:Ke.File},e);this.codec=t.codec;const s={};this.stream=s.name=e.streamName??this.bucketName(),s.retention=qe.Limits,s.max_msgs_per_subject=t.history,t.maxBucketSize&&(t.max_bytes=t.maxBucketSize),t.max_bytes&&(s.max_bytes=t.max_bytes),s.max_msg_size=t.maxValueSize,s.storage=t.storage;const r=e.placementCluster??"";if(r&&(e.placement={},e.placement.cluster=r,e.placement.tags=[]),e.placement&&(s.placement=e.placement),e.republish&&(s.republish=e.republish),e.description&&(s.description=e.description),e.mirror){const t=Object.assign({},e.mirror);t.name.startsWith(tt)||(t.name=`${tt}${t.name}`),s.mirror=t,s.mirror_direct=!0}else if(e.sources){const t=e.sources.map((e=>{const t=Object.assign({},e);t.name.startsWith(tt)||(t.name=`${tt}${t.name}`)}));s.sources=t}else s.subjects=[this.subjectForBucket()];e.metadata&&(s.metadata=e.metadata),"boolean"==typeof e.compression&&(s.compression=e.compression?Ve.S2:Ve.None);const n=this.js.nc,i=n.getServerVersion(),o=!!i&&kt(i,Et("2.7.2"))>=0;s.discard=o?He.New:He.Old;const{ok:a,min:c}=n.features.get(xt.JS_ALLOW_DIRECT);if(!a&&!0===e.allow_direct){const e=i?`${i.major}.${i.minor}.${i.micro}`:"unknown";return Promise.reject(new Error(`allow_direct is not available on server version ${e} - requires ${c}`))}let h;e.allow_direct="boolean"==typeof e.allow_direct?e.allow_direct:a,s.allow_direct=e.allow_direct,this.direct=s.allow_direct,s.num_replicas=t.replicas,t.ttl&&(s.max_age=ye(t.ttl)),s.allow_rollup_hdrs=!0;try{h=await this.jsm.streams.info(s.name),h.config.allow_direct||!0!==this.direct||(this.direct=!1)}catch(e){if("stream not found"!==e.message)throw e;h=await this.jsm.streams.add(s)}this.initializePrefixes(h)}initializePrefixes(e){this._prefixLen=0,this.prefix=`$KV.${this.bucket}`,this.useJsPrefix="$JS.API"!==this.js.apiPrefix;const{mirror:t}=e.config;if(t){let e=t.name;if(e.startsWith(tt)&&(e=e.substring(3)),t.external&&""!==t.external.api){const s=t.name.substring(3);this.useJsPrefix=!1,this.prefix=`$KV.${s}`,this.editPrefix=`${t.external.api}.$KV.${e}`}else this.editPrefix=this.prefix}}bucketName(){return this.stream??`${tt}${this.bucket}`}subjectForBucket(){return`${this.prefix}.${this.bucket}.>`}subjectForKey(e,t=!1){const s=[];return t?(this.useJsPrefix&&s.push(this.js.apiPrefix),""!==this.editPrefix?s.push(this.editPrefix):s.push(this.prefix)):this.prefix&&s.push(this.prefix),s.push(e),s.join(".")}fullKeyName(e){return""!==this.prefix?`${this.prefix}.${e}`:`$KV.${this.bucket}.${e}`}get prefixLen(){return 0===this._prefixLen&&(this._prefixLen=this.prefix.length+1),this._prefixLen}encodeKey(e){const t=[];for(const s of e.split("."))switch(s){case">":case"*":t.push(s);break;default:t.push(this.codec.key.encode(s))}return t.join(".")}decodeKey(e){const t=[];for(const s of e.split("."))switch(s){case">":case"*":t.push(s);break;default:t.push(this.codec.key.decode(s))}return t.join(".")}validateKey=qs;validateSearchKey=Hs;hasWildcards=Ks;close(){return Promise.resolve()}dataLen(e,t){const s=t&&t.get(Qe.MessageSizeHdr)||"";return""!==s?parseInt(s,10):e.length}smToEntry(e){return new Ir(this.bucket,this.prefixLen,e)}jmToEntry(e){const t=this.decodeKey(e.subject.substring(this.prefixLen));return new Ar(this.bucket,t,e)}async create(e,t){let s;try{const s=await this.put(e,t,{previousSeq:0});return Promise.resolve(s)}catch(e){if(s=e,10071!==e?.api_error?.err_code)return Promise.reject(e)}let r=0;try{const n=await this.get(e);return"DEL"===n?.operation||"PURGE"===n?.operation?(r=null!==n?n.revision:0,this.update(e,t,r)):Promise.reject(s)}catch(e){return Promise.reject(e)}}update(e,t,s){if(s<=0)throw new Error("version must be greater than 0");return this.put(e,t,{previousSeq:s})}async put(e,t,s={}){const r=this.encodeKey(e);this.validateKey(r);const n={};if(void 0!==s.previousSeq){const e=Ee();n.headers=e,e.set(Gs.ExpectedLastSubjectSequenceHdr,`${s.previousSeq}`)}try{return(await this.js.publish(this.subjectForKey(r,!0),t,n)).seq}catch(e){const t=e;return t.isJetStreamError()?(t.message=t.api_error?.description,t.code=`${t.api_error?.code}`,Promise.reject(t)):Promise.reject(e)}}async get(e,t){const s=this.encodeKey(e);this.validateKey(s);let r,n={last_by_subj:this.subjectForKey(s)};t&&t.revision>0&&(n={seq:t.revision});try{if(this.direct){const e=this.jsm.direct;r=await e.getMessage(this.bucketName(),n)}else r=await this.jsm.streams.getMessage(this.bucketName(),n);const e=this.smToEntry(r);return e.key!==s?null:e}catch(e){if(e.code===Z.JetStream404NoMessages)return null;throw e}}purge(e,t){return this._deleteOrPurge(e,"PURGE",t)}delete(e,t){return this._deleteOrPurge(e,"DEL",t)}async purgeDeletes(e=18e5){const t=be(),s=[],r=await this.watch({key:">",initializedFn:()=>{t.resolve()}});(async()=>{for await(const e of r)"DEL"!==e.operation&&"PURGE"!==e.operation||s.push(e)})().then(),await t,r.stop();const n=Date.now()-e,i=s.map((e=>{const t=this.subjectForKey(e.key);return e.created.getTime()>=n?this.jsm.streams.purge(this.stream,{filter:t,keep:1}):this.jsm.streams.purge(this.stream,{filter:t,keep:0})})),o=await Promise.all(i);return o.unshift({success:!0,purged:0}),o.reduce(((e,t)=>(e.purged+=t.purged,e)))}async _deleteOrPurge(e,t,s){if(!this.hasWildcards(e))return this._doDeleteOrPurge(e,t,s);const r=await this.keys(e),n=[];for await(const e of r)n.push(this._doDeleteOrPurge(e,t)),100===n.length&&(await Promise.all(n),n.length=0);n.length>0&&await Promise.all(n)}async _doDeleteOrPurge(e,t,s){const r=this.encodeKey(e);this.validateKey(r);const n=Ee();n.set(Bs,t),"PURGE"===t&&n.set(Qe.RollupHdr,Qe.RollupValueSubject),s?.previousSeq&&n.set(Gs.ExpectedLastSubjectSequenceHdr,`${s.previousSeq}`),await this.js.publish(this.subjectForKey(r,!0),K,{headers:n})}_buildCC(e,t,s={}){let r,n=(Array.isArray(e)?e:[e]).map((e=>{const t=this.encodeKey(e);return this.validateSearchKey(e),this.fullKeyName(t)})),i=ze.LastPerSubject;return t===Xe.AllHistory&&(i=ze.All),t===Xe.UpdatesOnly&&(i=ze.New),1===n.length&&(r=n[0],n=void 0),Object.assign({deliver_policy:i,ack_policy:Ge.None,filter_subjects:n,filter_subject:r,flow_control:!0,idle_heartbeat:ye(5e3)},s)}remove(e){return this.purge(e)}async history(e={}){const t=e.key??">",s=new Ue,r={};let n;r.headers_only=e.headers_only||!1,n=()=>{s.stop()};let i=0;const o=this._buildCC(t,Xe.AllHistory,r),a=o.filter_subject,c=rt(o);c.bindStream(this.stream),c.orderedConsumer(),c.callback(((e,t)=>{if(e)s.stop(e);else if(t){const e=this.jmToEntry(t);s.push(e),s.received++,(n&&i>0&&s.received>=i||0===t.info.pending)&&(s.push(n),n=void 0)}}));const h=await this.js.subscribe(a,c);if(n){const{info:{last:e}}=h,t=e.num_pending+e.delivered.consumer_seq;if(0===t||s.received>=t)try{n()}catch(e){s.stop(e)}finally{n=void 0}else i=t}return s._data=h,s.iterClosed.then((()=>{h.unsubscribe()})),h.closed.then((()=>{s.stop()})).catch((e=>{s.stop(e)})),s}canSetWatcherName(){const e=this.js.nc,{ok:t}=e.features.get(xt.JS_NEW_CONSUMER_CREATE_API);return t}async watch(e={}){const t=e.key??">",s=new Ue,r={};r.headers_only=e.headers_only||!1;let n=Xe.LastValue;e.include===Xe.AllHistory?n=Xe.AllHistory:e.include===Xe.UpdatesOnly&&(n=Xe.UpdatesOnly);const i=!0===e.ignoreDeletes;let o=e.initializedFn,a=0;const c=this._buildCC(t,n,r),h=c.filter_subject,u=rt(c);this.canSetWatcherName()&&u.consumerName(Y.next()),u.bindStream(this.stream),e.resumeFromRevision&&e.resumeFromRevision>0&&u.startSequence(e.resumeFromRevision),u.orderedConsumer(),u.callback(((e,t)=>{if(e)s.stop(e);else if(t){const e=this.jmToEntry(t);if(i&&"DEL"===e.operation)return;s.push(e),s.received++,o&&(a>0&&s.received>=a||0===t.info.pending)&&(s.push(o),o=void 0)}}));const l=await this.js.subscribe(h,u);if(o){const{info:{last:e}}=l,t=e.num_pending+e.delivered.consumer_seq;if(0===t||s.received>=t)try{o()}catch(e){s.stop(e)}finally{o=void 0}else a=t}return s._data=l,s.iterClosed.then((()=>{l.unsubscribe()})),l.closed.then((()=>{s.stop()})).catch((e=>{s.stop(e)})),s}async keys(e=">"){const t=new Ue,s=this._buildCC(e,Xe.LastValue,{headers_only:!0}),r=s.filter_subject,n=rt(s);n.bindStream(this.stream),n.orderedConsumer();const i=await this.js.subscribe(r,n);return(async()=>{for await(const e of i){const s=e.headers?.get(Bs);if("DEL"!==s&&"PURGE"!==s){const s=this.decodeKey(e.subject.substring(this.prefixLen));t.push(s)}0===e.info.pending&&i.unsubscribe()}})().then((()=>{t.stop()})).catch((e=>{t.stop(e)})),0===i.info.last.num_pending&&i.unsubscribe(),t}purgeBucket(e){return this.jsm.streams.purge(this.bucketName(),e)}destroy(){return this.jsm.streams.delete(this.bucketName())}async status(){const e=this.js.nc,t=e.info?.cluster??"",s=this.bucketName(),r=await this.jsm.streams.info(s);return new Vs(r,t)}}class Vs{si;cluster;constructor(e,t=""){this.si=e,this.cluster=t}get bucket(){return this.si.config.name.startsWith(tt)?this.si.config.name.substring(3):this.si.config.name}get values(){return this.si.state.messages}get history(){return this.si.config.max_msgs_per_subject}get ttl(){return ve(this.si.config.max_age)}get bucket_location(){return this.cluster}get backingStore(){return this.si.config.storage}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get description(){return this.si.config.description??""}get maxBucketSize(){return this.si.config.max_bytes}get maxValueSize(){return this.si.config.max_msg_size}get max_bytes(){return this.si.config.max_bytes}get placement(){return this.si.config.placement||{cluster:"",tags:[]}}get placementCluster(){return this.si.config.placement?.cluster??""}get republish(){return this.si.config.republish??{src:"",dest:""}}get streamInfo(){return this.si}get size(){return this.si.state.bytes}get metadata(){return this.si.config.metadata??{}}get compression(){return!!this.si.config.compression&&this.si.config.compression!==Ve.None}}const Ws="OBJ_",Ys="SHA-256=";class Qs{si;backingStore;constructor(e){this.si=e,this.backingStore="JetStream"}get bucket(){return(e=this.si.config.name).startsWith(Ws)?e.substring(4):e;var e}get description(){return this.si.config.description??""}get ttl(){return this.si.config.max_age}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get sealed(){return this.si.config.sealed}get size(){return this.si.state.bytes}get streamInfo(){return this.si}get metadata(){return this.si.config.metadata}get compression(){return!!this.si.config.compression&&this.si.config.compression!==Ve.None}}function Xs(e){if(void 0===e)return;const{domain:t}=e;if(void 0===t)return e;const s=Object.assign({},e);if(delete s.domain,""===t)return s;if(s.external)throw new Error("domain and external are both set");return s.external={api:`$JS.${t}.API`},s}var Zs,er,tr;!function(e){e[e.Unset=-1]="Unset",e[e.Consume=0]="Consume",e[e.Fetch=1]="Fetch"}(Zs||(Zs={})),function(e){e.HeartbeatsMissed="heartbeats_missed",e.ConsumerNotFound="consumer_not_found",e.StreamNotFound="stream_not_found",e.ConsumerDeleted="consumer_deleted",e.OrderedConsumerRecreated="ordered_consumer_recreated"}(er||(er={})),function(e){e.DebugEvent="debug",e.Discard="discard",e.Reset="reset",e.Next="next"}(tr||(tr={}));const sr=Uint8Array.of(43,65,67,75),rr=Uint8Array.of(45,78,65,75),nr=Uint8Array.of(43,87,80,73),ir=Uint8Array.of(43,78,88,84),or=Uint8Array.of(43,84,69,82,77),ar=Uint8Array.of(32);function cr(e){return new Rr(e)}class hr extends Ue{consumer;opts;sub;monitor;pending;inbox;refilling;pong;callback;timeout;cleanupHandler;listeners;statusIterator;forOrderedConsumer;resetHandler;abortOnMissingResource;bind;constructor(e,t,s=!1){super(),this.consumer=e;const r=t;this.opts=this.parseOptions(t,s),this.callback=r.callback||null,this.noIterator="function"==typeof this.callback,this.monitor=null,this.pong=null,this.pending={msgs:0,bytes:0,requests:0},this.refilling=s,this.timeout=null,this.inbox=ue(e.api.nc.options.inboxPrefix),this.listeners=[],this.forOrderedConsumer=!1,this.abortOnMissingResource=!0===r.abort_on_missing_resource,this.bind=!0===r.bind,this.start()}start(){const{max_messages:e,max_bytes:t,idle_heartbeat:s,threshold_bytes:r,threshold_messages:n}=this.opts;this.closed().then((e=>{if(this.cleanupHandler)try{this.cleanupHandler(e)}catch(e){}}));const{sub:i}=this;i&&i.unsubscribe(),this.sub=this.consumer.api.nc.subscribe(this.inbox,{callback:(s,i)=>{if(s)this.stop(s);else{if(this.monitor?.work(),i.subject===this.inbox){if(Le(i))return;const e=i.headers?.code,t=i.headers?.description?.toLowerCase()||"unknown",{msgsLeft:s,bytesLeft:r}=this.parseDiscard(i.headers);if(s>0||r>0)this.pending.msgs-=s,this.pending.bytes-=r,this.pending.requests--,this.notify(tr.Discard,{msgsLeft:s,bytesLeft:r});else{if(400===e)return void this.stop(new re(t,`${e}`));if(409===e&&"consumer deleted"===t){if(this.notify(er.ConsumerDeleted,`${e} ${t}`),!this.refilling||this.abortOnMissingResource){const s=new re(t,`${e}`);return void this.stop(s)}}else this.notify(tr.DebugEvent,`${e} ${t}`)}}else this._push(cr(i)),this.received++,this.pending.msgs&&this.pending.msgs--,this.pending.bytes&&(this.pending.bytes-=i.size());if(0===this.pending.msgs&&0===this.pending.bytes&&(this.pending.requests=0),this.refilling){if(e&&this.pending.msgs<=n||t&&this.pending.bytes<=r){const e=this.pullOptions();this.pull(e)}}else 0===this.pending.requests&&this._push((()=>{this.stop()}))}}}),this.sub.closed.then((()=>{this.sub.draining&&this._push((()=>{this.stop()}))})),s&&(this.monitor=new Fe(s,(e=>(this.notify(er.HeartbeatsMissed,e),this.resetPending().then((()=>{})).catch((()=>{})),!1)),{maxOut:2})),(async()=>{const e=this.consumer.api.nc.status();this.statusIterator=e;for await(const t of e)switch(t.type){case Q.Disconnect:this.monitor?.cancel();break;case Q.Reconnect:this.resetPending().then((e=>{e&&this.monitor?.restart()})).catch((()=>{}))}})(),this.pull(this.pullOptions())}_push(e){if(this.callback){const t="function"==typeof e?e:null;try{t?t():this.callback(e)}catch(e){this.stop(e)}}else super.push(e)}notify(e,t){this.listeners.length>0&&(()=>{this.listeners.forEach((s=>{s.done||s.push({type:e,data:t})}))})()}resetPending(){return this.bind?this.resetPendingNoInfo():this.resetPendingWithInfo()}resetPendingNoInfo(){return this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),Promise.resolve(!0)}async resetPendingWithInfo(){let e=0,t=0;const s=_e();let r=0;for(;;){if(this.done)return!1;if(this.consumer.api.nc.isClosed())return console.error("aborting resetPending - connection is closed"),!1;try{return await this.consumer.info(),e=0,this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),!0}catch(n){if("stream not found"===n.message){if(t++,this.notify(er.StreamNotFound,t),!this.refilling||this.abortOnMissingResource)return this.stop(n),!1}else if("consumer not found"===n.message){if(e++,this.notify(er.ConsumerNotFound,e),this.resetHandler)try{this.resetHandler()}catch(e){}if(!this.refilling||this.abortOnMissingResource)return this.stop(n),!1;if(this.forOrderedConsumer)return!1}else e=0,t=0;const i=ge(s.backoff(r));await Promise.race([i,this.consumer.api.nc.closed()]),i.cancel(),r++}}}pull(e){this.pending.bytes+=e.max_bytes??0,this.pending.msgs+=e.batch??0,this.pending.requests++;const t=this.consumer.api.nc;this._push((()=>{t.publish(`${this.consumer.api.prefix}.CONSUMER.MSG.NEXT.${this.consumer.stream}.${this.consumer.name}`,this.consumer.api.jc.encode(e),{reply:this.inbox}),this.notify(tr.Next,e)}))}pullOptions(){return{batch:this.opts.max_messages-this.pending.msgs,max_bytes:this.opts.max_bytes-this.pending.bytes,idle_heartbeat:ye(this.opts.idle_heartbeat),expires:ye(this.opts.expires)}}parseDiscard(e){const t={msgsLeft:0,bytesLeft:0},s=e?.get(Qe.PendingMessagesHdr);s&&(t.msgsLeft=parseInt(s));const r=e?.get(Qe.PendingBytesHdr);return r&&(t.bytesLeft=parseInt(r)),t}trackTimeout(e){this.timeout=e}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}clearTimers(){this.monitor?.cancel(),this.monitor=null,this.timeout?.cancel(),this.timeout=null}setCleanupHandler(e){this.cleanupHandler=e}stop(e){this.done||(this.sub?.unsubscribe(),this.clearTimers(),this.statusIterator?.stop(),this._push((()=>{super.stop(e),this.listeners.forEach((e=>{e.stop()}))})))}parseOptions(e,t=!1){const s=e||{};if(s.max_messages=s.max_messages||0,s.max_bytes=s.max_bytes||0,0!==s.max_messages&&0!==s.max_bytes)throw new Error("only specify one of max_messages or max_bytes");if(0===s.max_messages&&(s.max_messages=100),s.expires=s.expires||3e4,s.expires<1e3)throw new Error("expires should be at least 1000ms");if(s.idle_heartbeat=s.idle_heartbeat||s.expires/2,s.idle_heartbeat=s.idle_heartbeat>3e4?3e4:s.idle_heartbeat,t){const e=Math.round(.75*s.max_messages)||1;s.threshold_messages=s.threshold_messages||e;const t=Math.round(.75*s.max_bytes)||1;s.threshold_bytes=s.threshold_bytes||t}return s}status(){const e=new Ue;return this.listeners.push(e),Promise.resolve(e)}}class ur extends Ue{src;listeners;constructor(){super(),this.listeners=[]}setSource(e){this.src&&(this.src.resetHandler=void 0,this.src.setCleanupHandler(),this.src.stop()),this.src=e,this.src.setCleanupHandler((e=>{this.stop(e||void 0)})),(async()=>{const e=await this.src.status();for await(const t of e)this.notify(t.type,t.data)})().catch((()=>{}))}notify(e,t){this.listeners.length>0&&(()=>{this.listeners.forEach((s=>{s.done||s.push({type:e,data:t})}))})()}stop(e){this.done||(this.src?.stop(e),super.stop(e),this.listeners.forEach((e=>{e.stop()})))}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}status(){const e=new Ue;return this.listeners.push(e),Promise.resolve(e)}}class lr{api;_info;stream;name;constructor(e,t){this.api=e,this._info=t,this.stream=t.stream_name,this.name=t.name}consume(e={max_messages:100,expires:3e4}){return Promise.resolve(new hr(this,e,!0))}fetch(e={max_messages:100,expires:3e4}){const t=new hr(this,e,!1),s=me(Math.round(1.05*t.opts.expires));return t.closed().catch((()=>{})).finally((()=>{s.cancel()})),s.catch((()=>{t.close().catch()})),t.trackTimeout(s),Promise.resolve(t)}next(e={expires:3e4}){const t=be(),s=e;s.max_messages=1;const r=new hr(this,s,!1),n=Math.round(1.05*r.opts.expires);n>=6e4&&(async()=>{for await(const e of await r.status())if(e.type===er.HeartbeatsMissed&&e.data>=2){t.reject(new Error("consumer missed heartbeats"));break}})().catch(),(async()=>{for await(const e of r){t.resolve(e);break}})().catch((()=>{}));const i=me(n);return r.closed().then((e=>{e?t.reject(e):t.resolve(null)})).catch((e=>{t.reject(e)})).finally((()=>{i.cancel()})),i.catch((e=>{t.resolve(null),r.close().catch()})),r.trackTimeout(i),t}delete(){const{stream_name:e,name:t}=this._info;return this.api.delete(e,t)}info(e=!1){if(e)return Promise.resolve(this._info);const{stream_name:t,name:s}=this._info;return this.api.info(t,s).then((e=>(this._info=e,this._info)))}}class dr{api;consumerOpts;consumer;opts;cursor;stream;namePrefix;serial;currentConsumer;userCallback;iter;type;startSeq;constructor(e,t,s={}){this.api=e,this.stream=t,this.cursor={stream_seq:1,deliver_seq:0},this.namePrefix=Y.next(),"string"==typeof s.name_prefix&&(Te("name_prefix",s.name_prefix),this.namePrefix=s.name_prefix+this.namePrefix),this.serial=0,this.currentConsumer=null,this.userCallback=null,this.iter=null,this.type=Zs.Unset,this.consumerOpts=s,this.startSeq=this.consumerOpts.opt_start_seq||0,this.cursor.stream_seq=this.startSeq>0?this.startSeq-1:0}getConsumerOpts(e){this.serial++,e=0===e?1:e;const t={name:`${this.namePrefix}_${this.serial}`,deliver_policy:ze.StartSequence,opt_start_seq:e,ack_policy:Ge.None,inactive_threshold:ye(3e5),num_replicas:1};return!0===this.consumerOpts.headers_only&&(t.headers_only=!0),Array.isArray(this.consumerOpts.filterSubjects)&&(t.filter_subjects=this.consumerOpts.filterSubjects),"string"==typeof this.consumerOpts.filterSubjects&&(t.filter_subject=this.consumerOpts.filterSubjects),this.consumerOpts.replay_policy&&(t.replay_policy=this.consumerOpts.replay_policy),e===this.startSeq+1&&(t.deliver_policy=this.consumerOpts.deliver_policy||ze.StartSequence,this.consumerOpts.deliver_policy!==ze.LastPerSubject&&this.consumerOpts.deliver_policy!==ze.New&&this.consumerOpts.deliver_policy!==ze.Last||(delete t.opt_start_seq,t.deliver_policy=this.consumerOpts.deliver_policy),t.deliver_policy===ze.LastPerSubject&&void 0===t.filter_subjects&&void 0===t.filter_subject&&(t.filter_subject=">"),this.consumerOpts.opt_start_time&&(delete t.opt_start_seq,t.deliver_policy=ze.StartTime,t.opt_start_time=this.consumerOpts.opt_start_time),this.consumerOpts.inactive_threshold&&(t.inactive_threshold=ye(this.consumerOpts.inactive_threshold))),t}async resetConsumer(e=0){this.consumer?.delete().catch((()=>{})),e=0===e?1:e,this.cursor.deliver_seq=0;const t=this.getConsumerOpts(e);t.max_deliver=1,t.mem_storage=!0;const s=_e();let r;for(let n=0;;n++)try{r=await this.api.add(this.stream,t),this.iter?.notify(er.OrderedConsumerRecreated,r.name);break}catch(t){if("stream not found"===t.message&&(this.iter?.notify(er.StreamNotFound,n),this.type===Zs.Fetch||!0===this.opts.abort_on_missing_resource))return this.iter?.stop(t),Promise.reject(t);if(0===e&&n>=30)throw t;await ge(s.backoff(n+1))}return r}internalHandler(e){return t=>{if(this.serial!==e)return;const s=t.info.deliverySequence;s===this.cursor.deliver_seq+1?(this.cursor.deliver_seq=s,this.cursor.stream_seq=t.info.streamSequence,this.userCallback?this.userCallback(t):this.iter?.push(t)):this.notifyOrderedResetAndReset()}}async reset(e={max_messages:100,expires:3e4},t){const s=(t=t||{}).fromFetch||!1,r=t.orderedReset||!1;if(this.type===Zs.Fetch&&r)return this.iter?.src.stop(),await(this.iter?.closed()),void(this.currentConsumer=null);(null===this.currentConsumer||r)&&(this.currentConsumer=await this.resetConsumer(this.cursor.stream_seq+1)),(null===this.iter||s)&&(this.iter=new ur),this.consumer=new lr(this.api,this.currentConsumer),e.callback=this.internalHandler(this.serial);let n=null;this.type===Zs.Fetch&&s?n=await this.consumer.fetch(e):this.type===Zs.Consume&&(n=await this.consumer.consume(e));const i=n;i.forOrderedConsumer=!0,i.resetHandler=()=>{this.notifyOrderedResetAndReset()},this.iter.setSource(i)}notifyOrderedResetAndReset(){this.iter?.notify(tr.Reset,""),this.reset(this.opts,{orderedReset:!0})}async consume(e={max_messages:100,expires:3e4}){if(e.bind)return Promise.reject(new Error("bind is not supported"));if(this.type===Zs.Fetch)return Promise.reject(new Error("ordered consumer initialized as fetch"));if(this.type===Zs.Consume)return Promise.reject(new Error("ordered consumer doesn't support concurrent consume"));const{callback:t}=e;return t&&(this.userCallback=t),this.type=Zs.Consume,this.opts=e,await this.reset(e),this.iter}async fetch(e={max_messages:100,expires:3e4}){if(e.bind)return Promise.reject(new Error("bind is not supported"));if(this.type===Zs.Consume)return Promise.reject(new Error("ordered consumer already initialized as consume"));if(!1===this.iter?.done)return Promise.reject(new Error("ordered consumer doesn't support concurrent fetch"));const{callback:t}=e;return t&&(this.userCallback=t),this.type=Zs.Fetch,this.opts=e,await this.reset(e,{fromFetch:!0}),this.iter}async next(e={expires:3e4}){const t=e;if(t.bind)return Promise.reject(new Error("bind is not supported"));t.max_messages=1;const s=be();return t.callback=e=>{this.userCallback=null,s.resolve(e)},(await this.fetch(t)).iterClosed.then((e=>{e&&s.reject(e),s.resolve(null)})).catch((e=>{s.reject(e)})),s}delete(){return this.currentConsumer?this.api.delete(this.stream,this.currentConsumer.name).then((e=>Promise.resolve(e))).catch((e=>Promise.reject(e))).finally((()=>{this.currentConsumer=null})):Promise.resolve(!1)}async info(e){return null==this.currentConsumer?(this.currentConsumer=await this.resetConsumer(this.serial),Promise.resolve(this.currentConsumer)):e&&this.currentConsumer?Promise.resolve(this.currentConsumer):this.api.info(this.stream,this.currentConsumer.name)}}class fr{api;notified;constructor(e){this.api=e,this.notified=!1}checkVersion(){const e=this.api.nc.features.get(xt.JS_SIMPLIFICATION);return e.ok?Promise.resolve():Promise.reject(new Error(`consumers framework is only supported on servers ${e.min} or better`))}async get(e,t={}){return"object"==typeof t?this.ordered(e,t):(await this.checkVersion(),this.api.info(e,t).then((e=>void 0!==e.config.deliver_subject?Promise.reject(new Error("push consumer not supported")):new lr(this.api,e))).catch((e=>Promise.reject(e))))}async ordered(e,t){await this.checkVersion();const s=this.api;return new mr(s.nc,s.opts).info(e).then((s=>Promise.resolve(new dr(this.api,e,t)))).catch((e=>Promise.reject(e)))}}class pr{api;_info;constructor(e,t){this.api=e,this._info=t}get name(){return this._info.config.name}alternates(){return this.info().then((e=>e.alternates?e.alternates:[]))}async best(){if(await this.info(),this._info.alternates){const e=await this.api.info(this._info.alternates[0].name);return new pr(this.api,e)}return this}info(e=!1,t){return e?Promise.resolve(this._info):this.api.info(this.name,t).then((e=>(this._info=e,this._info)))}getConsumer(e){return new fr(new Pt(this.api.nc,this.api.opts)).get(this.name,e)}getMessage(e){return this.api.getMessage(this.name,e)}deleteMessage(e,t){return this.api.deleteMessage(this.name,e,t)}}class mr extends vt{constructor(e,t){super(e,t)}checkStreamConfigVersions(e){const t=this.nc;if(e.metadata){const{min:e,ok:s}=t.features.get(xt.JS_STREAM_CONSUMER_METADATA);if(!s)throw new Error(`stream 'metadata' requires server ${e}`)}if(e.first_seq){const{min:e,ok:s}=t.features.get(xt.JS_STREAM_FIRST_SEQ);if(!s)throw new Error(`stream 'first_seq' requires server ${e}`)}if(e.subject_transform){const{min:e,ok:s}=t.features.get(xt.JS_STREAM_SUBJECT_TRANSFORM);if(!s)throw new Error(`stream 'subject_transform' requires server ${e}`)}if(e.compression){const{min:e,ok:s}=t.features.get(xt.JS_STREAM_COMPRESSION);if(!s)throw new Error(`stream 'compression' requires server ${e}`)}if(e.consumer_limits){const{min:e,ok:s}=t.features.get(xt.JS_DEFAULT_CONSUMER_LIMITS);if(!s)throw new Error(`stream 'consumer_limits' requires server ${e}`)}function s(e,s){if((s.subject_transforms?.length||0)>0){const{min:s,ok:r}=t.features.get(xt.JS_STREAM_SOURCE_SUBJECT_TRANSFORM);if(!r)throw new Error(`${e} 'subject_transforms' requires server ${s}`)}}e.sources&&e.sources.forEach((e=>{s("stream sources",e)})),e.mirror&&s("stream mirror",e.mirror)}async add(e={}){this.checkStreamConfigVersions(e),je(e.name),e.mirror=Xs(e.mirror),e.sources=e.sources?.map(Xs);const t=await this._request(`${this.prefix}.STREAM.CREATE.${e.name}`,e);return this._fixInfo(t),t}async delete(e){return je(e),(await this._request(`${this.prefix}.STREAM.DELETE.${e}`)).success}async update(e,t={}){if("object"==typeof e){const s=e;e=s.name,t=s,console.trace("[33m >> streams.update(config: StreamConfig) api changed to streams.update(name: string, config: StreamUpdateConfig) - this shim will be removed - update your code.  [0m")}this.checkStreamConfigVersions(t),je(e);const s=await this.info(e),r=Object.assign(s.config,t);r.mirror=Xs(r.mirror),r.sources=r.sources?.map(Xs);const n=await this._request(`${this.prefix}.STREAM.UPDATE.${e}`,r);return this._fixInfo(n),n}async info(e,t){je(e);const s=`${this.prefix}.STREAM.INFO.${e}`;let r=await this._request(s,t),{total:n,limit:i}=r,o=r.state.subjects?Object.getOwnPropertyNames(r.state.subjects).length:1;if(n&&n>o){const e=[r],a=t||{};let c=0;for(;n>o;){c++,a.offset=i*c;const t=await this._request(s,a);n=t.total,e.push(t);const r=Object.getOwnPropertyNames(t.state.subjects).length;if(o+=r,r<i)break}let h={};for(let t=0;t<e.length;t++)r=e[t],r.state.subjects&&(h=Object.assign(h,r.state.subjects));r.offset=0,r.total=0,r.limit=0,r.state.subjects=h}return this._fixInfo(r),r}list(e=""){const t=e?.length?{subject:e}:{},s=`${this.prefix}.STREAM.LIST`;return new St(s,(e=>{const t=e;return t.streams.forEach((e=>{this._fixInfo(e)})),t.streams}),this,t)}_fixInfo(e){e.config.sealed=e.config.sealed||!1,e.config.deny_delete=e.config.deny_delete||!1,e.config.deny_purge=e.config.deny_purge||!1,e.config.allow_rollup_hdrs=e.config.allow_rollup_hdrs||!1}async purge(e,t){if(t){const{keep:e,seq:s}=t;if("number"==typeof e&&"number"==typeof s)throw new Error("can specify one of keep or seq")}return je(e),await this._request(`${this.prefix}.STREAM.PURGE.${e}`,t)}async deleteMessage(e,t,s=!0){je(e);const r={seq:t};return s||(r.no_erase=!0),(await this._request(`${this.prefix}.STREAM.MSG.DELETE.${e}`,r)).success}async getMessage(e,t){je(e);const s=await this._request(`${this.prefix}.STREAM.MSG.GET.${e}`,t);return new _r(s)}find(e){return this.findStream(e)}listKvs(){const e=`${this.prefix}.STREAM.LIST`;return new St(e,(e=>{const t=e.streams.filter((e=>e.config.name.startsWith(tt)));t.forEach((e=>{this._fixInfo(e)}));let s="";return t.length&&(s=this.nc.info?.cluster??""),t.map((e=>new Vs(e,s)))}),this)}listObjectStores(){const e=`${this.prefix}.STREAM.LIST`;return new St(e,(e=>{const t=e.streams.filter((e=>e.config.name.startsWith(Ws)));return t.forEach((e=>{this._fixInfo(e)})),t.map((e=>new Qs(e)))}),this)}names(e=""){const t=e?.length?{subject:e}:{},s=`${this.prefix}.STREAM.NAMES`;return new St(s,(e=>e.streams),this,t)}async get(e){const t=await this.info(e);return Promise.resolve(new pr(this,t))}}class gr extends vt{constructor(e,t){super(e,t)}async getMessage(e,t){je(e);let s=t;const{last_by_subj:r}=s;r&&(s=null);const n=s?this.jc.encode(s):K,i=this.opts.apiPrefix||"$JS.API",o=r?`${i}.DIRECT.GET.${e}.${r}`:`${i}.DIRECT.GET.${e}`,a=await this.nc.request(o,n),c=Re(a);if(c)return Promise.reject(c);const h=new br(a);return Promise.resolve(h)}async getBatch(e,t){je(e);const s=`${this.opts.apiPrefix||"$JS.API"}.DIRECT.GET.${e}`;if(!Array.isArray(t.multi_last)||0===t.multi_last.length)return Promise.reject("multi_last is required");const r=JSON.stringify(t,((e,t)=>"up_to_time"===e&&t instanceof Date?t.toISOString():t)),n=new Ue,i=await this.nc.requestMany(s,r,{strategy:ie.SentinelMsg});return(async()=>{let e,t=!1,s=!1;for await(const r of i){if(!t){t=!0;const n=r.headers?.code||0;if(0!==n&&n<200||n>299){e=r.headers?.description.toLowerCase();break}const i=r.headers?.get("Nats-Num-Pending");if(""===i){s=!0;break}}if(0===r.data.length)break;n.push(new br(r))}n.push((()=>{if(s)throw new Error("batch direct get not supported by the server");if(e)throw new Error(`bad request: ${e}`);n.stop()}))})(),Promise.resolve(n)}}class br{data;header;static jc;constructor(e){if(!e.headers)throw new Error("headers expected");this.data=e.data,this.header=e.headers}get subject(){return this.header.last(Ze.Subject)}get seq(){const e=this.header.last(Ze.Sequence);return"string"==typeof e?parseInt(e):0}get time(){return new Date(Date.parse(this.timestamp))}get timestamp(){return this.header.last(Ze.TimeStamp)}get stream(){return this.header.last(Ze.Stream)}json(e){return Pe(e).decode(this.data)}string(){return G.decode(this.data)}}class wr extends vt{streams;consumers;direct;constructor(e,t){super(e,t),this.streams=new mr(e,t),this.consumers=new Pt(e,t),this.direct=new gr(e,t)}async getAccountInfo(){return await this._request(`${this.prefix}.INFO`)}jetstream(){return this.nc.jetstream(this.getOptions())}advisories(){const e=new Ue;return this.nc.subscribe("$JS.EVENT.ADVISORY.>",{callback:(t,s)=>{if(t)throw t;try{const t=this.parseJsResponse(s),r=t.type.split("."),n=r[r.length-1];e.push({kind:n,data:t})}catch(t){e.stop(t)}}}),e}}class _r{_header;smr;static jc;constructor(e){this.smr=e}get subject(){return this.smr.message.subject}get seq(){return this.smr.message.seq}get timestamp(){return this.smr.message.time}get time(){return new Date(Date.parse(this.timestamp))}get data(){return this.smr.message.data?this._parse(this.smr.message.data):K}get header(){if(!this._header)if(this.smr.message.hdrs){const e=this._parse(this.smr.message.hdrs);this._header=xe.decode(e)}else this._header=Ee();return this._header}_parse(e){const t=atob(e),s=t.length,r=new Uint8Array(s);for(let e=0;e<s;e++)r[e]=t.charCodeAt(e);return r}json(e){return Pe(e).decode(this.data)}string(){return G.decode(this.data)}}class yr{api;constructor(e){this.api=e}get(e){return this.api.info(e).then((e=>new pr(this.api,e)))}}class vr{info;hdrs;constructor(e){this.info=e}get name(){return this.info.name}get description(){return this.info.description??""}get headers(){return this.hdrs||(this.hdrs=xe.fromRecord(this.info.headers||{})),this.hdrs}get options(){return this.info.options}get bucket(){return this.info.bucket}get chunks(){return this.info.chunks}get deleted(){return this.info.deleted??!1}get digest(){return this.info.digest}get mtime(){return this.info.mtime}get nuid(){return this.info.nuid}get size(){return this.info.size}get revision(){return this.info.revision}get metadata(){return this.info.metadata||{}}isLink(){return void 0!==this.info.options?.link&&null!==this.info.options?.link}}function Sr(e){const t={name:e.name,description:e.description??"",options:e.options,metadata:e.metadata};if(e.headers){const s=e.headers;t.headers=s.toRecord()}return t}class Er{jsm;js;stream;name;constructor(e,t,s){this.name=e,this.jsm=t,this.js=s}_checkNotEmpty(e){return e&&0!==e.length?{name:e}:{name:e,error:new Error("name cannot be empty")}}async info(e){const t=await this.rawInfo(e);return t?new vr(t):null}async list(){const e=[],t=await this.watch({ignoreDeletes:!0,includeHistory:!0});for await(const s of t){if(null===s)break;e.push(s)}return Promise.resolve(e)}async rawInfo(e){const{name:t,error:s}=this._checkNotEmpty(e);if(s)return Promise.reject(s);const r=this._metaSubject(t);try{const e=await this.jsm.streams.getMessage(this.stream,{last_by_subj:r}),t=Pe().decode(e.data);return t.revision=e.seq,t}catch(e){return"404"===e.code?null:Promise.reject(e)}}async _si(e){try{return await this.jsm.streams.info(this.stream,e)}catch(e){return"404"===e.code?null:Promise.reject(e)}}async seal(){let e=await this._si();return null===e?Promise.reject(new Error("object store not found")):(e.config.sealed=!0,e=await this.jsm.streams.update(this.stream,e.config),Promise.resolve(new Qs(e)))}async status(e){const t=await this._si(e);return null===t?Promise.reject(new Error("object store not found")):Promise.resolve(new Qs(t))}destroy(){return this.jsm.streams.delete(this.stream)}async _put(e,t,s){const r=this.js.getOptions();(s=s||{timeout:r.timeout}).timeout=s.timeout||r.timeout,s.previousRevision=s.previousRevision??void 0;const{timeout:n,previousRevision:i}=s,o=this.js.nc.info,a=o?.max_payload||1024;(e=e||{}).options=e.options||{};let c=e.options?.max_chunk_size||131072;c=c>a?a:c,e.options.max_chunk_size=c;const h=await this.info(e.name),{name:u,error:l}=this._checkNotEmpty(e.name);if(l)return Promise.reject(l);const d=Y.next(),f=this._chunkSubject(d),p=this._metaSubject(u),m=Object.assign({bucket:this.name,nuid:d,size:0,chunks:0},Sr(e)),g=be(),b=[],w=new at;try{const s=t?t.getReader():null,r=new bt;for(;;){const{done:t,value:o}=s?await s.read():{done:!0,value:void 0};if(t){if(w.size()>0){const e=w.drain();r.update(e),m.chunks++,m.size+=e.length,b.push(this.js.publish(f,e,{timeout:n}))}await Promise.all(b),b.length=0,m.mtime=(new Date).toISOString();const e=r.digest("base64"),t=e.length%3,s=t>0?"=".repeat(t):"";m.digest=`${Ys}${e}${s}`,m.deleted=!1;const o=Ee();"number"==typeof i&&o.set(Gs.ExpectedLastSubjectSequenceHdr,`${i}`),o.set(Qe.RollupHdr,Qe.RollupValueSubject);const a=await this.js.publish(p,Pe().encode(m),{headers:o,timeout:n});if(m.revision=a.seq,h)try{await this.jsm.streams.purge(this.stream,{filter:`$O.${this.name}.C.${h.nuid}`})}catch(e){}g.resolve(new vr(m));break}if(o)for(w.fill(o);w.size()>c;){m.chunks++,m.size+=c;const t=w.drain(e.options.max_chunk_size);r.update(t),b.push(this.js.publish(f,t,{timeout:n}))}}}catch(e){await this.jsm.streams.purge(this.stream,{filter:f}),g.reject(e)}return g}putBlob(e,t,s){return null===t&&(t=new Uint8Array(0)),this.put(e,function(e){return new ReadableStream({pull(t){t.enqueue(e),t.close()}})}(t),s)}put(e,t,s){return e?.options?.link?Promise.reject(new Error("link cannot be set when putting the object in bucket")):this._put(e,t,s)}async getBlob(e){const t=await this.get(e);if(null===t)return Promise.resolve(null);const s=await Promise.all([t.error,async function(e){const t=new at,s=e.getReader();for(;;){const{done:e,value:r}=await s.read();if(e)return t.drain();r&&r.length&&t.fill(r)}}(t.data)]);return s[0]?Promise.reject(s[0]):Promise.resolve(s[1])}async get(e){const t=await this.rawInfo(e);if(null===t)return Promise.resolve(null);if(t.deleted)return Promise.resolve(null);if(t.options&&t.options.link){const e=t.options.link.name||"";if(""===e)throw new Error("link is a bucket");return(t.options.link.bucket!==this.name?await Er.create(this.js,t.options.link.bucket):this).get(e)}const s=be(),r={info:new vr(t),error:s};if(0===t.size)return r.data=new ReadableStream({pull(e){e.enqueue(new Uint8Array(0)),e.close()}}),s.resolve(null),Promise.resolve(r);let n;const i=rt();i.orderedConsumer();const o=new bt,a=`$O.${this.name}.C.${t.nuid}`,c=await this.js.subscribe(a,i);return(async()=>{for await(const e of c)if(e.data.length>0&&(o.update(e.data),n.enqueue(e.data)),0===e.info.pending){const e=o.digest("base64"),s=e.length%3,r=s>0?"=".repeat(s):"",i=`${Ys}${e}${r}`;i!==t.digest?n.error(new Error(`received a corrupt object, digests do not match received: ${t.digest} calculated ${i}`)):n.close(),c.unsubscribe()}})().then((()=>{s.resolve()})).catch((e=>{n.error(e),s.reject(e)})),r.data=new ReadableStream({start(e){n=e},cancel(){c.unsubscribe()}}),r}linkStore(e,t){if(!(t instanceof Er))return Promise.reject("bucket required");const s=t,{name:r,error:n}=this._checkNotEmpty(e);if(n)return Promise.reject(n);const i={name:r,options:{link:{bucket:s.name}}};return this._put(i,null)}async link(e,t){const{name:s,error:r}=this._checkNotEmpty(e);if(r)return Promise.reject(r);if(t.deleted)return Promise.reject(new Error("src object is deleted"));if(t.isLink())return Promise.reject(new Error("src object is a link"));const n=await this.rawInfo(e);if(null!==n&&!n.deleted)return Promise.reject(new Error("an object already exists with that name"));const i={bucket:t.bucket,name:t.name},o={name:s,bucket:t.bucket,options:{link:i}};await this.js.publish(this._metaSubject(e),JSON.stringify(o));const a=await this.info(e);return Promise.resolve(a)}async delete(e){const t=await this.rawInfo(e);if(null===t)return Promise.resolve({purged:0,success:!1});t.deleted=!0,t.size=0,t.chunks=0,t.digest="";const s=Pe(),r=Ee();return r.set(Qe.RollupHdr,Qe.RollupValueSubject),await this.js.publish(this._metaSubject(t.name),s.encode(t),{headers:r}),this.jsm.streams.purge(this.stream,{filter:this._chunkSubject(t.nuid)})}async update(e,t={}){const s=await this.rawInfo(e);if(null===s)return Promise.reject(new Error("object not found"));if(s.deleted)return Promise.reject(new Error("cannot update meta for a deleted object"));t.name=t.name??s.name;const{name:r,error:n}=this._checkNotEmpty(t.name);if(n)return Promise.reject(n);if(e!==t.name){const e=await this.info(t.name);if(e&&!e.deleted)return Promise.reject(new Error("an object already exists with that name"))}t.name=r;const i=Object.assign({},s,Sr(t)),o=await this.js.publish(this._metaSubject(i.name),JSON.stringify(i));return e!==t.name&&await this.jsm.streams.purge(this.stream,{filter:this._metaSubject(e)}),Promise.resolve(o)}async watch(e={}){e.includeHistory=e.includeHistory??!1,e.ignoreDeletes=e.ignoreDeletes??!1;let t=!1;const s=new Ue,r=this._metaSubjectAll();try{await this.jsm.streams.getMessage(this.stream,{last_by_subj:r})}catch(e){"404"===e.code?(s.push(null),t=!0):s.stop(e)}const n=Pe(),i=rt();i.orderedConsumer(),e.includeHistory?i.deliverLastPerSubject():(t=!0,i.deliverNew()),i.callback(((r,i)=>{if(r)s.stop(r);else if(null!==i){const r=n.decode(i.data);r.deleted&&!0===e.ignoreDeletes||s.push(r),0!==i.info?.pending||t||(t=!0,s.push(null))}}));const o=await this.js.subscribe(r,i);return s._data=o,s.iterClosed.then((()=>{o.unsubscribe()})),o.closed.then((()=>{s.stop()})).catch((e=>{s.stop(e)})),s}_chunkSubject(e){return`$O.${this.name}.C.${e}`}_metaSubject(e){return`$O.${this.name}.M.${ot.encode(e)}`}_metaSubjectAll(){return`$O.${this.name}.M.>`}async init(e={}){try{this.stream=(zs(t=this.name),`${Ws}${t}`)}catch(e){return Promise.reject(e)}var t;const s=e?.ttl||0;delete e.ttl;const r=Object.assign({max_age:s},e);r.name=this.stream,r.allow_direct=!0,r.allow_rollup_hdrs=!0,r.discard=He.New,r.subjects=[`$O.${this.name}.C.>`,`$O.${this.name}.M.>`],e.placement&&(r.placement=e.placement),e.metadata&&(r.metadata=e.metadata),"boolean"==typeof e.compression&&(r.compression=e.compression?Ve.S2:Ve.None);try{await this.jsm.streams.info(r.name)}catch(e){"stream not found"===e.message&&await this.jsm.streams.add(r)}}static async create(e,t,s={}){const r=await e.jetstreamManager(),n=new Er(t,r,e);return await n.init(s),Promise.resolve(n)}}class kr{js;constructor(e){this.js=e}kv(e,t={}){const s=this.js,{ok:r,min:n}=s.nc.features.get(xt.JS_KV);return r?t.bindOnly?Js.bind(this.js,e,t):Js.create(this.js,e,t):Promise.reject(new Error(`kv is only supported on servers ${n} or better`))}os(e,t={}){if("function"!=typeof crypto?.subtle?.digest)return Promise.reject(new Error("objectstore: unable to calculate hashes - crypto.subtle.digest with sha256 support is required"));const s=this.js,{ok:r,min:n}=s.nc.features.get(xt.JS_OBJECTSTORE);return r?Er.create(this.js,e,t):Promise.reject(new Error(`objectstore is only supported on servers ${n} or better`))}}class xr extends vt{consumers;streams;consumerAPI;streamAPI;constructor(e,t){super(e,t),this.consumerAPI=new Pt(e,t),this.streamAPI=new mr(e,t),this.consumers=new fr(this.consumerAPI),this.streams=new yr(this.streamAPI)}jetstreamManager(e){void 0===e&&(e=this.opts.checkAPI);const t=Object.assign({},this.opts,{checkAPI:e});return this.nc.jetstreamManager(t)}get apiPrefix(){return this.prefix}get views(){return new kr(this)}async publish(e,t=K,s){(s=s||{}).expect=s.expect||{};const r=s?.headers||Ee();s&&(s.msgID&&r.set(Gs.MsgIdHdr,s.msgID),s.expect.lastMsgID&&r.set(Gs.ExpectedLastMsgIdHdr,s.expect.lastMsgID),s.expect.streamName&&r.set(Gs.ExpectedStreamHdr,s.expect.streamName),"number"==typeof s.expect.lastSequence&&r.set(Gs.ExpectedLastSeqHdr,`${s.expect.lastSequence}`),"number"==typeof s.expect.lastSubjectSequence&&r.set(Gs.ExpectedLastSubjectSequenceHdr,`${s.expect.lastSubjectSequence}`));const n=s.timeout||this.timeout,i={};n&&(i.timeout=n),s&&(i.headers=r);let o,{retries:a,retry_delay:c}=s;a=a||1,c=c||250;for(let s=0;s<a;s++)try{o=await this.nc.request(e,t,i);break}catch(e){if(!("503"===e.code&&s+1<a))throw e;await ge(c)}const h=this.parseJsResponse(o);if(""===h.stream)throw re.errorForCode(Z.JetStreamInvalidAck);return h.duplicate=!!h.duplicate&&h.duplicate,h}async pull(e,t,s=0){je(e),Oe(t);let r=this.timeout;s>r&&(r=s);const n={batch:1,no_wait:0===(s=s<0?0:ye(s)),expires:s},i=await this.nc.request(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(n),{noMux:!0,timeout:r}),o=Re(i);if(o)throw o;return cr(i)}fetch(e,t,s={}){je(e),Oe(t);let r=null;const n=(s.max_bytes??0)>0;let i=0;const o=n?s.max_bytes:0;let a=null;const c={};if(c.batch=s.batch||1,o){const e=this.nc.features.get(xt.JS_PULL_MAX_BYTES);if(!e.ok)throw new Error(`max_bytes is only supported on servers ${e.min} or better`);c.max_bytes=o}c.no_wait=s.no_wait||!1,c.no_wait&&c.expires&&(c.expires=0);const h=s.expires||0;if(h&&(c.expires=ye(h)),0===h&&!1===c.no_wait)throw new Error("expires or no_wait is required");const u=s.idle_heartbeat||0;u&&(c.idle_heartbeat=ye(u),!0===s.delay_heartbeat&&(c.idle_heartbeat=ye(4*u)));const l=new Ue,d=c.batch;let f=0;l.protocolFilterFn=(e,t=!1)=>!Le(e.msg)||(a?.work(),!1),l.dispatchedFn=e=>{if(e){if(n&&(i+=e.data.length),f++,r&&0===e.info.pending)return;(1===l.getPending()&&0===e.info.pending||d===f||o>0&&i>=o)&&l.stop()}};const p=ue(this.nc.options.inboxPrefix),m=this.nc.subscribe(p,{max:s.batch,callback:(e,t)=>{null===e&&(e=Re(t)),null!==e?(r&&(r.cancel(),r=null),function(e){return"string"==typeof e.code}(e)?l.stop(null===Mr(e)?void 0:e):l.stop(e)):(a?.work(),l.received++,l.push(cr(t)))}});return h&&(r=me(h),r.catch((()=>{m.isClosed()||(m.drain().catch((()=>{})),r=null),a&&a.cancel()}))),(async()=>{try{u&&(a=new Fe(u,(e=>(l.push((()=>{l.err=new re(`${De.IdleHeartbeatMissed}: ${e}`,Z.JetStreamIdleHeartBeat)})),!0))))}catch(e){}await m.closed,null!==r&&(r.cancel(),r=null),a&&a.cancel(),l.stop()})().catch(),this.nc.publish(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(c),{reply:p}),l}async pullSubscribe(e,t=rt()){const s=await this._processOptions(e,t);if(s.ordered)throw new Error("pull subscribers cannot be be ordered");if(s.config.deliver_subject)throw new Error("consumer info specifies deliver_subject - pull consumers cannot have deliver_subject set");const r=s.config.ack_policy;if(r===Ge.None||r===Ge.All)throw new Error("ack policy for pull consumers must be explicit");const n=this._buildTypedSubscriptionOpts(s),i=new jr(this,s.deliver,n);i.info=s;try{await this._maybeCreateConsumer(s)}catch(e){throw i.unsubscribe(),e}return i}async subscribe(e,t=rt()){const s=await this._processOptions(e,t);if(!s.isBind&&!s.config.deliver_subject)throw new Error("push consumer requires deliver_subject");const r=this._buildTypedSubscriptionOpts(s),n=new Or(this,s.deliver,r);n.info=s;try{await this._maybeCreateConsumer(s)}catch(e){throw n.unsubscribe(),e}return n._maybeSetupHbMonitoring(),n}async _processOptions(e,t=rt()){const s=nt(t)?t.getOpts():t;if(s.isBind=!!nt(t)&&t.isBind,s.flow_control={heartbeat_count:0,fc_count:0,consumer_restarts:0},s.ordered){if(s.ordered_consumer_sequence={stream_seq:0,delivery_seq:0},s.config.ack_policy!==Ge.NotSet&&s.config.ack_policy!==Ge.None)throw new re("ordered consumer: ack_policy can only be set to 'none'",Z.ApiError);if(s.config.durable_name&&s.config.durable_name.length>0)throw new re("ordered consumer: durable_name cannot be set",Z.ApiError);if(s.config.deliver_subject&&s.config.deliver_subject.length>0)throw new re("ordered consumer: deliver_subject cannot be set",Z.ApiError);if(void 0!==s.config.max_deliver&&s.config.max_deliver>1)throw new re("ordered consumer: max_deliver cannot be set",Z.ApiError);if(s.config.deliver_group&&s.config.deliver_group.length>0)throw new re("ordered consumer: deliver_group cannot be set",Z.ApiError);s.config.deliver_subject=ue(this.nc.options.inboxPrefix),s.config.ack_policy=Ge.None,s.config.max_deliver=1,s.config.flow_control=!0,s.config.idle_heartbeat=s.config.idle_heartbeat||ye(5e3),s.config.ack_wait=ye(792e5),s.config.mem_storage=!0,s.config.num_replicas=1}if(s.config.ack_policy===Ge.NotSet&&(s.config.ack_policy=Ge.All),s.api=this,s.config=s.config||{},s.stream=s.stream?s.stream:await this.findStream(e),s.attached=!1,s.config.durable_name)try{const t=await this.consumerAPI.info(s.stream,s.config.durable_name);if(t){if(t.config.filter_subject&&t.config.filter_subject!==e)throw new Error("subject does not match consumer");const r=s.config.deliver_group??"";if(""===r&&!0===t.push_bound)throw new Error("duplicate subscription");const n=t.config.deliver_group??"";if(r!==n)throw""===n?new Error("durable requires no queue group"):new Error(`durable requires queue group '${n}'`);s.last=t,s.config=t.config,s.attached=!0,s.config.durable_name||(s.name=t.name)}}catch(e){if("404"!==e.code)throw e}return s.attached||void 0!==s.config.filter_subject||void 0!==s.config.filter_subjects||(s.config.filter_subject=e),s.deliver=s.config.deliver_subject||ue(this.nc.options.inboxPrefix),s}_buildTypedSubscriptionOpts(e){const t={};return t.adapter=void 0===e.callbackFn?Nr:Tr,t.ingestionFilterFn=xr.ingestionFn(e.ordered),t.protocolFilterFn=(e,t=!1)=>{const s=e;return!Me(s.msg)||(t||s.msg.respond(),!1)},e.mack||e.config.ack_policy===Ge.None||(t.dispatchedFn=Lr),e.callbackFn&&(t.callback=e.callbackFn),t.max=e.max||0,t.queue=e.queue,t}async _maybeCreateConsumer(e){if(e.attached)return;if(e.isBind)throw new Error(`unable to bind - durable consumer ${e.config.durable_name} doesn't exist in ${e.stream}`);e.config=Object.assign({deliver_policy:ze.All,ack_policy:Ge.Explicit,ack_wait:ye(3e4),replay_policy:Je.Instant},e.config);const t=await this.consumerAPI.add(e.stream,e.config);if(Array.isArray(e.config.filter_subjects&&!Array.isArray(t.config.filter_subjects)))throw new Error("jetstream server doesn't support consumers with multiple filter subjects");e.name=t.name,e.config=t.config,e.last=t}static ingestionFn(e){return(t,s)=>{const r=s;if(!t)return{ingest:!1,protocol:!1};const n=t;if(Re(n.msg)||r.monitor?.work(),Le(n.msg)){const t=!e||r._checkHbOrderConsumer(n.msg);return e||r.info.flow_control.heartbeat_count++,{ingest:t,protocol:!0}}return Me(n.msg)?(r.info.flow_control.fc_count++,{ingest:!0,protocol:!0}):{ingest:!e||r._checkOrderedConsumer(t),protocol:!1}}}}class Cr{options;protocol;draining;listeners;_services;constructor(e){this.draining=!1,this.options=xs(e),this.listeners=[]}static connect(e={}){return new Promise(((t,s)=>{const r=new Cr(e);Ts.connect(r.options,r).then((e=>{r.protocol=e,async function(){for await(const t of e.status())r.listeners.forEach((e=>{e.push(t)}))}(),t(r)})).catch((e=>{s(e)}))}))}closed(){return this.protocol.closed}async close(){await this.protocol.close()}_check(e,t,s){if(this.isClosed())throw re.errorForCode(Z.ConnectionClosed);if(t&&this.isDraining())throw re.errorForCode(Z.ConnectionDraining);if(s&&this.protocol.noMorePublishing)throw re.errorForCode(Z.ConnectionDraining);if(0===(e=e||"").length)throw re.errorForCode(Z.BadSubject)}publish(e,t,s){this._check(e,!1,!0),this.protocol.publish(e,t,s)}publishMessage(e){return this.publish(e.subject,e.data,{reply:e.reply,headers:e.headers})}respondMessage(e){return!!e.reply&&(this.publish(e.reply,e.data,{reply:e.reply,headers:e.headers}),!0)}subscribe(e,t={}){this._check(e,!0,!1);const s=new Os(this.protocol,e,t);return this.protocol.subscribe(s),s}_resub(e,t,s){this._check(t,!0,!1);const r=e;r.max=s,s&&(r.max=s+r.received),this.protocol.resub(r,t)}requestMany(e,t=K,s={maxWait:1e3,maxMessages:-1}){const r=!this.protocol.options.noAsyncTraces;try{this._check(e,!0,!0)}catch(e){return Promise.reject(e)}if(s.strategy=s.strategy||ie.Timer,s.maxWait=s.maxWait||1e3,s.maxWait<1)return Promise.reject(new re("timeout",Z.InvalidOption));const n=new Ue;function i(e){n.push((()=>{n.stop(e)}))}function o(e,t){e||null===t?i(null===e?void 0:e):n.push(t)}if(s.noMux){const a=r?(new Error).stack:null;let c="number"==typeof s.maxMessages&&s.maxMessages>0?s.maxMessages:-1;const h=this.subscribe(ue(this.options.inboxPrefix),{callback:(e,t)=>{if(0===t?.data?.length&&t?.headers?.status===Z.NoResponders&&(e=re.errorForCode(Z.NoResponders)),e)return a&&(e.stack+=`\n\n${a}`),void u(e);o(null,t),s.strategy===ie.Count&&(c--,0===c&&u()),s.strategy===ie.JitterTimer&&(d(),l=setTimeout((()=>{u()}),300)),s.strategy===ie.SentinelMsg&&t&&0===t.data.length&&u()}});h.closed.then((()=>{i()})).catch((e=>{n.stop(e)}));const u=e=>{e&&n.push((()=>{throw e})),d(),h.drain().then((()=>{i()})).catch((e=>{i()}))};n.iterClosed.then((()=>{d(),h?.unsubscribe()})).catch((e=>{d(),h?.unsubscribe()}));try{this.publish(e,t,{reply:h.getSubject()})}catch(e){u(e)}let l=setTimeout((()=>{u()}),s.maxWait);const d=()=>{l&&clearTimeout(l)}}else{const r=s;r.callback=o,n.iterClosed.then((()=>{i.cancel()})).catch((e=>{i.cancel(e)}));const i=new _t(this.protocol.muxSubscriptions,e,r);this.protocol.request(i);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${i.token}`,headers:s.headers})}catch(e){i.cancel(e)}}return Promise.resolve(n)}request(e,t,s={timeout:1e3,noMux:!1}){try{this._check(e,!0,!0)}catch(e){return Promise.reject(e)}const r=!this.protocol.options.noAsyncTraces;if(s.timeout=s.timeout||1e3,s.timeout<1)return Promise.reject(new re("timeout",Z.InvalidOption));if(!s.noMux&&s.reply)return Promise.reject(new re("reply can only be used with noMux",Z.InvalidOption));if(s.noMux){const n=s.reply?s.reply:ue(this.options.inboxPrefix),i=be(),o=r?new Error:null;return this.subscribe(n,{max:1,timeout:s.timeout,callback:(e,t)=>{e?(o&&e.code!==Z.Timeout&&(e.stack+=`\n\n${o.stack}`),i.reject(e)):(e=Ie(t))?(o&&(e.stack+=`\n\n${o.stack}`),i.reject(e)):i.resolve(t)}}).requestSubject=e,this.protocol.publish(e,t,{reply:n,headers:s.headers}),i}{const n=new yt(this.protocol.muxSubscriptions,e,s,r);this.protocol.request(n);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${n.token}`,headers:s.headers})}catch(e){n.cancel(e)}const i=Promise.race([n.timer,n.deferred]);return i.catch((()=>{n.cancel()})),i}}flush(){return this.isClosed()?Promise.reject(re.errorForCode(Z.ConnectionClosed)):this.protocol.flush()}drain(){return this.isClosed()?Promise.reject(re.errorForCode(Z.ConnectionClosed)):this.isDraining()?Promise.reject(re.errorForCode(Z.ConnectionDraining)):(this.draining=!0,this.protocol.drain())}isClosed(){return this.protocol.isClosed()}isDraining(){return this.draining}getServer(){const e=this.protocol.getServer();return e?e.listen:""}status(){const e=new Ue;return e.iterClosed.then((()=>{const t=this.listeners.indexOf(e);this.listeners.splice(t,1)})),this.listeners.push(e),e}get info(){return this.protocol.isClosed()?void 0:this.protocol.info}async context(){return(await this.request("$SYS.REQ.USER.INFO")).json(((e,t)=>"time"===e?new Date(Date.parse(t)):t))}stats(){return{inBytes:this.protocol.inBytes,outBytes:this.protocol.outBytes,inMsgs:this.protocol.inMsgs,outMsgs:this.protocol.outMsgs}}async jetstreamManager(e={}){const t=new wr(this,e);if(!1!==e.checkAPI)try{await t.getAccountInfo()}catch(e){const t=e;throw t.code===Z.NoResponders&&(t.code=Z.JetStreamNotEnabled),t}return t}jetstream(e={}){return new xr(this,e)}getServerVersion(){const e=this.info;return e?Et(e.version):void 0}async rtt(){if(!this.protocol._closed&&!this.protocol.connected)throw re.errorForCode(Z.Disconnect);const e=Date.now();return await this.flush(),Date.now()-e}get features(){return this.protocol.features}get services(){return this._services||(this._services=new Pr(this)),this._services}reconnect(){return this.isClosed()?Promise.reject(re.errorForCode(Z.ConnectionClosed)):this.isDraining()?Promise.reject(re.errorForCode(Z.ConnectionDraining)):this.protocol.reconnect()}}class Pr{nc;constructor(e){this.nc=e}add(e){try{return new Ls(this.nc,e).start()}catch(e){return Promise.reject(e)}}client(e,t){return new Ds(this.nc,e,t)}}class Ir{bucket;sm;prefixLen;constructor(e,t,s){this.bucket=e,this.prefixLen=t,this.sm=s}get key(){return this.sm.subject.substring(this.prefixLen)}get value(){return this.sm.data}get delta(){return 0}get created(){return this.sm.time}get revision(){return this.sm.seq}get operation(){return this.sm.header.get(Bs)||"PUT"}get length(){const e=this.sm.header.get(Qe.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class Ar{bucket;key;sm;constructor(e,t,s){this.bucket=e,this.key=t,this.sm=s}get value(){return this.sm.data}get created(){return new Date(ve(this.sm.info.timestampNanos))}get revision(){return this.sm.seq}get operation(){return this.sm.headers?.get(Bs)||"PUT"}get delta(){return this.sm.info.pending}get length(){const e=this.sm.headers?.get(Qe.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class Or extends At{js;monitor;constructor(e,t,s){super(e.nc,t,s),this.js=e,this.monitor=null,this.sub.closed.then((()=>{this.monitor&&this.monitor.cancel()}))}set info(e){this.sub.info=e}get info(){return this.sub.info}_resetOrderedConsumer(e){if(null===this.info||this.sub.isClosed())return;const t=ue(this.js.nc.options.inboxPrefix);this.js.nc._resub(this.sub,t);const s=this.info;s.config.name=Y.next(),s.ordered_consumer_sequence.delivery_seq=0,s.flow_control.heartbeat_count=0,s.flow_control.fc_count=0,s.flow_control.consumer_restarts++,s.deliver=t,s.config.deliver_subject=t,s.config.deliver_policy=ze.StartSequence,s.config.opt_start_seq=e;const r={};r.stream_name=this.info.stream,r.config=s.config;const n=`${s.api.prefix}.CONSUMER.CREATE.${s.stream}`;this.js._request(n,r,{retries:-1}).then((e=>{const t=e;this.sub.info.last=t,this.info.config=t.config,this.info.name=t.name})).catch((t=>{const r=new re(`unable to recreate ordered consumer ${s.stream} at seq ${e}`,Z.RequestError,t);this.sub.callback(r,{})}))}_maybeSetupHbMonitoring(){const e=this.info?.config?.idle_heartbeat||0;e&&this._setupHbMonitoring(ve(e))}_setupHbMonitoring(e,t=0){const s={cancelAfter:0,maxOut:2};t&&(s.cancelAfter=t);const r=this.sub;this.monitor=new Fe(e,(e=>{const t=function(e,t,s){const r=Ee(409,t),n=new Ae({hdr:1,sid:0,size:0},K,{});return n._headers=r,n._subject=s,n}(0,`${De.IdleHeartbeatMissed}: ${e}`,this.sub.subject),s=this.info?.ordered;if(s){if(!this.js.nc.protocol.connected)return!1;const e=this.info?.ordered_consumer_sequence?.stream_seq||0;return this._resetOrderedConsumer(e+1),this.monitor?.restart(),!1}return this.sub.callback(null,t),!r.noIterator}),s)}_checkHbOrderConsumer(e){const t=e.headers.get(Qe.ConsumerStalledHdr);""!==t&&this.js.nc.publish(t);const s=parseInt(e.headers.get(Qe.LastConsumerSeqHdr),10),r=this.info.ordered_consumer_sequence;return this.info.flow_control.heartbeat_count++,s!==r.delivery_seq&&this._resetOrderedConsumer(r.stream_seq+1),!1}_checkOrderedConsumer(e){const t=this.info.ordered_consumer_sequence,s=e.info.streamSequence,r=e.info.deliverySequence;return r!=t.delivery_seq+1?(this._resetOrderedConsumer(t.stream_seq+1),!1):(t.delivery_seq=r,t.stream_seq=s,!0)}async destroy(){this.isClosed()||await this.drain();const e=this.sub.info,t=e.config.durable_name||e.name,s=`${e.api.prefix}.CONSUMER.DELETE.${e.stream}.${t}`;await e.api._request(s)}async consumerInfo(){const e=this.sub.info,t=e.config.durable_name||e.name,s=`${e.api.prefix}.CONSUMER.INFO.${e.stream}.${t}`,r=await e.api._request(s);return e.last=r,r}}class jr extends Or{constructor(e,t,s){super(e,t,s)}pull(e={batch:1}){const{stream:t,config:s,name:r}=this.sub.info,n=s.durable_name??r,i={};if(i.batch=e.batch||1,i.no_wait=e.no_wait||!1,(e.max_bytes??0)>0){const t=this.js.nc.features.get(xt.JS_PULL_MAX_BYTES);if(!t.ok)throw new Error(`max_bytes is only supported on servers ${t.min} or better`);i.max_bytes=e.max_bytes}let o=0;e.expires&&e.expires>0&&(o=e.expires,i.expires=ye(o));let a=0;if(e.idle_heartbeat&&e.idle_heartbeat>0&&(a=e.idle_heartbeat,i.idle_heartbeat=ye(a)),a&&0===o)throw new Error("idle_heartbeat requires expires");if(a>o)throw new Error("expires must be greater than idle_heartbeat");if(this.info){this.monitor&&this.monitor.cancel(),o&&a&&(this.monitor?this.monitor._change(a,o):this._setupHbMonitoring(a,o));const e=this.info.api,s=`${e.prefix}.CONSUMER.MSG.NEXT.${t}.${n}`,r=this.sub.subject;e.nc.publish(s,e.jc.encode(i),{reply:r})}}}function Tr(e,t){return e||(e=Re(t))?[e,null]:[null,cr(t)]}function Nr(e,t){if(e)return[e,null];const s=Re(t);return null!==s?[Mr(s),null]:[null,cr(t)]}function Mr(e){if(null!==e)switch(e.code){case Z.JetStream404NoMessages:case Z.JetStream408RequestTimeout:return null;case Z.JetStream409:return function(e){if(e.code!==Z.JetStream409)return!1;const t=[De.MaxBatchExceeded,De.MaxExpiresExceeded,De.MaxBytesExceeded,De.MaxMessageSizeExceeded,De.PushConsumer,De.IdleHeartbeatMissed,De.ConsumerDeleted];return Be&&t.push(De.MaxWaitingExceeded),void 0!==t.find((t=>-1!==e.message.indexOf(t)))}(e)?e:null;default:return e}return null}function Lr(e){e&&e.ack()}class Rr{msg;di;didAck;constructor(e){this.msg=e,this.didAck=!1}get subject(){return this.msg.subject}get sid(){return this.msg.sid}get data(){return this.msg.data}get headers(){return this.msg.headers}get info(){return this.di||(this.di=function(e){const t=e.split(".");if(9===t.length&&t.splice(2,0,"_",""),t.length<11||"$JS"!==t[0]||"ACK"!==t[1])throw new Error("not js message");const s={};return s.domain="_"===t[2]?"":t[2],s.account_hash=t[3],s.stream=t[4],s.consumer=t[5],s.redeliveryCount=parseInt(t[6],10),s.redelivered=s.redeliveryCount>1,s.streamSequence=parseInt(t[7],10),s.deliverySequence=parseInt(t[8],10),s.timestampNanos=parseInt(t[9],10),s.pending=parseInt(t[10],10),s}(this.reply)),this.di}get redelivered(){return this.info.redeliveryCount>1}get reply(){return this.msg.reply||""}get seq(){return this.info.streamSequence}doAck(e){this.didAck||(this.didAck=!this.isWIP(e),this.msg.respond(e))}isWIP(e){return 4===e.length&&e[0]===nr[0]&&e[1]===nr[1]&&e[2]===nr[2]&&e[3]===nr[3]}async ackAck(){const e=be();if(this.didAck)e.resolve(!1);else if(this.didAck=!0,this.msg.reply){const t=this.msg.publisher,s=!t.options?.noAsyncTraces,r=new yt(t.muxSubscriptions,this.msg.reply,{timeout:1e3},s);t.request(r);try{t.publish(this.msg.reply,sr,{reply:`${t.muxSubscriptions.baseInbox}${r.token}`})}catch(e){r.cancel(e)}try{await Promise.race([r.timer,r.deferred]),e.resolve(!0)}catch(t){r.cancel(t),e.reject(t)}}else e.resolve(!1);return e}ack(){this.doAck(sr)}nak(e){let t=rr;e&&(t=Ce().encode(`-NAK ${JSON.stringify({delay:ye(e)})}`)),this.doAck(t)}working(){this.doAck(nr)}next(e,t={batch:1}){const s={};s.batch=t.batch||1,s.no_wait=t.no_wait||!1,t.expires&&t.expires>0&&(s.expires=ye(t.expires));const r=Pe().encode(s),n=at.concat(ir,ar,r),i=e?{reply:e}:void 0;this.msg.respond(n,i)}term(e=""){let t=or;e?.length>0&&(t=Ce().encode(`+TERM ${e}`)),this.doAck(t)}json(){return this.msg.json()}string(){return this.msg.string()}}class Dr{version;lang;closeError;connected;done;socket;options;socketClosed;encrypted;peeked;yields;signal;closedNotification;constructor(){this.version="1.27.0",this.lang="nats.ws",this.connected=!1,this.done=!1,this.socketClosed=!1,this.encrypted=!1,this.peeked=!1,this.yields=[],this.signal=be(),this.closedNotification=be()}async connect(e,t){const s=be();if(t.tls)return s.reject(new re("tls",Z.InvalidOption)),s;this.options=t;const r=e.src;if(t.wsFactory){const{socket:s,encrypted:r}=await t.wsFactory(e.src,t);this.socket=s,this.encrypted=r}else this.encrypted=0===r.indexOf("wss://"),this.socket=new WebSocket(r);return this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{this.isDiscarded()},this.socket.onmessage=e=>{if(this.isDiscarded())return;if(this.yields.push(new Uint8Array(e.data)),this.peeked)return void this.signal.resolve();const r=at.concat(...this.yields),n=function(e){const t=function(e){for(let t=0;t<e.length;t++){const s=t+1;if(e.byteLength>s&&e[t]===Rt&&e[s]===Dt)return s+1}return 0}(e);if(t>0){const s=new Uint8Array(e).slice(0,t);return G.decode(s)}return""}(r);if(""!==n){const e=Cs.exec(n);if(!e)return t.debug&&console.error("!!!",pe(r)),void s.reject(new Error("unexpected response from server"));try{!function(e,t){const{proto:s,tls_required:r,tls_available:n}=e;if((void 0===s||s<1)&&t.noEcho)throw new re("noEcho",Z.ServerOptionNotAvailable);const i=r||n||!1;if(t.tls&&!i)throw new re("tls",Z.ServerOptionNotAvailable)}(JSON.parse(e[1]),this.options),this.peeked=!0,this.connected=!0,this.signal.resolve(),s.resolve()}catch(e){return void s.reject(e)}}},this.socket.onclose=e=>{if(this.isDiscarded())return;let t;this.socketClosed=!0,this.done||(e.wasClean||(t=new Error(e.reason)),this._closed(t))},this.socket.onerror=e=>{if(this.isDiscarded())return;const t=e,r=new re(t.message,Z.Unknown,new Error(t.error));s.reject(r)},s}disconnect(){this._closed(void 0,!0)}async _closed(e,t=!0){if(!this.isDiscarded()&&this.connected&&!this.done){if(this.closeError=e,!e)for(;!this.socketClosed&&this.socket.bufferedAmount>0;)await ge(100);this.done=!0;try{this.socket.close(e?1002:1e3,e?e.message:void 0)}catch(e){}t&&this.closedNotification.resolve(e)}}get isClosed(){return this.done}[Symbol.asyncIterator](){return this.iterate()}async*iterate(){for(;;){if(this.isDiscarded())return;0===this.yields.length&&await this.signal;const e=this.yields;this.yields=[];for(let t=0;t<e.length;t++)this.options.debug&&console.info(`> ${pe(e[t])}`),yield e[t];if(this.done)break;0===this.yields.length&&(e.length=0,this.yields=e,this.signal=be())}}isEncrypted(){return this.connected&&this.encrypted}send(e){if(!this.isDiscarded())try{return this.socket.send(e.buffer),void(this.options.debug&&console.info(`< ${pe(e)}`))}catch(t){this.options.debug&&console.error(`!!! ${pe(e)}: ${t}`)}}close(e){return this._closed(e,!1)}closed(){return this.closedNotification}isDiscarded(){return!!this.done&&(this.discard(),!0)}discard(){this.done=!0;try{this.socket?.close()}catch(e){}}}function Br(e,t){/^(.*:\/\/)(.*)/.test(e)||(e="boolean"==typeof t?`${!0===t?"https":"http"}://${e}`:`https://${e}`);let s=new URL(e);const r=s.protocol.toLowerCase();let n,i;"ws:"===r&&(t=!1),"wss:"===r&&(t=!0),"https:"!==r&&"http"!==r&&(e=e.replace(/^(.*:\/\/)(.*)/gm,"$2"),s=new URL(`http://${e}`));const o=s.hostname,a=s.pathname,c=s.search||"";switch(r){case"http:":case"ws:":case"nats:":i=s.port||"80",n="ws:";break;case"https:":case"wss:":case"tls:":i=s.port||"443",n="wss:";break;default:i=s.port||!0===t?"443":"80",n=!0===t?"wss:":"ws:"}return`${n}//${o}:${i}${a}${c}`}const $r=function(e){const t=[];let s=0;for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);n<128?t[s++]=n:n<2048?(t[s++]=n>>6|192,t[s++]=63&n|128):55296==(64512&n)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(n=65536+((1023&n)<<10)+(1023&e.charCodeAt(++r)),t[s++]=n>>18|240,t[s++]=n>>12&63|128,t[s++]=n>>6&63|128,t[s++]=63&n|128):(t[s++]=n>>12|224,t[s++]=n>>6&63|128,t[s++]=63&n|128)}return t},Ur={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const s=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let t=0;t<e.length;t+=3){const n=e[t],i=t+1<e.length,o=i?e[t+1]:0,a=t+2<e.length,c=a?e[t+2]:0,h=n>>2,u=(3&n)<<4|o>>4;let l=(15&o)<<2|c>>6,d=63&c;a||(d=64,i||(l=64)),r.push(s[h],s[u],s[l],s[d])}return r.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray($r(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let s=0,r=0;for(;s<e.length;){const n=e[s++];if(n<128)t[r++]=String.fromCharCode(n);else if(n>191&&n<224){const i=e[s++];t[r++]=String.fromCharCode((31&n)<<6|63&i)}else if(n>239&&n<365){const i=((7&n)<<18|(63&e[s++])<<12|(63&e[s++])<<6|63&e[s++])-65536;t[r++]=String.fromCharCode(55296+(i>>10)),t[r++]=String.fromCharCode(56320+(1023&i))}else{const i=e[s++],o=e[s++];t[r++]=String.fromCharCode((15&n)<<12|(63&i)<<6|63&o)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const s=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let t=0;t<e.length;){const n=s[e.charAt(t++)],i=t<e.length?s[e.charAt(t)]:0;++t;const o=t<e.length?s[e.charAt(t)]:64;++t;const a=t<e.length?s[e.charAt(t)]:64;if(++t,null==n||null==i||null==o||null==a)throw new Fr;const c=n<<2|i>>4;if(r.push(c),64!==o){const e=i<<4&240|o>>2;if(r.push(e),64!==a){const e=o<<6&192|a;r.push(e)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class Fr extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const qr=function(e){return function(e){const t=$r(e);return Ur.encodeByteArray(t,!0)}(e).replace(/\./g,"")},Hr=()=>{try{return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==r.g)return r.g;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__||(()=>{if("undefined"==typeof process||void 0===process.env)return;const e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0})()||(()=>{if("undefined"==typeof document)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}const t=e&&function(e){try{return Ur.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)})()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}},Kr=()=>{var e;return null===(e=Hr())||void 0===e?void 0:e.config};class zr{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),"function"==typeof e&&(this.promise.catch((()=>{})),1===e.length?e(t):e(t,s))}}}function Gr(){try{return"object"==typeof indexedDB}catch(e){return!1}}function Jr(){return new Promise(((e,t)=>{try{let s=!0;const r="validate-browser-context-for-indexeddb-analytics-module",n=self.indexedDB.open(r);n.onsuccess=()=>{n.result.close(),s||self.indexedDB.deleteDatabase(r),e(!0)},n.onupgradeneeded=()=>{s=!1},n.onerror=()=>{var e;t((null===(e=n.error)||void 0===e?void 0:e.message)||"")}}catch(e){t(e)}}))}class Vr extends Error{constructor(e,t,s){super(t),this.code=e,this.customData=s,this.name="FirebaseError",Object.setPrototypeOf(this,Vr.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Wr.prototype.create)}}class Wr{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},r=`${this.service}/${e}`,n=this.errors[e],i=n?function(e,t){return e.replace(Yr,((e,s)=>{const r=t[s];return null!=r?String(r):`<${s}?>`}))}(n,s):"Error",o=`${this.serviceName}: ${i} (${r}).`;return new Vr(r,o,s)}}const Yr=/\{\$([^}]+)}/g;function Qr(e,t){if(e===t)return!0;const s=Object.keys(e),r=Object.keys(t);for(const n of s){if(!r.includes(n))return!1;const s=e[n],i=t[n];if(Xr(s)&&Xr(i)){if(!Qr(s,i))return!1}else if(s!==i)return!1}for(const e of r)if(!s.includes(e))return!1;return!0}function Xr(e){return null!==e&&"object"==typeof e}function Zr(e){return e&&e._delegate?e._delegate:e}class en{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const tn="[DEFAULT]";class sn{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const e=new zr;if(this.instancesDeferred.set(t,e),this.isInitialized(t)||this.shouldAutoInitialize())try{const s=this.getOrInitializeService({instanceIdentifier:t});s&&e.resolve(s)}catch(e){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const s=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),r=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(s)&&!this.shouldAutoInitialize()){if(r)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:s})}catch(e){if(r)return null;throw e}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:tn})}catch(e){}for(const[e,t]of this.instancesDeferred.entries()){const s=this.normalizeInstanceIdentifier(e);try{const e=this.getOrInitializeService({instanceIdentifier:s});t.resolve(e)}catch(e){}}}}clearInstance(e=tn){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter((e=>"INTERNAL"in e)).map((e=>e.INTERNAL.delete())),...e.filter((e=>"_delete"in e)).map((e=>e._delete()))])}isComponentSet(){return null!=this.component}isInitialized(e=tn){return this.instances.has(e)}getOptions(e=tn){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const r=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[e,t]of this.instancesDeferred.entries())s===this.normalizeInstanceIdentifier(e)&&t.resolve(r);return r}onInit(e,t){var s;const r=this.normalizeInstanceIdentifier(t),n=null!==(s=this.onInitCallbacks.get(r))&&void 0!==s?s:new Set;n.add(e),this.onInitCallbacks.set(r,n);const i=this.instances.get(r);return i&&e(i,r),()=>{n.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const r of s)try{r(e,t)}catch(e){}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:(r=e,r===tn?void 0:r),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch(e){}var r;return s||null}normalizeInstanceIdentifier(e=tn){return this.component?this.component.multipleInstances?e:tn:e}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class rn{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new sn(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}const nn=[];var on;!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(on||(on={}));const an={debug:on.DEBUG,verbose:on.VERBOSE,info:on.INFO,warn:on.WARN,error:on.ERROR,silent:on.SILENT},cn=on.INFO,hn={[on.DEBUG]:"log",[on.VERBOSE]:"log",[on.INFO]:"info",[on.WARN]:"warn",[on.ERROR]:"error"},un=(e,t,...s)=>{if(t<e.logLevel)return;const r=(new Date).toISOString(),n=hn[t];if(!n)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[n](`[${r}]  ${e.name}:`,...s)},ln=(e,t)=>t.some((t=>e instanceof t));let dn,fn;const pn=new WeakMap,mn=new WeakMap,gn=new WeakMap,bn=new WeakMap,wn=new WeakMap;let _n={get(e,t,s){if(e instanceof IDBTransaction){if("done"===t)return mn.get(e);if("objectStoreNames"===t)return e.objectStoreNames||gn.get(e);if("store"===t)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return vn(e[t])},set:(e,t,s)=>(e[t]=s,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function yn(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(fn||(fn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(Sn(this),e),vn(pn.get(this))}:function(...e){return vn(t.apply(Sn(this),e))}:function(e,...s){const r=t.call(Sn(this),e,...s);return gn.set(r,e.sort?e.sort():[e]),vn(r)}:(e instanceof IDBTransaction&&function(e){if(mn.has(e))return;const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",i),e.removeEventListener("abort",i)},n=()=>{t(),r()},i=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",n),e.addEventListener("error",i),e.addEventListener("abort",i)}));mn.set(e,t)}(e),ln(e,dn||(dn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,_n):e);var t}function vn(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("success",n),e.removeEventListener("error",i)},n=()=>{t(vn(e.result)),r()},i=()=>{s(e.error),r()};e.addEventListener("success",n),e.addEventListener("error",i)}));return t.then((t=>{t instanceof IDBCursor&&pn.set(t,e)})).catch((()=>{})),wn.set(t,e),t}(e);if(bn.has(e))return bn.get(e);const t=yn(e);return t!==e&&(bn.set(e,t),wn.set(t,e)),t}const Sn=e=>wn.get(e),En=["get","getKey","getAll","getAllKeys","count"],kn=["put","add","delete","clear"],xn=new Map;function Cn(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(xn.get(t))return xn.get(t);const s=t.replace(/FromIndex$/,""),r=t!==s,n=kn.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!n&&!En.includes(s))return;const i=async function(e,...t){const i=this.transaction(e,n?"readwrite":"readonly");let o=i.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[s](...t),n&&i.done]))[0]};return xn.set(t,i),i}var Pn;Pn=_n,_n={...Pn,get:(e,t,s)=>Cn(e,t)||Pn.get(e,t,s),has:(e,t)=>!!Cn(e,t)||Pn.has(e,t)};class In{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map((e=>{if(function(e){const t=e.getComponent();return"VERSION"===(null==t?void 0:t.type)}(e)){const t=e.getImmediate();return`${t.library}/${t.version}`}return null})).filter((e=>e)).join(" ")}}const An="@firebase/app",On="0.10.4",jn=new class{constructor(e){this.name=e,this._logLevel=cn,this._logHandler=un,this._userLogHandler=null,nn.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in on))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?an[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,on.DEBUG,...e),this._logHandler(this,on.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,on.VERBOSE,...e),this._logHandler(this,on.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,on.INFO,...e),this._logHandler(this,on.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,on.WARN,...e),this._logHandler(this,on.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,on.ERROR,...e),this._logHandler(this,on.ERROR,...e)}}("@firebase/app"),Tn="@firebase/app-compat",Nn="@firebase/analytics-compat",Mn="@firebase/analytics",Ln="@firebase/app-check-compat",Rn="@firebase/app-check",Dn="@firebase/auth",Bn="@firebase/auth-compat",$n="@firebase/database",Un="@firebase/database-compat",Fn="@firebase/functions",qn="@firebase/functions-compat",Hn="@firebase/installations",Kn="@firebase/installations-compat",zn="@firebase/messaging",Gn="@firebase/messaging-compat",Jn="@firebase/performance",Vn="@firebase/performance-compat",Wn="@firebase/remote-config",Yn="@firebase/remote-config-compat",Qn="@firebase/storage",Xn="@firebase/storage-compat",Zn="@firebase/firestore",ei="@firebase/vertexai-preview",ti="@firebase/firestore-compat",si="firebase",ri="[DEFAULT]",ni={[An]:"fire-core",[Tn]:"fire-core-compat",[Mn]:"fire-analytics",[Nn]:"fire-analytics-compat",[Rn]:"fire-app-check",[Ln]:"fire-app-check-compat",[Dn]:"fire-auth",[Bn]:"fire-auth-compat",[$n]:"fire-rtdb",[Un]:"fire-rtdb-compat",[Fn]:"fire-fn",[qn]:"fire-fn-compat",[Hn]:"fire-iid",[Kn]:"fire-iid-compat",[zn]:"fire-fcm",[Gn]:"fire-fcm-compat",[Jn]:"fire-perf",[Vn]:"fire-perf-compat",[Wn]:"fire-rc",[Yn]:"fire-rc-compat",[Qn]:"fire-gcs",[Xn]:"fire-gcs-compat",[Zn]:"fire-fst",[ti]:"fire-fst-compat",[ei]:"fire-vertex","fire-js":"fire-js",[si]:"fire-js-all"},ii=new Map,oi=new Map,ai=new Map;function ci(e,t){try{e.container.addComponent(t)}catch(s){jn.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,s)}}function hi(e){const t=e.name;if(ai.has(t))return jn.debug(`There were multiple attempts to register component ${t}.`),!1;ai.set(t,e);for(const t of ii.values())ci(t,e);for(const t of oi.values())ci(t,e);return!0}function ui(e,t){const s=e.container.getProvider("heartbeat").getImmediate({optional:!0});return s&&s.triggerHeartbeat(),e.container.getProvider(t)}const li=new Wr("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."});class di{constructor(e,t,s){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new en("app",(()=>this),"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw li.create("app-deleted",{appName:this._name})}}function fi(e,t={}){let s=e;"object"!=typeof t&&(t={name:t});const r=Object.assign({name:ri,automaticDataCollectionEnabled:!1},t),n=r.name;if("string"!=typeof n||!n)throw li.create("bad-app-name",{appName:String(n)});if(s||(s=Kr()),!s)throw li.create("no-options");const i=ii.get(n);if(i){if(Qr(s,i.options)&&Qr(r,i.config))return i;throw li.create("duplicate-app",{appName:n})}const o=new rn(n);for(const e of ai.values())o.addComponent(e);const a=new di(s,r,o);return ii.set(n,a),a}function pi(e,t,s){var r;let n=null!==(r=ni[e])&&void 0!==r?r:e;s&&(n+=`-${s}`);const i=n.match(/\s|\//),o=t.match(/\s|\//);if(i||o){const e=[`Unable to register library "${n}" with version "${t}":`];return i&&e.push(`library name "${n}" contains illegal characters (whitespace or "/")`),i&&o&&e.push("and"),o&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),void jn.warn(e.join(" "))}hi(new en(`${n}-version`,(()=>({library:n,version:t})),"VERSION"))}const mi="firebase-heartbeat-database",gi=1,bi="firebase-heartbeat-store";let wi=null;function _i(){return wi||(wi=function(e,t,{blocked:s,upgrade:r,blocking:n,terminated:i}={}){const o=indexedDB.open(e,t),a=vn(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(vn(o.result),e.oldVersion,e.newVersion,vn(o.transaction),e)})),s&&o.addEventListener("blocked",(e=>s(e.oldVersion,e.newVersion,e))),a.then((e=>{i&&e.addEventListener("close",(()=>i())),n&&e.addEventListener("versionchange",(e=>n(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}(mi,gi,{upgrade:(e,t)=>{if(0===t)try{e.createObjectStore(bi)}catch(e){console.warn(e)}}}).catch((e=>{throw li.create("idb-open",{originalErrorMessage:e.message})}))),wi}async function yi(e,t){try{const s=(await _i()).transaction(bi,"readwrite"),r=s.objectStore(bi);await r.put(t,vi(e)),await s.done}catch(e){if(e instanceof Vr)jn.warn(e.message);else{const t=li.create("idb-set",{originalErrorMessage:null==e?void 0:e.message});jn.warn(t.message)}}}function vi(e){return`${e.name}!${e.options.appId}`}class Si{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new ki(t),this._heartbeatsCachePromise=this._storage.read().then((e=>(this._heartbeatsCache=e,e)))}async triggerHeartbeat(){var e,t;const s=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=Ei();if((null!=(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||(this._heartbeatsCache=await this._heartbeatsCachePromise,null!=(null===(t=this._heartbeatsCache)||void 0===t?void 0:t.heartbeats)))&&this._heartbeatsCache.lastSentHeartbeatDate!==r&&!this._heartbeatsCache.heartbeats.some((e=>e.date===r)))return this._heartbeatsCache.heartbeats.push({date:r,agent:s}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((e=>{const t=new Date(e.date).valueOf();return Date.now()-t<=2592e6})),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){var e;if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null==(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||0===this._heartbeatsCache.heartbeats.length)return"";const t=Ei(),{heartbeatsToSend:s,unsentEntries:r}=function(e,t=1024){const s=[];let r=e.slice();for(const n of e){const e=s.find((e=>e.agent===n.agent));if(e){if(e.dates.push(n.date),xi(s)>t){e.dates.pop();break}}else if(s.push({agent:n.agent,dates:[n.date]}),xi(s)>t){s.pop();break}r=r.slice(1)}return{heartbeatsToSend:s,unsentEntries:r}}(this._heartbeatsCache.heartbeats),n=qr(JSON.stringify({version:2,heartbeats:s}));return this._heartbeatsCache.lastSentHeartbeatDate=t,r.length>0?(this._heartbeatsCache.heartbeats=r,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),n}}function Ei(){return(new Date).toISOString().substring(0,10)}class ki{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!Gr()&&Jr().then((()=>!0)).catch((()=>!1))}async read(){if(await this._canUseIndexedDBPromise){const e=await async function(e){try{const t=(await _i()).transaction(bi),s=await t.objectStore(bi).get(vi(e));return await t.done,s}catch(e){if(e instanceof Vr)jn.warn(e.message);else{const t=li.create("idb-get",{originalErrorMessage:null==e?void 0:e.message});jn.warn(t.message)}}}(this.app);return(null==e?void 0:e.heartbeats)?e:{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const s=await this.read();return yi(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:s.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){const s=await this.read();return yi(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:s.lastSentHeartbeatDate,heartbeats:[...s.heartbeats,...e.heartbeats]})}}}function xi(e){return qr(JSON.stringify({version:2,heartbeats:e})).length}hi(new en("platform-logger",(e=>new In(e)),"PRIVATE")),hi(new en("heartbeat",(e=>new Si(e)),"PRIVATE")),pi(An,On,""),pi(An,On,"esm2017"),pi("fire-js",""),pi("firebase","10.12.1","app");const Ci=(e,t)=>t.some((t=>e instanceof t));let Pi,Ii;const Ai=new WeakMap,Oi=new WeakMap,ji=new WeakMap,Ti=new WeakMap,Ni=new WeakMap;let Mi={get(e,t,s){if(e instanceof IDBTransaction){if("done"===t)return Oi.get(e);if("objectStoreNames"===t)return e.objectStoreNames||ji.get(e);if("store"===t)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return Ri(e[t])},set:(e,t,s)=>(e[t]=s,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function Li(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Ii||(Ii=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(Di(this),e),Ri(Ai.get(this))}:function(...e){return Ri(t.apply(Di(this),e))}:function(e,...s){const r=t.call(Di(this),e,...s);return ji.set(r,e.sort?e.sort():[e]),Ri(r)}:(e instanceof IDBTransaction&&function(e){if(Oi.has(e))return;const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",i),e.removeEventListener("abort",i)},n=()=>{t(),r()},i=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",n),e.addEventListener("error",i),e.addEventListener("abort",i)}));Oi.set(e,t)}(e),Ci(e,Pi||(Pi=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,Mi):e);var t}function Ri(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("success",n),e.removeEventListener("error",i)},n=()=>{t(Ri(e.result)),r()},i=()=>{s(e.error),r()};e.addEventListener("success",n),e.addEventListener("error",i)}));return t.then((t=>{t instanceof IDBCursor&&Ai.set(t,e)})).catch((()=>{})),Ni.set(t,e),t}(e);if(Ti.has(e))return Ti.get(e);const t=Li(e);return t!==e&&(Ti.set(e,t),Ni.set(t,e)),t}const Di=e=>Ni.get(e),Bi=["get","getKey","getAll","getAllKeys","count"],$i=["put","add","delete","clear"],Ui=new Map;function Fi(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(Ui.get(t))return Ui.get(t);const s=t.replace(/FromIndex$/,""),r=t!==s,n=$i.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!n&&!Bi.includes(s))return;const i=async function(e,...t){const i=this.transaction(e,n?"readwrite":"readonly");let o=i.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[s](...t),n&&i.done]))[0]};return Ui.set(t,i),i}Mi=(e=>({...e,get:(t,s,r)=>Fi(t,s)||e.get(t,s,r),has:(t,s)=>!!Fi(t,s)||e.has(t,s)}))(Mi);const qi="@firebase/installations",Hi="0.6.7",Ki=1e4,zi=`w:${Hi}`,Gi="FIS_v2",Ji="https://firebaseinstallations.googleapis.com/v1",Vi=36e5,Wi=new Wr("installations","Installations",{"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"not-registered":"Firebase Installation is not registered.","installation-not-found":"Firebase Installation not found.","request-failed":'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',"app-offline":"Could not process request. Application offline.","delete-pending-registration":"Can't delete installation while there is a pending registration request."});function Yi(e){return e instanceof Vr&&e.code.includes("request-failed")}function Qi({projectId:e}){return`${Ji}/projects/${e}/installations`}function Xi(e){return{token:e.token,requestStatus:2,expiresIn:(t=e.expiresIn,Number(t.replace("s","000"))),creationTime:Date.now()};var t}async function Zi(e,t){const s=(await t.json()).error;return Wi.create("request-failed",{requestName:e,serverCode:s.code,serverMessage:s.message,serverStatus:s.status})}function eo({apiKey:e}){return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":e})}async function to(e){const t=await e();return t.status>=500&&t.status<600?e():t}function so(e){return new Promise((t=>{setTimeout(t,e)}))}const ro=/^[cdef][\w-]{21}$/,no="";function io(){try{const e=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(e),e[0]=112+e[0]%16;const t=function(e){var t;return(t=e,btoa(String.fromCharCode(...t)).replace(/\+/g,"-").replace(/\//g,"_")).substr(0,22)}(e);return ro.test(t)?t:no}catch(e){return no}}function oo(e){return`${e.appName}!${e.appId}`}const ao=new Map;function co(e,t){const s=oo(e);ho(s,t),function(e,t){const s=(!uo&&"BroadcastChannel"in self&&(uo=new BroadcastChannel("[Firebase] FID Change"),uo.onmessage=e=>{ho(e.data.key,e.data.fid)}),uo);s&&s.postMessage({key:e,fid:t}),0===ao.size&&uo&&(uo.close(),uo=null)}(s,t)}function ho(e,t){const s=ao.get(e);if(s)for(const e of s)e(t)}let uo=null;const lo="firebase-installations-database",fo=1,po="firebase-installations-store";let mo=null;function go(){return mo||(mo=function(e,t,{blocked:s,upgrade:r,blocking:n,terminated:i}={}){const o=indexedDB.open(e,t),a=Ri(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(Ri(o.result),e.oldVersion,e.newVersion,Ri(o.transaction),e)})),s&&o.addEventListener("blocked",(e=>s(e.oldVersion,e.newVersion,e))),a.then((e=>{i&&e.addEventListener("close",(()=>i())),n&&e.addEventListener("versionchange",(e=>n(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}(lo,fo,{upgrade:(e,t)=>{0===t&&e.createObjectStore(po)}})),mo}async function bo(e,t){const s=oo(e),r=(await go()).transaction(po,"readwrite"),n=r.objectStore(po),i=await n.get(s);return await n.put(t,s),await r.done,i&&i.fid===t.fid||co(e,t.fid),t}async function wo(e){const t=oo(e),s=(await go()).transaction(po,"readwrite");await s.objectStore(po).delete(t),await s.done}async function _o(e,t){const s=oo(e),r=(await go()).transaction(po,"readwrite"),n=r.objectStore(po),i=await n.get(s),o=t(i);return void 0===o?await n.delete(s):await n.put(o,s),await r.done,!o||i&&i.fid===o.fid||co(e,o.fid),o}async function yo(e){let t;const s=await _o(e.appConfig,(s=>{const r=function(e){return Eo(e||{fid:io(),registrationStatus:0})}(s),n=function(e,t){if(0===t.registrationStatus){if(!navigator.onLine)return{installationEntry:t,registrationPromise:Promise.reject(Wi.create("app-offline"))};const s={fid:t.fid,registrationStatus:1,registrationTime:Date.now()},r=async function(e,t){try{const s=await async function({appConfig:e,heartbeatServiceProvider:t},{fid:s}){const r=Qi(e),n=eo(e),i=t.getImmediate({optional:!0});if(i){const e=await i.getHeartbeatsHeader();e&&n.append("x-firebase-client",e)}const o={fid:s,authVersion:Gi,appId:e.appId,sdkVersion:zi},a={method:"POST",headers:n,body:JSON.stringify(o)},c=await to((()=>fetch(r,a)));if(c.ok){const e=await c.json();return{fid:e.fid||s,registrationStatus:2,refreshToken:e.refreshToken,authToken:Xi(e.authToken)}}throw await Zi("Create Installation",c)}(e,t);return bo(e.appConfig,s)}catch(s){throw Yi(s)&&409===s.customData.serverCode?await wo(e.appConfig):await bo(e.appConfig,{fid:t.fid,registrationStatus:0}),s}}(e,s);return{installationEntry:s,registrationPromise:r}}return 1===t.registrationStatus?{installationEntry:t,registrationPromise:vo(e)}:{installationEntry:t}}(e,r);return t=n.registrationPromise,n.installationEntry}));return s.fid===no?{installationEntry:await t}:{installationEntry:s,registrationPromise:t}}async function vo(e){let t=await So(e.appConfig);for(;1===t.registrationStatus;)await so(100),t=await So(e.appConfig);if(0===t.registrationStatus){const{installationEntry:t,registrationPromise:s}=await yo(e);return s||t}return t}function So(e){return _o(e,(e=>{if(!e)throw Wi.create("installation-not-found");return Eo(e)}))}function Eo(e){return 1===(t=e).registrationStatus&&t.registrationTime+Ki<Date.now()?{fid:e.fid,registrationStatus:0}:e;var t}async function ko({appConfig:e,heartbeatServiceProvider:t},s){const r=function(e,{fid:t}){return`${Qi(e)}/${t}/authTokens:generate`}(e,s),n=function(e,{refreshToken:t}){const s=eo(e);return s.append("Authorization",function(e){return`${Gi} ${e}`}(t)),s}(e,s),i=t.getImmediate({optional:!0});if(i){const e=await i.getHeartbeatsHeader();e&&n.append("x-firebase-client",e)}const o={installation:{sdkVersion:zi,appId:e.appId}},a={method:"POST",headers:n,body:JSON.stringify(o)},c=await to((()=>fetch(r,a)));if(c.ok)return Xi(await c.json());throw await Zi("Generate Auth Token",c)}async function xo(e,t=!1){let s;const r=await _o(e.appConfig,(r=>{if(!Po(r))throw Wi.create("not-registered");const n=r.authToken;if(!t&&(2===(i=n).requestStatus&&!function(e){const t=Date.now();return t<e.creationTime||e.creationTime+e.expiresIn<t+Vi}(i)))return r;var i;if(1===n.requestStatus)return s=async function(e,t){let s=await Co(e.appConfig);for(;1===s.authToken.requestStatus;)await so(100),s=await Co(e.appConfig);const r=s.authToken;return 0===r.requestStatus?xo(e,t):r}(e,t),r;{if(!navigator.onLine)throw Wi.create("app-offline");const t=function(e){const t={requestStatus:1,requestTime:Date.now()};return Object.assign(Object.assign({},e),{authToken:t})}(r);return s=async function(e,t){try{const s=await ko(e,t),r=Object.assign(Object.assign({},t),{authToken:s});return await bo(e.appConfig,r),s}catch(s){if(!Yi(s)||401!==s.customData.serverCode&&404!==s.customData.serverCode){const s=Object.assign(Object.assign({},t),{authToken:{requestStatus:0}});await bo(e.appConfig,s)}else await wo(e.appConfig);throw s}}(e,t),t}}));return s?await s:r.authToken}function Co(e){return _o(e,(e=>{if(!Po(e))throw Wi.create("not-registered");return 1===(t=e.authToken).requestStatus&&t.requestTime+Ki<Date.now()?Object.assign(Object.assign({},e),{authToken:{requestStatus:0}}):e;var t}))}function Po(e){return void 0!==e&&2===e.registrationStatus}function Io(e){return Wi.create("missing-app-config-values",{valueName:e})}const Ao="installations";hi(new en(Ao,(e=>{const t=e.getProvider("app").getImmediate(),s=function(e){if(!e||!e.options)throw Io("App Configuration");if(!e.name)throw Io("App Name");const t=["projectId","apiKey","appId"];for(const s of t)if(!e.options[s])throw Io(s);return{appName:e.name,projectId:e.options.projectId,apiKey:e.options.apiKey,appId:e.options.appId}}(t);return{app:t,appConfig:s,heartbeatServiceProvider:ui(t,"heartbeat"),_delete:()=>Promise.resolve()}}),"PUBLIC")),hi(new en("installations-internal",(e=>{const t=ui(e.getProvider("app").getImmediate(),Ao).getImmediate();return{getId:()=>async function(e){const t=e,{installationEntry:s,registrationPromise:r}=await yo(t);return r?r.catch(console.error):xo(t).catch(console.error),s.fid}(t),getToken:e=>async function(e,t=!1){const s=e;return await async function(e){const{registrationPromise:t}=await yo(e);t&&await t}(s),(await xo(s,t)).token}(t,e)}}),"PRIVATE")),pi(qi,Hi),pi(qi,Hi,"esm2017");const Oo=(e,t)=>t.some((t=>e instanceof t));let jo,To;const No=new WeakMap,Mo=new WeakMap,Lo=new WeakMap,Ro=new WeakMap,Do=new WeakMap;let Bo={get(e,t,s){if(e instanceof IDBTransaction){if("done"===t)return Mo.get(e);if("objectStoreNames"===t)return e.objectStoreNames||Lo.get(e);if("store"===t)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return Uo(e[t])},set:(e,t,s)=>(e[t]=s,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function $o(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(To||(To=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(Fo(this),e),Uo(No.get(this))}:function(...e){return Uo(t.apply(Fo(this),e))}:function(e,...s){const r=t.call(Fo(this),e,...s);return Lo.set(r,e.sort?e.sort():[e]),Uo(r)}:(e instanceof IDBTransaction&&function(e){if(Mo.has(e))return;const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",i),e.removeEventListener("abort",i)},n=()=>{t(),r()},i=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",n),e.addEventListener("error",i),e.addEventListener("abort",i)}));Mo.set(e,t)}(e),Oo(e,jo||(jo=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,Bo):e);var t}function Uo(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("success",n),e.removeEventListener("error",i)},n=()=>{t(Uo(e.result)),r()},i=()=>{s(e.error),r()};e.addEventListener("success",n),e.addEventListener("error",i)}));return t.then((t=>{t instanceof IDBCursor&&No.set(t,e)})).catch((()=>{})),Do.set(t,e),t}(e);if(Ro.has(e))return Ro.get(e);const t=$o(e);return t!==e&&(Ro.set(e,t),Do.set(t,e)),t}const Fo=e=>Do.get(e);function qo(e,t,{blocked:s,upgrade:r,blocking:n,terminated:i}={}){const o=indexedDB.open(e,t),a=Uo(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(Uo(o.result),e.oldVersion,e.newVersion,Uo(o.transaction),e)})),s&&o.addEventListener("blocked",(e=>s(e.oldVersion,e.newVersion,e))),a.then((e=>{i&&e.addEventListener("close",(()=>i())),n&&e.addEventListener("versionchange",(e=>n(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}function Ho(e,{blocked:t}={}){const s=indexedDB.deleteDatabase(e);return t&&s.addEventListener("blocked",(e=>t(e.oldVersion,e))),Uo(s).then((()=>{}))}const Ko=["get","getKey","getAll","getAllKeys","count"],zo=["put","add","delete","clear"],Go=new Map;function Jo(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(Go.get(t))return Go.get(t);const s=t.replace(/FromIndex$/,""),r=t!==s,n=zo.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!n&&!Ko.includes(s))return;const i=async function(e,...t){const i=this.transaction(e,n?"readwrite":"readonly");let o=i.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[s](...t),n&&i.done]))[0]};return Go.set(t,i),i}Bo=(e=>({...e,get:(t,s,r)=>Jo(t,s)||e.get(t,s,r),has:(t,s)=>!!Jo(t,s)||e.has(t,s)}))(Bo);const Vo="/firebase-messaging-sw.js",Wo="/firebase-cloud-messaging-push-scope",Yo="BDOU99-h67HcA6JeFXHbSNMu7e2yNNu3RzoMj8TM4W88jITfq7ZmPvIM1Iv-4_l2LxQcYwhqby2xGpWwzjfAnG4",Qo="https://fcmregistrations.googleapis.com/v1",Xo="google.c.a.c_id",Zo="google.c.a.c_l",ea="google.c.a.ts";var ta,sa;function ra(e){const t=new Uint8Array(e);return btoa(String.fromCharCode(...t)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function na(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),s=atob(t),r=new Uint8Array(s.length);for(let e=0;e<s.length;++e)r[e]=s.charCodeAt(e);return r}!function(e){e[e.DATA_MESSAGE=1]="DATA_MESSAGE",e[e.DISPLAY_NOTIFICATION=3]="DISPLAY_NOTIFICATION"}(ta||(ta={})),function(e){e.PUSH_RECEIVED="push-received",e.NOTIFICATION_CLICKED="notification-clicked"}(sa||(sa={}));const ia="fcm_token_details_db",oa=5,aa="fcm_token_object_Store",ca="firebase-messaging-database",ha=1,ua="firebase-messaging-store";let la=null;function da(){return la||(la=qo(ca,ha,{upgrade:(e,t)=>{0===t&&e.createObjectStore(ua)}})),la}async function fa(e,t){const s=pa(e),r=(await da()).transaction(ua,"readwrite");return await r.objectStore(ua).put(t,s),await r.done,t}function pa({appConfig:e}){return e.appId}const ma=new Wr("messaging","Messaging",{"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"only-available-in-window":"This method is available in a Window context.","only-available-in-sw":"This method is available in a service worker context.","permission-default":"The notification permission was not granted and dismissed instead.","permission-blocked":"The notification permission was not granted and blocked instead.","unsupported-browser":"This browser doesn't support the API's required to use the Firebase SDK.","indexed-db-unsupported":"This browser doesn't support indexedDb.open() (ex. Safari iFrame, Firefox Private Browsing, etc)","failed-service-worker-registration":"We are unable to register the default service worker. {$browserErrorMessage}","token-subscribe-failed":"A problem occurred while subscribing the user to FCM: {$errorInfo}","token-subscribe-no-token":"FCM returned no token when subscribing the user to push.","token-unsubscribe-failed":"A problem occurred while unsubscribing the user from FCM: {$errorInfo}","token-update-failed":"A problem occurred while updating the user from FCM: {$errorInfo}","token-update-no-token":"FCM returned no token when updating the user to push.","use-sw-after-get-token":"The useServiceWorker() method may only be called once and must be called before calling getToken() to ensure your service worker is used.","invalid-sw-registration":"The input to useServiceWorker() must be a ServiceWorkerRegistration.","invalid-bg-handler":"The input to setBackgroundMessageHandler() must be a function.","invalid-vapid-key":"The public VAPID key must be a string.","use-vapid-key-after-get-token":"The usePublicVapidKey() method may only be called once and must be called before calling getToken() to ensure your VAPID key is used."});function ga({projectId:e}){return`${Qo}/projects/${e}/registrations`}async function ba({appConfig:e,installations:t}){const s=await t.getToken();return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":e.apiKey,"x-goog-firebase-installations-auth":`FIS ${s}`})}function wa({p256dh:e,auth:t,endpoint:s,vapidKey:r}){const n={web:{endpoint:s,auth:t,p256dh:e}};return r!==Yo&&(n.web.applicationPubKey=r),n}const _a=6048e5;async function ya(e){const t=await async function(e,t){const s=await e.pushManager.getSubscription();return s||e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:na(t)})}(e.swRegistration,e.vapidKey),s={vapidKey:e.vapidKey,swScope:e.swRegistration.scope,endpoint:t.endpoint,auth:ra(t.getKey("auth")),p256dh:ra(t.getKey("p256dh"))},r=await async function(e){const t=pa(e),s=await da(),r=await s.transaction(ua).objectStore(ua).get(t);if(r)return r;{const t=await async function(e){if("databases"in indexedDB){const e=(await indexedDB.databases()).map((e=>e.name));if(!e.includes(ia))return null}let t=null;return(await qo(ia,oa,{upgrade:async(s,r,n,i)=>{var o;if(r<2)return;if(!s.objectStoreNames.contains(aa))return;const a=i.objectStore(aa),c=await a.index("fcmSenderId").get(e);if(await a.clear(),c)if(2===r){const e=c;if(!e.auth||!e.p256dh||!e.endpoint)return;t={token:e.fcmToken,createTime:null!==(o=e.createTime)&&void 0!==o?o:Date.now(),subscriptionOptions:{auth:e.auth,p256dh:e.p256dh,endpoint:e.endpoint,swScope:e.swScope,vapidKey:"string"==typeof e.vapidKey?e.vapidKey:ra(e.vapidKey)}}}else if(3===r){const e=c;t={token:e.fcmToken,createTime:e.createTime,subscriptionOptions:{auth:ra(e.auth),p256dh:ra(e.p256dh),endpoint:e.endpoint,swScope:e.swScope,vapidKey:ra(e.vapidKey)}}}else if(4===r){const e=c;t={token:e.fcmToken,createTime:e.createTime,subscriptionOptions:{auth:ra(e.auth),p256dh:ra(e.p256dh),endpoint:e.endpoint,swScope:e.swScope,vapidKey:ra(e.vapidKey)}}}}})).close(),await Ho(ia),await Ho("fcm_vapid_details_db"),await Ho("undefined"),function(e){if(!e||!e.subscriptionOptions)return!1;const{subscriptionOptions:t}=e;return"number"==typeof e.createTime&&e.createTime>0&&"string"==typeof e.token&&e.token.length>0&&"string"==typeof t.auth&&t.auth.length>0&&"string"==typeof t.p256dh&&t.p256dh.length>0&&"string"==typeof t.endpoint&&t.endpoint.length>0&&"string"==typeof t.swScope&&t.swScope.length>0&&"string"==typeof t.vapidKey&&t.vapidKey.length>0}(t)?t:null}(e.appConfig.senderId);if(t)return await fa(e,t),t}}(e.firebaseDependencies);if(r){if(function(e,t){const s=t.vapidKey===e.vapidKey,r=t.endpoint===e.endpoint,n=t.auth===e.auth,i=t.p256dh===e.p256dh;return s&&r&&n&&i}(r.subscriptionOptions,s))return Date.now()>=r.createTime+_a?async function(e,t){try{const s=await async function(e,t){const s=await ba(e),r=wa(t.subscriptionOptions),n={method:"PATCH",headers:s,body:JSON.stringify(r)};let i;try{const s=await fetch(`${ga(e.appConfig)}/${t.token}`,n);i=await s.json()}catch(e){throw ma.create("token-update-failed",{errorInfo:null==e?void 0:e.toString()})}if(i.error){const e=i.error.message;throw ma.create("token-update-failed",{errorInfo:e})}if(!i.token)throw ma.create("token-update-no-token");return i.token}(e.firebaseDependencies,t),r=Object.assign(Object.assign({},t),{token:s,createTime:Date.now()});return await fa(e.firebaseDependencies,r),s}catch(e){throw e}}(e,{token:r.token,createTime:Date.now(),subscriptionOptions:s}):r.token;try{await async function(e,t){const s={method:"DELETE",headers:await ba(e)};try{const r=await fetch(`${ga(e.appConfig)}/${t}`,s),n=await r.json();if(n.error){const e=n.error.message;throw ma.create("token-unsubscribe-failed",{errorInfo:e})}}catch(e){throw ma.create("token-unsubscribe-failed",{errorInfo:null==e?void 0:e.toString()})}}(e.firebaseDependencies,r.token)}catch(e){console.warn(e)}return va(e.firebaseDependencies,s)}return va(e.firebaseDependencies,s)}async function va(e,t){const s=await async function(e,t){const s=await ba(e),r=wa(t),n={method:"POST",headers:s,body:JSON.stringify(r)};let i;try{const t=await fetch(ga(e.appConfig),n);i=await t.json()}catch(e){throw ma.create("token-subscribe-failed",{errorInfo:null==e?void 0:e.toString()})}if(i.error){const e=i.error.message;throw ma.create("token-subscribe-failed",{errorInfo:e})}if(!i.token)throw ma.create("token-subscribe-no-token");return i.token}(e,t),r={token:s,createTime:Date.now(),subscriptionOptions:t};return await fa(e,r),r.token}function Sa(e){const t={from:e.from,collapseKey:e.collapse_key,messageId:e.fcmMessageId};return function(e,t){if(!t.notification)return;e.notification={};const s=t.notification.title;s&&(e.notification.title=s);const r=t.notification.body;r&&(e.notification.body=r);const n=t.notification.image;n&&(e.notification.image=n);const i=t.notification.icon;i&&(e.notification.icon=i)}(t,e),function(e,t){t.data&&(e.data=t.data)}(t,e),function(e,t){var s,r,n,i,o;if(!t.fcmOptions&&!(null===(s=t.notification)||void 0===s?void 0:s.click_action))return;e.fcmOptions={};const a=null!==(n=null===(r=t.fcmOptions)||void 0===r?void 0:r.link)&&void 0!==n?n:null===(i=t.notification)||void 0===i?void 0:i.click_action;a&&(e.fcmOptions.link=a);const c=null===(o=t.fcmOptions)||void 0===o?void 0:o.analytics_label;c&&(e.fcmOptions.analyticsLabel=c)}(t,e),t}function Ea(e,t){const s=[];for(let r=0;r<e.length;r++)s.push(e.charAt(r)),r<t.length&&s.push(t.charAt(r));return s.join("")}function ka(e){return ma.create("missing-app-config-values",{valueName:e})}Ea("hts/frbslgigp.ogepscmv/ieo/eaylg","tp:/ieaeogn-agolai.o/1frlglgc/o"),Ea("AzSCbw63g1R0nCw85jG8","Iaya3yLKwmgvh7cF0q4");class xa{constructor(e,t,s){this.deliveryMetricsExportedToBigQueryEnabled=!1,this.onBackgroundMessageHandler=null,this.onMessageHandler=null,this.logEvents=[],this.isLogServiceStarted=!1;const r=function(e){if(!e||!e.options)throw ka("App Configuration Object");if(!e.name)throw ka("App Name");const t=["projectId","apiKey","appId","messagingSenderId"],{options:s}=e;for(const e of t)if(!s[e])throw ka(e);return{appName:e.name,projectId:s.projectId,apiKey:s.apiKey,appId:s.appId,senderId:s.messagingSenderId}}(e);this.firebaseDependencies={app:e,appConfig:r,installations:t,analyticsProvider:s}}_delete(){return Promise.resolve()}}async function Ca(e,t){if(!navigator)throw ma.create("only-available-in-window");if("default"===Notification.permission&&await Notification.requestPermission(),"granted"!==Notification.permission)throw ma.create("permission-blocked");return await async function(e,t){t?e.vapidKey=t:e.vapidKey||(e.vapidKey=Yo)}(e,null==t?void 0:t.vapidKey),await async function(e,t){if(t||e.swRegistration||await async function(e){try{e.swRegistration=await navigator.serviceWorker.register(Vo,{scope:Wo}),e.swRegistration.update().catch((()=>{}))}catch(e){throw ma.create("failed-service-worker-registration",{browserErrorMessage:null==e?void 0:e.message})}}(e),t||!e.swRegistration){if(!(t instanceof ServiceWorkerRegistration))throw ma.create("invalid-sw-registration");e.swRegistration=t}}(e,null==t?void 0:t.serviceWorkerRegistration),ya(e)}async function Pa(e,t){const s=t.data;if(!s.isFirebaseMessaging)return;e.onMessageHandler&&s.messageType===sa.PUSH_RECEIVED&&("function"==typeof e.onMessageHandler?e.onMessageHandler(Sa(s)):e.onMessageHandler.next(Sa(s)));const r=s.data;var n;"object"==typeof(n=r)&&n&&Xo in n&&"1"===r["google.c.a.e"]&&await async function(e,t,s){const r=function(e){switch(e){case sa.NOTIFICATION_CLICKED:return"notification_open";case sa.PUSH_RECEIVED:return"notification_foreground";default:throw new Error}}(t);(await e.firebaseDependencies.analyticsProvider.get()).logEvent(r,{message_id:s[Xo],message_name:s[Zo],message_time:s[ea],message_device_time:Math.floor(Date.now()/1e3)})}(e,s.messageType,r)}const Ia="@firebase/messaging",Aa="0.12.9";async function Oa(){try{await Jr()}catch(e){return!1}return"undefined"!=typeof window&&Gr()&&!("undefined"==typeof navigator||!navigator.cookieEnabled)&&"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window&&"fetch"in window&&ServiceWorkerRegistration.prototype.hasOwnProperty("showNotification")&&PushSubscription.prototype.hasOwnProperty("getKey")}hi(new en("messaging",(e=>{const t=new xa(e.getProvider("app").getImmediate(),e.getProvider("installations-internal").getImmediate(),e.getProvider("analytics-internal"));return navigator.serviceWorker.addEventListener("message",(e=>Pa(t,e))),t}),"PUBLIC")),hi(new en("messaging-internal",(e=>{const t=e.getProvider("messaging").getImmediate();return{getToken:e=>Ca(t,e)}}),"PRIVATE")),pi(Ia,Aa),pi(Ia,Aa,"esm2017");var ja=r(396),Ta=!("undefined"==typeof window||!(null===window||void 0===window?void 0:window.__RUN_BY_ELECTRON__));function Na(e){try{return decodeURIComponent(e)}catch(t){return e}}r(47);const Ma=()=>function(e,t){if(-1===[void 0,null,""].indexOf(e)){if(Ta){if("BNC-Location"===e)return window.__store.getState().temp.bncLocation;var s=window.localStorage.getItem("APP_COOKIES_".concat(e));return s?Na(s):null}for(var r="".concat(e,"=").trim(),n=(("undefined"!=typeof window?document:t||{}).cookie||"").split(";"),i=0;i<n.length;i++){var o=(n[i]||"").trim();if(0===o.indexOf(r)){var a=o.slice(r.length).trim();return Na('"'===a[0]?a.slice(1,-1):a)}}}return null}("bnc-uuid")||"",La=(e,t,s,r)=>(console.log("token report",s,r),(0,ja.post)("/bapi/fe/message/immed/web/device/report",{pushEnable:t,pushToken:e})),Ra=()=>{const{host:e}=location;return/qa1fdg/.test(e)?"qa":/devfdg/.test(e)?"dev":"prod"},Da={prod:"cc1ljun9gpbp8ciciolg",dev:"cbr2ds5m1ugn50gs3710",qa:"cbr2ds5m1ugn50gs3710"},Ba={prod:"com.binance.web",dev:"com.binance.dev.web",qa:"com.binance.qa.web"},$a={received:1,clicked:2},Ua={prod:"https://api.saasexch.com",dev:"https://www.devfdg.net",qa:"https://www.qa1fdg.net"},Fa=(e,t,s)=>{var r;(0,ja.post)(`${Ua[Ra()]}/bapi/fe/pda/v1/submit/web/batch?project=${Da[Ra()]}`,{deviceId:Ma(),appver:"1.0",sdkver:"1.0",platformType:3,bundle:Ba[Ra()],events:[{id:(r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),"".concat(r.slice(0,-1),"b")),type:"push",ts:Date.now(),data:JSON.stringify({messageId:e,action:$a[t],traceId:s,extra:{source:"nats"}})}]}).catch((e=>{console.error("feedbackPushCenter error:",e)}))},qa={apiKey:"AIzaSyDfnzUFE04CanrhpUDUzIUk8_-kmZ3OUQQ",authDomain:"binance-f2287.firebaseapp.com",databaseURL:"https://binance-f2287.firebaseio.com",projectId:"binance-f2287",storageBucket:"binance-f2287.appspot.com",messagingSenderId:"826035250503",appId:"1:826035250503:web:5e9b2308205e0702fd1862",measurementId:"G-FFESRZY0VL"},Ha={prod:qa,dev:qa,qa};let Ka;!function(e){e.REGISTER_SW_FAILED="register-sw-failed",e.GET_PUSH_TOKEN_FAILED="get-push-token-failed",e.GET_PUSH_TOKEN_UNAVAILABLE="get-push-token-unavailable",e.UPLOAD_PUSH_TOKEN_FAILED="upload-push-token-failed",e.BROWSER_NOT_SUPPORTED="browser-not-supported",e.GET_FIREBASE_INFO_FAILED="get-firebase-info-failed",e.GET_FIREBASE_INFO_INVALID="get-firebase-info-invalid",e.SET_FIREBASE_INFO_FAILED="set-firebase-info-failed",e.REMOVE_FIREBASE_INFO_FAILED="remove-firebase-info-failed",e.PERMISSION_DEFAULT="permission-default",e.PERMISSION_BLOCKED="permission-blocked",e.NOT_LOGGED_IN="not-logged-in"}(Ka||(Ka={}));const za={[Ka.REGISTER_SW_FAILED]:"Failed to register a ServiceWorker",[Ka.GET_PUSH_TOKEN_FAILED]:"Failed to get pushToken",[Ka.GET_PUSH_TOKEN_UNAVAILABLE]:"Failed to get an available pushToken. Request permission to generate one.",[Ka.UPLOAD_PUSH_TOKEN_FAILED]:"Failed to report pushToken to the backend. Please retry",[Ka.BROWSER_NOT_SUPPORTED]:"Browser not supported",[Ka.GET_FIREBASE_INFO_FAILED]:"Failed to get firebaseInfo from indexDB",[Ka.GET_FIREBASE_INFO_INVALID]:"Got invalid firebaseInfo",[Ka.SET_FIREBASE_INFO_FAILED]:"Failed to set firebaseInfo to indexDB",[Ka.REMOVE_FIREBASE_INFO_FAILED]:"Failed to remove firebaseInfo from indexDB",[Ka.PERMISSION_DEFAULT]:"The notification permission was not granted and dismissed instead. Please retry",[Ka.PERMISSION_BLOCKED]:"The notification permission was not granted and blocked instead.",[Ka.NOT_LOGGED_IN]:"Not logged in. Please login to complete the subscription"};class Ga extends Error{constructor(e,t,s){super(e),this.code=t,this.cause=s}}const Ja=(e,t)=>{const s=(null==t?void 0:t.message)||za[e];return new Ga(s,e,t)},Va=(e,t)=>t.some((t=>e instanceof t));let Wa,Ya;const Qa=new WeakMap,Xa=new WeakMap,Za=new WeakMap,ec=new WeakMap,tc=new WeakMap;let sc={get(e,t,s){if(e instanceof IDBTransaction){if("done"===t)return Xa.get(e);if("objectStoreNames"===t)return e.objectStoreNames||Za.get(e);if("store"===t)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return nc(e[t])},set:(e,t,s)=>(e[t]=s,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function rc(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Ya||(Ya=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(ic(this),e),nc(Qa.get(this))}:function(...e){return nc(t.apply(ic(this),e))}:function(e,...s){const r=t.call(ic(this),e,...s);return Za.set(r,e.sort?e.sort():[e]),nc(r)}:(e instanceof IDBTransaction&&function(e){if(Xa.has(e))return;const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",i),e.removeEventListener("abort",i)},n=()=>{t(),r()},i=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",n),e.addEventListener("error",i),e.addEventListener("abort",i)}));Xa.set(e,t)}(e),Va(e,Wa||(Wa=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,sc):e);var t}function nc(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("success",n),e.removeEventListener("error",i)},n=()=>{t(nc(e.result)),r()},i=()=>{s(e.error),r()};e.addEventListener("success",n),e.addEventListener("error",i)}));return t.then((t=>{t instanceof IDBCursor&&Qa.set(t,e)})).catch((()=>{})),tc.set(t,e),t}(e);if(ec.has(e))return ec.get(e);const t=rc(e);return t!==e&&(ec.set(e,t),tc.set(t,e)),t}const ic=e=>tc.get(e),oc=["get","getKey","getAll","getAllKeys","count"],ac=["put","add","delete","clear"],cc=new Map;function hc(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(cc.get(t))return cc.get(t);const s=t.replace(/FromIndex$/,""),r=t!==s,n=ac.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!n&&!oc.includes(s))return;const i=async function(e,...t){const i=this.transaction(e,n?"readwrite":"readonly");let o=i.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[s](...t),n&&i.done]))[0]};return cc.set(t,i),i}sc=(e=>({...e,get:(t,s,r)=>hc(t,s)||e.get(t,s,r),has:(t,s)=>!!hc(t,s)||e.has(t,s)}))(sc);const uc="odin-firebase-info-store",lc="current";let dc=null;const fc=()=>(dc||(dc=function(e,t,{blocked:s,upgrade:r,blocking:n,terminated:i}={}){const o=indexedDB.open(e,t),a=nc(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(nc(o.result),e.oldVersion,e.newVersion,nc(o.transaction))})),s&&o.addEventListener("blocked",(()=>s())),a.then((e=>{i&&e.addEventListener("close",(()=>i())),n&&e.addEventListener("versionchange",(()=>n()))})).catch((()=>{})),a}("odin-firebase-info-database",1,{upgrade:(e,t)=>{0===t&&e.createObjectStore(uc)}})),dc),pc=async()=>(await fc()).transaction(uc).objectStore(uc).get(lc),mc=async e=>{const t=(await fc()).transaction(uc,"readwrite");return await t.objectStore(uc).put(e,lc),await t.done,e},gc=async()=>{try{if(!await Oa())throw La("",2),Ja(Ka.BROWSER_NOT_SUPPORTED)}catch(e){throw Ja(Ka.BROWSER_NOT_SUPPORTED,e)}const e=function(e=function(e=ri){const t=ii.get(e);if(!t&&e===ri&&Kr())return fi();if(!t)throw li.create("no-app",{appName:e});return t}()){return Oa().then((e=>{if(!e)throw ma.create("unsupported-browser")}),(e=>{throw ma.create("indexed-db-unsupported")})),ui(Zr(e),"messaging").getImmediate()}(fi(Ha[(()=>{const{host:e}=location;return/localhost/.test(e)?"dev":/qa1fdg/.test(e)?"qa":/devfdg/.test(e)?"dev":"prod"})()]));let t;try{t=await navigator.serviceWorker.register("/pwa-odin-firebase-messaging-sw.js",{scope:"/"})}catch(e){throw La("",2),Ja(Ka.REGISTER_SW_FAILED,e)}if("default"===Notification.permission&&await Notification.requestPermission(),"default"===Notification.permission)throw La("",2),Ja(Ka.PERMISSION_DEFAULT);if("granted"!==Notification.permission)throw La("",2),Ja(Ka.PERMISSION_BLOCKED);try{const s=await async function(e,t){return Ca(e=Zr(e),t)}(e,{vapidKey:"BEwOHYH6wR7alWGN31vK4wTq8cThIXLnA51-F0rxgCRgj5dHHhjn7Hp5tPzXqxCMstq7wyJ1iTYH-PumXDD3liQ",serviceWorkerRegistration:t});if(s){const e=Ma(),t=await pc();let r=!1,n=!1;if(t){if(t.pushToken!==s||t.deviceId!==e){const t={pushToken:s,deviceId:e};try{await mc(t)}catch(e){throw Ja(Ka.SET_FIREBASE_INFO_FAILED,e)}r=!0}}else try{await mc({pushToken:s,deviceId:e}),n=!0}catch(e){throw Ja(Ka.SET_FIREBASE_INFO_FAILED,e)}if(await pc()){if(!r&&!n)return!0;try{const t=r?"change_regid":n?"open_app":null;if((await La(s,1,e,t)).success)return await mc({pushToken:s,deviceId:e}),!0;throw Ja(Ka.UPLOAD_PUSH_TOKEN_FAILED)}catch(e){throw Ja(Ka.UPLOAD_PUSH_TOKEN_FAILED,e)}}throw Ja(Ka.GET_FIREBASE_INFO_FAILED)}throw Ja(Ka.GET_PUSH_TOKEN_UNAVAILABLE)}catch(e){throw console.error("get token currentToken e",e),Ja(Ka.GET_PUSH_TOKEN_FAILED,e)}},bc=()=>"Notification"in self&&"denied"!==Notification.permission;class wc{constructor(e,t,s){this.sdk=e,this.topics=t,this.option=s}receiveMessage(e,t){var s;const r=null===(s=this.topics)||void 0===s?void 0:s.find((e=>t.includes(e)));return!!r&&(this.option.onMessage(e,r),this.option.enablePush)}receiveEvent(e,t){this.option[e]&&this.option[e](t)}}class _c{static instance=null;subscribers=[];nc=null;notificationPermission=!1;constructor(e){this.option=e,this.subscribeHandler=this.subscribeHandler.bind(this)}static getInstanceAndInit(e){return _c.instance?console.log("WebPushOdinSDK instance already exist",_c.instance):(_c.instance=new _c(e),_c.instance.init()),_c.instance}init(){this.broadcastChannel=new j(this.option.channelName||"web-push-odin"),function(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=function(e,t){return e||(e={}),(e=JSON.parse(JSON.stringify(e))).fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}(t,e);var s="undefined"!=typeof navigator&&void 0!==navigator.locks&&"function"==typeof navigator.locks.request?new q(e,t):new H(e,t);return e._befC.push((function(){return s.die()})),e._leaderElector=s,s}(this.broadcastChannel).awaitLeadership().then((()=>{this.transferEventToSubscriber("onBeLeader"),this.doConnection(),this.subscribePush()})).catch((e=>console.error("Leader Election error:",e))),this.broadcastChannel.onmessage=e=>{const{msg:t,topic:s,didPush:r}=e,n=this.distributeMessage(t,s);!r&&n&&this.handleNatsPushMessage(t)}}transferEventToSubscriber(e,t){this.subscribers.forEach((s=>{s.receiveEvent(e,t)}))}async subscribeHandler(){gc().then((e=>{e&&(this.notificationPermission=!0,console.log("fibase push subscribe success"),this.transferEventToSubscriber("onPushConnectSuccess"))})).catch((e=>{e.code===Ka.PERMISSION_DEFAULT&&console.warn("user closed the notification permission requesting popup"),console.error("firebase push subscribe failed",e),this.transferEventToSubscriber("onPushConnectFail",e)}))}async subscribePush(){await(async()=>bc()&&(async()=>{try{if(!await Oa())return!1}catch{return!1}try{if(await pc())return!0}catch{}return!1})())()?setTimeout(this.subscribeHandler,2e3):bc()?this.subscribeHandler():this.transferEventToSubscriber("onPushConnectFail",new Error("PERMISSION_BLOCKED_BEFORE"))}async doConnection(){if(this.nc&&!this.nc.isClosed())return void console.log("Already connected");const e=await this.option.getConnectOptions();await this.connNats(e)}async connNats(e){try{this.nc=await function(e={}){return Ot={defaultPort:443,urlParseFn:Br,factory:()=>new Dr},Cr.connect(e)}({ignoreClusterUpdates:e.ignoreClusterUpdates,servers:e.servers,authenticator:Es((new TextEncoder).encode(e.authenticator))}),this.transferEventToSubscriber("onConnectSuccess"),this.subscribeToTopics(e.topics),this.nc.closed().then((t=>{t&&(this.transferEventToSubscriber("onDisConnect",t.message),console.error(`Service ${e.servers} exited because of error: ${t.message}`)),this.doConnection()}));for await(const e of this.nc.status())console.info(`${e.type}: ${e.data}`),this.transferEventToSubscriber("onNatsStatusChange",e),e.type===Q.Error&&e.data===Z.AuthorizationViolation&&(this.nc.close(),console.error("AuthorizationViolation"))}catch(e){console.log(`Connection failed: ${e}`),this.transferEventToSubscriber("onConnectFail",e)}}addSubscriber(e,t){const s=new wc(this,e,t);return this.subscribers.push(s),s}destroySubscriber(e){const t=this.subscribers.indexOf(e);t>-1&&this.subscribers.splice(t,1)}subscribeToTopics(e){const t=Ce();e.forEach(((e,s)=>{console.log(`Subscribe[${s}]: ${e}`);const r=this.nc.subscribe(e);(async()=>{for await(const e of r){const s=t.decode(e.data);console.log(`Sub receive [${e.subject}]: ${s}`),this.handleActiveTabMessage(s,e.subject)}console.log("Subscription closed")})()}))}distributeMessage(e,t){let s=!1;return this.subscribers.forEach((r=>{r.receiveMessage(e,t)&&(s=!0)})),s}handleNatsPushMessage(e){this.notificationPermission?this.sendNotification(e):this.transferEventToSubscriber("onPushConnectFail",{code:"natsToNotificationFail",message:"nats to notification error failed because Permission is false"})}handleActiveTabMessage(e,t){const s=this.distributeMessage(e,t);s&&this.handleNatsPushMessage(e),this.broadcastChannel.postMessage({msg:e,topic:t,didPush:s})}sendNotification(e){try{const{payload:s,extra:r,messageId:n,traceId:i}=JSON.parse(e),o=s.title.content,a={body:s.body.content,icon:"https://public.bnbstatic.com/images/common/ic-binance-black-bg.png",data:{url:r.internalPage}},c=new Notification(o,a);Fa(n,"received",i),c.onclick=e=>{e.preventDefault();try{var s,r;let n=(null===(s=e.target)||void 0===s||null===(r=s.data)||void 0===r?void 0:r.url)||"/";const i=new URLSearchParams({utm_source:"ncpush",utm_medium:"web"});n.includes("?")?n+=`&${i.toString()}`:n+=`?${i.toString()}`,window.open(n.replace("{{subdomain}}",function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=(t?window.location:s).hostname,n=void 0===r?"":r,i=n.split(".");return i.length>2?i.slice(-e).join("."):n}()),"_blank")}catch(e){this.transferEventToSubscriber("onError",{bizScene:"nats-notification-click",message:e.message})}Fa(n,"clicked",i)}}catch(e){console.error("error in sendNotification",e)}}async disconnect(){this.broadcastChannel&&await this.broadcastChannel.close(),this.nc&&await this.nc.close(),_c.instance=null}}function yc(e){if("undefined"==typeof window)return null;try{return _c.getInstanceAndInit({getConnectOptions:e.getConnectOptions,channelName:e.channelName}).addSubscriber(e.topics,e)}catch(t){console.error("error in WebPushOdinSDK initWebPushOdin",t),e.onError&&e.onError(t)}return null}})(),n})()));